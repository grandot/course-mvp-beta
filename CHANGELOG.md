# Changelog

All notable changes to this project will be documented in this file.

## [v10.1.3] - 2025-07-29

### Fixed
- **週課表查詢終極修復**: 徹底解決用戶輸入「這週課表」「下週課表」仍返回4週課程的核心問題。
  - **原始文本保留**: 將用戶原始輸入 `originalUserInput` 傳遞給 TaskService，避免語義分析丟失時間信息
  - **優先級檢測邏輯**: `_calculateDateRange` 按優先級檢查：`originalUserInput` > `course_name` > `raw_text` > `timeInfo.raw`
  - **根因問題解決**: OpenAI 將「下週課表」分解為 course_name="課表" + timeInfo=null，導致時間信息丟失
  - **精確週範圍計算**: 基於原始輸入直接檢測「這週」「下週」「下下週」關鍵詞
  - **詳細調試追蹤**: 新增完整的文本源檢測和範圍計算日誌，便於問題排查

---

## [v10.1.2] - 2025-07-29

### Fixed  
- **生產環境關鍵錯誤修復**: 修復 TaskService 中缺失的 `_calculateDateRange` 方法導致的運行時錯誤。
  - **方法實現完成**: 新增完整的 `_calculateDateRange` 方法實現，支持精確的週範圍計算
  - **智能時間範圍檢測**: 根據用戶輸入自動識別「這週」、「下週」、「下下週」等時間範圍意圖
  - **統一時間處理**: 使用 TimeService 的標準方法確保時間計算的一致性和準確性
  - **生產部署驗證**: 解決 "'_calculateDateRange' is not a function" 和模組載入錯誤
  - **調試工具增強**: 新增 Render 日誌監控腳本，便於快速定位和解決生產問題

### Added
- **調試工具集**: 新增完整的 Render 平台調試工具鏈
  - `scripts/get-app-logs.sh`: 應用程序日誌快速獲取腳本
  - `scripts/render-events.sh`: 服務事件查詢工具
  - `scripts/test-render-log-endpoints.js`: API 端點測試工具

---

## [v10.1.1] - 2025-07-29

### Fixed
- **週課表查詢精準修復**: 修復「下下週課表」、「下週課表」、「這週課表」返回多週而非指定週的問題。
  - **TaskService 邏輯修復**: 恢復 `_calculateDateRange` 方法調用，確保傳遞正確日期範圍
  - **TimeService 增強**: 新增 `getStartOfWeek` 和 `getEndOfWeek` 方法，正確計算週的開始/結束日期
  - **範圍控制優化**: 用戶查詢特定週時只返回該週課程，避免顯示4週內容
  - 解決課表查詢返回過多無關課程的用戶體驗問題

---

## [v10.1.0] - 2025-07-29

### Added
- **Render 日誌獲取工具**: 新增本地命令行工具，無需登入 Dashboard 即可查看服務事件。
  - 支援事件過濾：可按關鍵詞過濾部署、建置狀態
  - 靈活數量控制：可指定獲取的事件數量
  - 友好格式化：自動格式化時間戳和事件類型
  - 命令：`npm run logs [--limit N] [--filter keyword]`

---

## [v10.0.5] - 2025-07-29

### Fixed  
- **重複課程創建根本修復**: 解決重複課程無法正確創建的核心問題。
  - **語義分析修復**: 保留完整重複模式信息（「每週二」而非簡化為「每週」）
  - **數據結構修復**: 添加必要的布林欄位和 `recurrence_details`
  - **模式解析增強**: 正確提取星期幾、時間、月日信息
  - 修復「每週二下午兩點西班牙語課」無法創建的問題

---

## [v10.0.4] - 2025-07-29

### Fixed
- **重複課程回覆修復**: 添加缺失的重複課程意圖處理，解決「正在處理中」fallback 問題。
  - 添加 `create_recurring_course` case：正確顯示重複課程創建成功訊息
  - 添加 `modify_recurring_course` case：處理重複課程修改回覆
  - 添加 `stop_recurring_course` case：處理重複課程停止回覆

---

## [v10.0.3] - 2025-07-29

### Fixed
- **模組導入修復**: 修復 `CourseManagementScenarioTemplate.js` 中的大小寫敏感問題，解決查詢課表功能錯誤。

### Added  
- **規則引擎泛化**: 實施二進制判斷邏輯，提升規則覆蓋率至75%，平均延遲降至82.5ms。
  - 簡化信心度判斷：`confidence > 0` 就用規則引擎
  - 擴展重複課程規則：直接支援週一到週日匹配
  - 增強查詢意圖規則：添加更多常見表達方式

---

## [v10.0.2] - 2025-07-29

### Fixed
- **重複課程意圖識別修復**: 修復 "每周二下午兩點上數學課" 無法觸發重複課程功能的問題。
  - 支援簡體中文字符：新增 "每周"、"周一"、"周二" 等字符變體
  - 更新意圖規則配置支援繁體與簡體中文混用
  - 修復語義分析器重複模式識別邏輯

---

## [v10.0.1] - 2025-07-29

### Fixed
- **生產環境修復**: 修復模組導入大小寫敏感問題，解決 Linux 伺服器上 `RecurringCourseCalculator` 模組找不到的錯誤。

---

## [v10.0.0] - 2025-07-29

### Added
- **重複課程功能**: 全新的重複課程管理系統，支援每天、每週、每月重複課程。
  - 智能起始日期判斷：根據當前時間自動避免過期課程
  - 動態計算架構：查詢時即時計算，不預先創建課程實例
  - 完整管理介面：創建、修改、停止重複課程
  - 布林欄位標註：使用 `daily_recurring`、`weekly_recurring`、`monthly_recurring` 標記重複類型
  - 🔄 標籤顯示：重複課程在查詢時自動顯示重複標籤

### Enhanced
- **語義分析增強**: 新增重複課程語義識別，支援「每週三」、「每天」、「每月15號」等自然語言表達。
- **意圖規則擴展**: 新增 `create_recurring_course`、`modify_recurring_course`、`stop_recurring_course` 意圖。
- **時間服務擴展**: 新增智能起始日期計算方法 `calculateSmartStartDate`。
- **動態衝突檢測**: 支援重複課程的時間衝突檢測，計算未來4週時間點。

### Technical
- **RecurringCourseCalculator**: 新增動態課程計算引擎，支援高效的重複課程實例生成。
- **資料模型擴展**: 在 `courses` 集合中新增重複課程相關欄位。
- **性能優化**: 智能迭代次數控制，避免無限循環，計算效率 < 100ms。
- **架構相容**: 完全遵循三層語義架構，不影響現有功能。

---

## [v9.3.0] - 2025-07-28

### Changed
- **語義分析優化**: 在多輪對話中，若用戶僅輸入時間（如「明天早上十點」），系統將拒絕處理並引導用戶提供完整課程資訊，避免誤判。

---

## [v9.2.0] - 2025-07-26

### Changed
- **性能優化**: 顯著減少了 `EntityService` 和 `TaskService` 的日誌輸出，並優化了內部驗證邏輯，提升運行效率。

---

## [v9.1.0] - 2025-07-26

### Fixed
- **重大架構修正**: 修正了部署模式，確保每個服務實例只加載其對應的單一業務場景（如課程管理），大幅降低了內存使用並實現了真正的微服務隔離。

---

## [v9.0.0] - 2025-07-26

### Added
- **核心架構升級 (Scenario Layer)**: 引入了以模板為基礎的 `Scenario Layer` 架構，將業務邏輯從核心服務中分離，使系統能夠支持多種業務場景（如課程、長照、保險）。
- **通用實體服務 (`EntityService`)**: 新增了通用的數據庫操作服務，以支持不同類型的業務實體。
- **配置驅動開發**: 業務規則、訊息模板等現在由 YAML 文件配置，提高了靈活性和可維護性。

### Changed
- **TaskService 重構**: `TaskService` 被重構為一個純粹的委託層，將所有業務邏輯轉發給對應的 `Scenario` 模板處理。

---

## [v8.0.0] - 2025-07-26

### Added
- **會話上下文與糾錯**: 引入了5分鐘過期的會話上下文機制。現在可以處理用戶的糾錯意圖，例如在「扯鈴改成四點30」之後，用戶可以說「不對，是下午」，系統能理解並正確修改。

---

## [v7.2.0] - 2025-07-26

### Fixed
- **語義與時間解析修正**:
  - 增強了對「AI教學」等複合詞課程的識別能力。
  - 修正了 OpenAI 回應中包含 Markdown 標記導致的 JSON 解析失敗問題。
  - 修正了「四點半」被錯誤解析為「4:00」的問題。
  - 修正了「晚上八點」被錯誤解析為上午 (AM) 的問題。
- **回覆內容增強**: 在操作成功後的回覆中加入更詳細的課程資訊，提升用戶體驗。

---

## [v7.1.0] - 2025-07-26

### Added
- **完整調試日誌系統**: 在開發模式下，實現了從用戶輸入到數據庫操作的全鏈路日誌追蹤，大幅提升了開發和除錯效率。

---

## [v7.0.0] - 2025-07-25

### Added
- **引入真實 AI 語義理解**:
  - 正式對接 OpenAI API，取代了原有的 Mock 服務和硬編碼規則。
  - 使用大型語言模型 (LLM) 進行實體提取，能更智能地處理多樣化的自然語言表達。
- **智能後備機制**: 實現了「規則引擎優先，AI 後備」的混合模式。高確定性的指令由本地規則快速處理，模糊指令則交由 AI 進行深度理解。

### Fixed
- **架構約束修復**: 透過引入本地 ESLint 插件，完整地實現了開發時的跨層導入檢查，確保了架構的純淨性。
- **CI/CD 流程修復**: 提交了 `package-lock.json` 並修正了 ESLint 規則，使自動化流程恢復正常。

---

## [v6.3.0] - 2025-07-25

### Added
- **修改課程功能**: 實現了修改現有課程時間、地點、老師等資訊的核心業務邏輯。
- **清空課表功能**: 新增了清空所有課程的功能，並設計了二次確認機制以防止誤操作。

---

## [v5.0.0] - 2025-07-25

### Added
- **LINE Bot 集成**: 實現了完整的 LINE Webhook 後端，包括 Express 服務器、簽名驗證、消息接收與回覆的完整流程。系統已可接收真實的 LINE 訊息並作出回應。

---

## [v4.0.0] - 2025-07-25

### Added
- **Firebase 持久化**:
  - 將課程數據從記憶體存儲遷移至 Firebase Firestore，實現了數據的永久保存。
  - 新增 `token_usage` 集合，用於記錄和監控 OpenAI API 的調用成本。
- **部署配置修復**: 提供了完整的 Render 平台環境變數設置指南，解決了因配置缺失導致的 Firebase 初始化失敗問題。

---

## [v3.0.0] - 2025-07-25

### Added
- **核心業務邏輯實現 (記憶體)**: 在 `CourseService` 和 `DataService` 中完整實現了課程的新增、查詢、更新、刪除 (CRUD) 操作，但數據暫存於伺服器記憶體中。

---

## [v2.0.0] - 2025-07-25

### Added
- **規則引擎與時間解析**:
  - `IntentRuleEngine`: 實現了基於 YAML 配置的本地規則引擎，用於快速、準確地識別用戶意圖。
  - `TimeService`: 實現了強大的時間解析功能，支持自然語言（如「明天下午三點半」）和多種時區。

---

## [v1.0.0] - 2025-07-25

### Added
- **三層語義架構骨架**:
  - 建立了專案的核心服務層，包括 `SemanticService`、`TimeService` 和 `DataService` 的接口定義。
  - **強制架構邊界**: 引入了自訂的 ESLint 規則 (`no-cross-layer-imports`)，從技術上強制分離了不同層級的職責，禁止了不合規的跨層調用。

---

## [v0.1.0] - 2025-07-25

### Added
- **專案初始化**: 創建專案骨架，配置了 Node.js、ESLint、Prettier、Jest，並建立了基本的 CI/CD 流程。