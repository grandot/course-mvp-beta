# Slot Template System 需求規格書

## 🎯 功能概述

Slot Template System 是一套語意任務對話管理系統，旨在實現多輪對話、漸進式資訊收集和狀態追蹤功能。該系統將在現有 SemanticService 和 TaskService 之間新增對話狀態管理層，支援不完整資訊的語音輸入場景。

## 🏗️ 架構定位

```
用戶輸入 (語音/文字)
↓
SemanticService (基礎語意分析)
↓
🆕 SlotTemplateManager (對話狀態管理、欄位補全)
↓ (當 slots 完整時)
TaskService (執行協調)
↓
Scenario Template (業務邏輯執行)
```

## 📋 核心需求

### 1. Slot Template 定義系統

**需求描述**: 建立標準化的 Slot Template 定義格式，支援不同場景的欄位需求。

**功能要求**:
- 支援 9 個核心 slot: student, course, date, time, location, teacher, reminder, repeat, note
- JSON 格式的模板定義，支援欄位類型、必填狀態、預設值
- 支援場景擴展 (健身課、用藥紀錄等)
- 欄位間的依賴關係定義

**驗收標準**:
- [ ] 定義完整的課程管理 Slot Template
- [ ] 支援新增自定義 Slot Template
- [ ] 模板驗證機制正常運作

### 2. 多輪對話狀態管理

**需求描述**: 為每位用戶維護一個對話任務狀態，追蹤 Slot 填充進度。

**功能要求**:
- 用戶級別的 active_task 狀態追蹤
- Slot 值的增量更新和衝突處理
- 任務完成度判斷 (incomplete/complete)
- 會話超時和狀態清理機制

**驗收標準**:
- [ ] 用戶可在多輪對話中逐步補全資訊
- [ ] 系統正確追蹤每個 slot 的填充狀態
- [ ] 任務完成時自動觸發業務邏輯執行

### 3. 語意解析增強

**需求描述**: 增強現有 SemanticService，使其能輸出標準化的 slot_state 格式。

**功能要求**:
- Claude API 返回固定格式: { intent, slot_state, confidence }
- 智能 Slot 值提取和正規化
- 模糊資訊標記為 null
- 時間和日期的智能解析

**驗收標準**:
- [ ] 語意分析結果符合 Slot Template 格式
- [ ] 正確識別和提取各類 slot 值
- [ ] 處理模糊和不完整的用戶輸入

### 4. Slot 合併邏輯

**需求描述**: 實現新舊 slot_state 的智能合併，處理更新、覆蓋、衝突等情況。

**功能要求**:
- 新值覆蓋空值 (null) 的基本合併
- 現有值衝突的確認機制
- 修改意圖的自動檢測
- 合併歷史的追蹤記錄

**驗收標準**:
- [ ] 正確合併新舊 slot 值
- [ ] 檢測和處理 slot 值衝突
- [ ] 支援明確的修改操作

### 5. 任務執行觸發機制

**需求描述**: 當 slot_state 達到完成條件時，自動觸發對應的業務邏輯執行。

**功能要求**:
- 可配置的最低執行門檻 (必填欄位)
- 自動觸發 TaskService 執行
- 執行結果的狀態更新
- 失敗後的狀態回滾機制

**驗收標準**:
- [ ] 任務完成時自動執行業務邏輯
- [ ] 執行失敗時正確處理狀態
- [ ] 支援不同場景的執行門檻配置

## 🔧 技術需求

### 系統整合需求
- 與現有 SemanticService 無縫整合
- 不影響現有 Scenario Template 架構
- 支援現有的 ConversationContext 功能
- 向後兼容現有 API 介面

### 效能需求
- 對話狀態查詢響應時間 < 100ms
- 支援並發用戶數 > 100
- Slot 合併操作時間 < 50ms
- 記憶體使用增量 < 50MB

### 可靠性需求
- 對話狀態持久化存儲
- 系統重啟後狀態恢復
- 用戶會話異常的優雅處理
- 完整的錯誤日誌和監控

## 📊 使用場景

### 主要使用場景

**場景 1: 漸進式課程創建**
```
用戶: "明天下午小光要上鋼琴課"
系統: 提取 student, course, date, time → 詢問缺失的 location, teacher
用戶: "在板橋教室"
系統: 更新 location → 詢問 teacher
用戶: "王老師教的"  
系統: 完成所有必填欄位 → 執行課程創建
```

**場景 2: 資訊修正**
```
用戶: "明天小光上數學課"
系統: 儲存初始資訊
用戶: "不對，是後天"
系統: 檢測修改意圖 → 更新 date
```

**場景 3: 重複課程設定**
```
用戶: "小光每週三下午兩點上鋼琴課"
系統: 識別 repeat 欄位 → 詢問其他必要資訊
用戶: 逐步補全 location, teacher 等
系統: 完成後執行重複課程創建
```

## 🚀 成功指標

### 用戶體驗指標
- 平均對話輪數減少 30%
- 任務完成率提升至 95%
- 用戶輸入錯誤率降低 50%

### 技術指標  
- Slot 提取準確率 > 90%
- 系統響應時間 < 2 秒
- 對話狀態一致性 100%

### 業務指標
- 課程創建成功率 > 98%
- 支援的場景類型 ≥ 3 種
- API 向後兼容性 100%

## 📝 限制和約束

### 技術限制
- 基於現有的 Firebase Firestore 架構
- 必須支援現有的 LINE Bot 整合
- Claude API 調用頻率限制

### 業務限制
- 初期只支援課程管理場景
- 對話狀態保留時間限制 (24小時)
- 同時進行的對話任務數限制 (每用戶1個)

### 資源限制
- 開發時間: 2 週
- 不增加額外的雲端服務依賴
- 保持現有系統的穩定性