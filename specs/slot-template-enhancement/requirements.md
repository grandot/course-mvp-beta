# Slot Template 智能問題檢測與上下文管理增強 - 需求規範

## 🎯 項目概述

基於用戶反饋，現有的 Slot Template System 在處理不完整用戶輸入時存在體驗問題。本需求旨在建立智能問題檢測系統、多輪對話狀態管理，以及人性化的提示機制，讓系統能夠優雅地處理複雜的資訊收集場景。

## 🔍 問題分析

### 當前痛點
1. **「後台」不是正確日期** - 系統應該識別並提問，而非直接記錄
2. **「下午」時間過於模糊** - 需要具體時間，系統應要求明確資訊
3. **多個問題同時出現** - 不應記錄不完整資訊，應提示重新輸入
4. **缺乏上下文追蹤** - 單一問題時無法暫存已識別的正確資訊
5. **提示訊息不夠人性化** - 缺乏智能建議和引導

### 典型問題場景
**用戶輸入**: 「後台下午小美大提琴課」
**系統應該做的**:
- 識別「後台」為無效日期
- 識別「下午」為模糊時間  
- 識別「小美」、「大提琴課」為有效資訊
- 因為有2個問題，不記錄任何資料，提示重新輸入
- 提供人性化的引導訊息

## 📋 功能需求

### FR-1: 智能問題檢測系統
**描述**: 系統能夠自動分析用戶輸入，識別並分類各種問題類型

#### FR-1.1: 問題類型分類
**WHEN** 系統接收到用戶輸入，**THE SYSTEM** 必須能夠識別以下問題類型：
- **無效日期問題**: 如「後台」、「前天」、無法解析的日期表達
- **模糊時間問題**: 如「下午」、「晚上」、「早上」等不具體時間
- **缺失必填欄位問題**: 如缺少課程名稱、學生姓名等
- **格式錯誤問題**: 如時間格式不正確、日期格式不符等

#### FR-1.2: 問題嚴重度評估  
**WHEN** 系統檢測到問題，**THE SYSTEM** 必須能夠評估問題嚴重度：
- **高嚴重度**: 必填欄位缺失、完全無效的資料
- **中嚴重度**: 格式錯誤、模糊表達
- **低嚴重度**: 選填欄位缺失、輕微格式問題

#### FR-1.3: 問題數量統計
**WHEN** 系統完成問題檢測，**THE SYSTEM** 必須提供準確的問題數量統計，包括：
- 總問題數量
- 各嚴重度級別的問題數量
- 各類型問題的詳細列表

### FR-2: 多問題處理策略
**描述**: 根據檢測到的問題數量，系統採用不同的處理策略

#### FR-2.1: 多問題場景（≧2個問題）
**WHEN** 系統檢測到2個或以上的問題，**THE SYSTEM** 必須：
- **不記錄任何資料** 到 Firestore 或暫存區
- **生成人性化提示訊息**，說明所有問題
- **提供具體的修正建議**
- **要求用戶重新完整輸入**

#### FR-2.2: 單一問題場景（1個問題）
**WHEN** 系統檢測到僅1個問題，**THE SYSTEM** 必須：
- **暫存所有正確識別的資訊**
- **僅針對問題欄位進行提問**
- **保持對話上下文狀態**
- **等待用戶補充缺失資訊**

#### FR-2.3: 無問題場景（0個問題）
**WHEN** 系統檢測到沒有問題，**THE SYSTEM** 必須：
- **直接記錄完整資料** 到 Firestore
- **回覆確認訊息**
- **清除暫存狀態**

### FR-3: 上下文狀態管理系統
**描述**: 支援多輪對話的狀態追蹤和資料暫存機制

#### FR-3.1: 暫存區管理
**WHEN** 系統進入單一問題模式，**THE SYSTEM** 必須：
- **建立用戶專屬暫存區**，儲存已識別的正確資訊
- **設定暫存區過期時間**（建議30分鐘）
- **支援暫存區的查詢、更新、清除操作**

#### FR-3.2: 上下文合併邏輯
**WHEN** 用戶提供補充資訊，**THE SYSTEM** 必須：
- **驗證補充資訊的有效性**
- **將新資訊與暫存區資料合併**
- **重新執行完整性檢查**
- **根據合併結果決定下一步動作**

#### FR-3.3: 對話狀態追蹤
**WHEN** 系統處於多輪對話狀態，**THE SYSTEM** 必須追蹤：
- **當前對話階段**（初始輸入、等待補充、確認階段）
- **已收集的資訊清單**
- **待收集的資訊清單**
- **用戶輸入歷史**（最近3次）

### FR-4: 智能提示訊息生成
**描述**: 根據問題類型和上下文，生成人性化、具體的提示訊息

#### FR-4.1: 多問題提示格式
**WHEN** 檢測到多個問題，**THE SYSTEM** 必須生成包含以下要素的訊息：
- **友善的開場白**（如「我需要一些更具體的資訊」）
- **問題清單**，每個問題有具體說明
- **修正建議**，提供正確格式範例
- **重新輸入請求**，使用鼓勵性語言

#### FR-4.2: 單一問題提示格式  
**WHEN** 檢測到單一問題，**THE SYSTEM** 必須生成包含以下要素的訊息：
- **確認已收集資訊**（如「我已記錄小美的大提琴課」）
- **具體問題詢問**（如「請問要安排在哪一天呢？」）
- **格式建議**（如「您可以說明天、8月1日或2025-08-01」）
- **進度提示**（如「還需要1個資訊就可以完成」）

#### FR-4.3: 智能建議生成
**WHEN** 系統提問缺失資訊，**THE SYSTEM** 應該提供：
- **基於歷史資料的建議**（如常用時間、地點）
- **格式範例**（如日期、時間的正確格式）
- **快捷選項**（如「明天」、「下週三」）

### FR-5: 必填欄位驗證規則
**描述**: 明確定義課程建立的必填欄位及驗證邏輯

#### FR-5.1: 當前必填欄位定義
**THE SYSTEM** 必須驗證以下欄位為必填：
- **課程名稱** (`course`): 非空字串，長度1-100字元
- **日期** (`date`): 有效的日期格式，不能是過去時間
- **時間** (`time`): 24小時制格式 HH:mm，或可解析的自然語言時間

#### FR-5.2: 未來擴展欄位準備
**THE SYSTEM** 必須為以下欄位預留驗證邏輯：
- **學生姓名/角色** (`student`): 當啟用時成為必填欄位
- **授課老師** (`teacher`): 當啟用時成為必填欄位  
- **上課地點** (`location`): 當啟用時成為必填欄位

#### FR-5.3: 驗證規則配置化
**THE SYSTEM** 必須支援：
- **動態調整必填欄位清單**
- **每個欄位的驗證規則配置**
- **驗證錯誤訊息自定義**

## 🎭 使用場景

### 場景1: 多問題輸入處理
```
用戶: 「後台下午小美大提琴課」
系統: 「我需要一些更具體的資訊來幫您安排課程：
      
      📅 日期問題：「後台」不是有效的日期，請提供具體日期
         建議格式：明天、8月1日、2025-08-01
      
      ⏰ 時間問題：「下午」需要更具體的時間
         建議格式：14:00、下午2點、晚上7點半
      
      請重新完整輸入課程資訊，例如：
      「8月1日下午2點小美大提琴課」」
```

### 場景2: 單一問題暫存處理
```
用戶: 「明天小美大提琴課」
系統: 「我已記錄：
      📚 課程：大提琴課
      👤 學生：小美  
      📅 日期：明天(8月1日)
      
      請問幾點開始上課呢？
      您可以說：14:00、下午2點、晚上7點半」

用戶: 「下午2點」
系統: 「課程安排完成！✅
      
      📚 課程：大提琴課
      👤 學生：小美
      📅 日期：8月1日(明天)
      ⏰時間：14:00
      
      我已為您記錄這堂課。」
```

### 場景3: 完整資訊直接記錄
```
用戶: 「明天下午2點小美大提琴課」
系統: 「課程安排完成！✅
      
      📚 課程：大提琴課
      👤 學生：小美
      📅 日期：8月1日(明天)  
      ⏰ 時間：14:00
      
      我已為您記錄這堂課。」
```

## ✅ 驗收標準

### AC-1: 問題檢測準確性
- [ ] 系統能正確識別無效日期（如「後台」、「昨天」）
- [ ] 系統能正確識別模糊時間（如「下午」、「晚上」）
- [ ] 系統能正確識別缺失必填欄位
- [ ] 問題分類準確率達95%以上

### AC-2: 多問題處理正確性
- [ ] 檢測到≧2個問題時，不記錄任何資料
- [ ] 生成的提示訊息包含所有問題的具體說明
- [ ] 提供合適的修正建議和範例
- [ ] 要求用戶重新完整輸入

### AC-3: 單一問題暫存功能
- [ ] 檢測到1個問題時，正確暫存有效資訊
- [ ] 僅針對問題欄位進行提問
- [ ] 暫存資料在30分鐘後自動清除
- [ ] 支援暫存區的查詢和更新

### AC-4: 上下文合併邏輯
- [ ] 用戶補充資訊後，正確合併到暫存區
- [ ] 合併後重新驗證完整性
- [ ] 所有必填欄位完整後自動記錄到 Firestore
- [ ] 合併衝突時提供明確提示

### AC-5: 提示訊息品質
- [ ] 多問題提示包含問題清單、建議、範例
- [ ] 單一問題提示包含已收集資訊確認
- [ ] 訊息使用友善、鼓勵性的語言
- [ ] 提供基於歷史資料的智能建議

### AC-6: 效能要求
- [ ] 問題檢測響應時間 < 500ms
- [ ] 暫存區操作響應時間 < 200ms  
- [ ] 支援同時處理100個用戶的暫存狀態
- [ ] 系統可用性 > 99.5%

## 🔄 與現有系統整合

### 整合點1: SemanticService
- 擴展語意分析結果，增加問題檢測資訊
- 保持現有 intent、entities、timeInfo 格式
- 新增 issues 欄位，包含檢測到的問題清單

### 整合點2: SlotTemplateManager  
- 增加問題檢測邏輯到主要流程
- 根據問題數量選擇處理策略
- 整合暫存區管理功能

### 整合點3: SlotValidator
- 擴展驗證邏輯，支援問題分類
- 增加問題嚴重度評估
- 支援部分資料的暫存驗證

### 整合點4: Controller層  
- 根據處理策略生成不同回應
- 管理多輪對話狀態
- 處理暫存區到 Firestore 的最終記錄

## 🚀 實作優先級

### P0 (高優先級) - 核心功能
1. 問題檢測與分類系統
2. 多問題/單一問題處理策略
3. 基本暫存區管理

### P1 (中優先級) - 體驗優化  
1. 智能提示訊息生成
2. 上下文合併邏輯
3. 對話狀態追蹤

### P2 (低優先級) - 進階功能
1. 基於歷史資料的智能建議
2. 暫存區過期管理
3. 詳細的問題分析報告

## 📊 成功指標

### 使用者體驗指標
- **任務完成率**: 從當前60%提升至90%
- **重新輸入次數**: 平均從2.3次降至1.2次  
- **用戶滿意度**: 從3.2/5提升至4.5/5

### 技術效能指標
- **問題檢測準確率**: ≧95%
- **響應時間**: ≦500ms
- **系統可用性**: ≧99.5%
- **並發處理能力**: 100個同時暫存狀態

---

**文件版本**: v1.0  
**建立日期**: 2025-07-28  
**負責人**: 策略規劃師