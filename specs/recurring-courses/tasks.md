# 重複課程功能實作任務清單（更新版 - 動態計算架構）

> **重要更新**: 根據新的功能需求，重新設計系統架構採用動態計算方式。  
> **新的設計理念**: 不預先創建課程實例，而是在查詢時動態計算。  
> **起始日期智能判斷**: 根據當前時間自動判斷重複課程的開始日期。

## 基礎架構準備

### 資料模型設計
- [x] 1.1 在現有 courses 集合中新增 daily_recurring、weekly_recurring、monthly_recurring 欄位
- [x] 1.2 新增 recurrence_details 欄位儲存重複詳細資訊
- [x] 1.3 擴充 DataService.queryCourses 方法支援重複課程篩選
- [x] 1.4 實作 isRecurringCourseOnDate 方法判斷特定日期是否有重複課程

### 語意解析擴展
- [x] 2.1 擴展 SemanticService 支援重複課程語意識別
- [x] 2.2 實作 parseRecurrenceType 方法識別 daily/weekly/monthly 模式
- [x] 2.3 實作 calculateStartDate 方法智能判斷起始日期
- [x] 2.4 在 intent-rules.yaml 中新增重複課程相關規則

### 任務執行層擴展
- [x] 3.1 在 TaskService 中新增 create_recurring_course intent 處理
- [x] 3.2 實作 handleCreateRecurringCourse 方法（不創建實例，只儲存規則）
- [x] 3.3 實作 handleModifyRecurringCourse 方法修改重複規則
- [x] 3.4 實作 handleStopRecurringCourse 方法停止重複
- [x] 3.5 擴展 handleQueryCourses 方法支援動態重複課程計算

## 核心功能實作

### 重複課程創建
- [x] 4.1 實作 calculateStartDate 方法智能判斷起始日期
- [x] 4.2 實作動態時間衝突檢測（計算未來4週的時間點）
- [x] 4.3 修改 DataService.createCourse 支援重複欄位
- [x] 4.4 實作衝突處理選項介面

### 動態課程計算
- [x] 5.1 實作 calculateFutureOccurrences 方法計算未來課程
- [x] 5.2 實作 matchesRecurrenceRule 方法判斷特定日期是否符合重複規則
- [x] 5.3 實作 getRecurrenceLabel 方法生成顯示標籤
- [x] 5.4 擴展 TimeService 新增 getNextWeekday 和 getNextMonthDay 方法

### 重複課程管理
- [x] 6.1 實作重複課程修改功能（更新重複規則）
- [x] 6.2 實作重複課程停止功能（設定欄位為 false）
- [x] 6.3 實作重複課程狀態管理
- [x] 6.4 實作重複課程資訊查詢（動態顯示）

## 測試與驗證

### 單元測試
- [x] 7.1 撰寫 calculateStartDate 方法測試
- [x] 7.2 撰寫 calculateFutureOccurrences 方法測試
- [x] 7.3 撰寫動態衝突檢測測試
- [x] 7.4 撰寫重複課程語意解析測試

### 整合測試
- [x] 8.1 撰寫完整重複課程創建流程測試
- [x] 8.2 撰寫重複課程管理操作測試
- [x] 8.3 撰寫動態查詢系統測試
- [x] 8.4 撰寫錯誤處理場景測試

## 部署與配置

### 環境配置
- [x] 9.1 配置重複課程功能開關
- [x] 9.2 擴展 Firestore 索引支援新欄位
- [x] 9.3 設定資料庫的預設值
- [x] 9.4 更新部署配置

### 文檔更新
- [x] 10.1 更新 API 文檔
- [x] 10.2 更新使用者指南
- [x] 10.3 更新開發者文檔
- [x] 10.4 更新部署指南

## 核心技術要點

### 起始日期智能判斷邏輯

**每天重複課程**：
```
用戶輸入："每天下午三點英文課"
判斷邏輯：
- 如果當前時間已過下午三點 → 起始日期為明天
- 如果當前時間未過下午三點 → 起始日期為今天
```

**每週重複課程**：
```
用戶輸入："每週三下午三點英文課"
判斷邏輯：
- 如果今天是週三且時間已過下午三點 → 起始日期為下週三
- 如果今天是週三且時間未過下午三點 → 起始日期為本週三
- 如果今天不是週三 → 起始日期為最近的週三
```

**每月重複課程**：
```
用戶輸入："每月5號下午三點英文課"
判斷邏輯：
- 如果今天是5號且時間已過下午三點 → 起始日期為下月5號
- 如果今天是5號且時間未過下午三點 → 起始日期為當月5號
- 如果今天超過5號 → 起始日期為下月5號
- 如果今天不到5號 → 起始日期為當月5號
```

### 資料結構設計

**課程資料模型**：
```javascript
{
  // 基本欄位
  id: "course_id",
  student_id: "user_id",
  course_name: "英文課",
  course_date: "2025-07-29",
  schedule_time: "下午3點",
  
  // 重複課程標註欄位（新增）
  daily_recurring: false,
  weekly_recurring: true,
  monthly_recurring: false,
  
  // 重複詳細資訊（新增）
  recurrence_details: {
    days_of_week: [3], // 週三
    time_of_day: "15:00",
    start_date: "2025-07-30",
    end_condition: {
      type: "never"
    }
  }
}
```

### 動態計算範例

**查詢時動態計算**：
```javascript
// 用戶查詢："我下週的課程"
// 系統流程：
1. 查詢所有課程（包含重複和非重複）
2. 對每個重複課程：
   - 檢查是否在查詢日期範圍內
   - 根據重複規則計算具體日期
   - 生成顯示用的課程資訊
3. 合併重複和非重複課程結果
4. 按日期排序返回
```

## Rules & Tips

### 開發原則
- 遵循三層語義架構，確保職責分離
- 動態計算優於預先創建，減少資料庫負擔
- 起始日期判斷要考慮時區和用戶當前時間
- 所有重複課程操作都需要明確的用戶確認

### 技術約束
- 重複課程不預先創建實例，只在查詢時計算
- 衝突檢測需要動態計算未來時間點
- 所有時間計算必須通過 TimeService
- 重複類型使用布林欄位，不使用枚舉

### 性能考量
- 動態計算要即時完成，避免用戶等待
- 合理設定查詢範圍，避免無限計算
- 重複規則要有合理的結束條件
- 考慮使用快取減少重複計算

### 向後相容性
- 現有單次課程功能不受影響
- 新增欄位使用預設值確保兼容性
- API 介面保持向後相容
- 逐步遷移，避免破壞性變更

### 實作優先級

**Phase 1 - 基礎功能**：
1. 資料模型擴展
2. 起始日期智能判斷
3. 基本重複課程創建

**Phase 2 - 動態計算**：
1. 動態課程計算邏輯
2. 查詢系統整合
3. 衝突檢測

**Phase 3 - 管理功能**：
1. 重複課程修改
2. 停止和狀態管理
3. 進階查詢功能

**Phase 4 - 完善與測試**：
1. 完整測試覆蓋
2. 性能優化
3. 文檔更新