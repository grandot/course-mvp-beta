# 重複課程功能完善需求規格

## 功能概述
完善現有重複課程功能，實現自動生成、語意識別、管理介面和衝突處理等核心業務邏輯。

## 使用者故事與驗收標準

### 1. 自動生成重複課程

**故事 1.1：創建重複課程**
> 作為學童家長，我希望能夠設定重複課程，讓系統自動生成後續的課程時間

**驗收標準**：
- WHEN 用戶說出「每週一下午2點上數學課」 THEN 系統應該創建重複課程並自動生成後續4週的課程
- WHEN 用戶設定重複課程 THEN 系統應該記錄重複模式（每日/每週/每月）和結束條件
- WHEN 系統生成重複課程 THEN 每個課程實例都應該有獨立的課程ID但共享重複課程群組ID

**故事 1.2：設定重複課程結束條件**
> 作為學童家長，我希望能夠設定重複課程的結束時間或次數

**驗收標準**：
- WHEN 用戶說「數學課重複4次」 THEN 系統應該生成4個課程實例
- WHEN 用戶說「數學課重複到下個月底」 THEN 系統應該計算並生成到指定日期的所有課程
- WHEN 重複課程達到結束條件 THEN 系統應該停止自動生成新的課程實例

### 2. 語意解析重複性描述

**故事 2.1：識別時間重複模式**
> 作為系統，我需要能夠理解用戶對重複時間的各種表達方式

**驗收標準**：
- WHEN 用戶說「每週一」 THEN 系統應該識別為每週重複，星期一
- WHEN 用戶說「每天下午3點」 THEN 系統應該識別為每日重複，下午3點
- WHEN 用戶說「每個月15號」 THEN 系統應該識別為每月重複，15號
- WHEN 用戶說「每週二和週四」 THEN 系統應該識別為每週重複，多個時間點

**故事 2.2：識別重複課程相關動詞**
> 作為系統，我需要能夠理解用戶想要創建重複課程的意圖

**驗收標準**：
- WHEN 用戶說「定期上鋼琴課」 THEN 系統應該識別為創建重複課程意圖
- WHEN 用戶說「固定時間學英文」 THEN 系統應該識別為創建重複課程意圖
- WHEN 用戶說「每週都要上游泳課」 THEN 系統應該識別為創建重複課程意圖

### 3. 重複課程管理介面

**故事 3.1：修改重複課程**
> 作為學童家長，我希望能夠修改重複課程的設定

**驗收標準**：
- WHEN 用戶說「把數學課改到每週三」 THEN 系統應該詢問是否修改所有未來的重複課程
- WHEN 用戶確認修改 THEN 系統應該更新重複模式並重新生成未來課程
- WHEN 用戶只想修改單次課程 THEN 系統應該將該課程從重複群組中分離

**故事 3.2：停止重複課程**
> 作為學童家長，我希望能夠停止特定的重複課程

**驗收標準**：
- WHEN 用戶說「停止數學課的重複」 THEN 系統應該詢問是否取消所有未來的重複課程
- WHEN 用戶確認停止 THEN 系統應該將重複狀態設為停止，但保留已上的課程記錄
- WHEN 停止重複課程 THEN 系統應該通知用戶有多少課程被取消

**故事 3.3：查看重複課程資訊**
> 作為學童家長，我希望能夠查看重複課程的詳細資訊

**驗收標準**：
- WHEN 用戶查詢課程時 THEN 系統應該顯示該課程是否為重複課程
- WHEN 課程為重複課程 THEN 系統應該顯示重複模式、下次上課時間和剩餘次數
- WHEN 用戶要求查看重複課程列表 THEN 系統應該顯示所有活躍的重複課程群組

### 4. 重複課程衝突檢測

**故事 4.1：時間衝突檢測**
> 作為系統，我需要檢測重複課程與現有課程的時間衝突

**驗收標準**：
- WHEN 創建重複課程時有時間衝突 THEN 系統應該列出所有衝突的時間點
- WHEN 檢測到衝突 THEN 系統應該詢問用戶是否要調整時間或取消衝突課程
- WHEN 用戶選擇調整時間 THEN 系統應該建議可用的時間段

**故事 4.2：重複課程間衝突處理**
> 作為系統，我需要處理多個重複課程之間的衝突

**驗收標準**：
- WHEN 兩個重複課程時間重疊 THEN 系統應該標記衝突並通知用戶
- WHEN 用戶要解決衝突 THEN 系統應該提供調整建議（時間或頻率）
- WHEN 衝突無法自動解決 THEN 系統應該要求用戶手動選擇保留哪個課程

### 5. 重複課程狀態管理

**故事 5.1：重複課程生命週期**
> 作為系統，我需要正確管理重複課程的各種狀態

**驗收標準**：
- WHEN 重複課程創建 THEN 狀態應該為「活躍」
- WHEN 重複課程被暫停 THEN 狀態應該為「暫停」，不再生成新課程
- WHEN 重複課程被停止 THEN 狀態應該為「已停止」，保留歷史記錄
- WHEN 重複課程達到結束條件 THEN 狀態應該自動變為「已完成」

## 技術約束

### 數據一致性
- 重複課程群組必須有統一的群組ID
- 每個課程實例必須關聯到正確的重複課程群組
- 刪除重複課程時必須確保數據完整性

### 性能要求
- 生成重複課程時應批量操作，避免過多資料庫寫入
- 衝突檢測應該有效率，避免全表掃描
- 查詢重複課程資訊時應該快速回應

### 使用者體驗
- 重複課程相關操作都應該有明確的確認步驟
- 錯誤訊息應該清楚說明問題和解決方案
- 系統應該主動提醒用戶重複課程的狀態變化

## 優先級排序

1. **高優先級**：語意解析重複性描述、自動生成重複課程
2. **中優先級**：重複課程管理介面、衝突檢測
3. **低優先級**：進階管理功能、統計報表