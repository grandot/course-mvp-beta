# 重複課程功能完善需求規格

## 功能概述
完善現有重複課程功能，實現動態計算式重複課程機制，支援語意識別、管理介面和衝突處理等核心業務邏輯。重點採用動態計算而非預先創建的架構設計。

## 使用者故事與驗收標準

### 1. 自動生成重複課程

**故事 1.1：創建重複課程**
> 作為學童家長，我希望能夠設定重複課程，讓系統記錄重複規則並在查詢時動態計算課程時間

**驗收標準**：
- WHEN 用戶說出「每週一下午2點上數學課」 THEN 系統應該創建重複課程記錄並標記為 weekly_recurring = true
- WHEN 用戶設定重複課程 THEN 系統應該使用布林欄位記錄重複類型（daily_recurring/weekly_recurring/monthly_recurring）
- WHEN 查詢重複課程時 THEN 系統應該根據當前日期動態計算並顯示相關課程時間
- WHEN 創建重複課程時 THEN 系統應該智能判斷起始日期（根據當前時間是否已過期）

**故事 1.2：設定重複課程結束條件**
> 作為學童家長，我希望能夠設定重複課程的結束時間或次數

**驗收標準**：
- WHEN 用戶說「數學課重複4次」 THEN 系統應該記錄結束條件，並在查詢時只顯示4次課程
- WHEN 用戶說「數學課重複到下個月底」 THEN 系統應該記錄結束日期，查詢時只顯示到該日期的課程
- WHEN 查詢重複課程且達到結束條件 THEN 系統應該停止顯示後續課程

### 2. 語意解析重複性描述

**故事 2.1：識別時間重複模式**
> 作為系統，我需要能夠理解用戶對重複時間的各種表達方式

**驗收標準**：
- WHEN 用戶說「每週一」 THEN 系統應該識別為每週重複，星期一
- WHEN 用戶說「每天下午3點」 THEN 系統應該識別為每日重複，下午3點
- WHEN 用戶說「每個月15號」 THEN 系統應該識別為每月重複，15號
- WHEN 用戶說「每週二和週四」 THEN 系統應該識別為每週重複，多個時間點

**故事 2.2：識別重複課程相關動詞**
> 作為系統，我需要能夠理解用戶想要創建重複課程的意圖

**驗收標準**：
- WHEN 用戶說「定期上鋼琴課」 THEN 系統應該識別為創建重複課程意圖
- WHEN 用戶說「固定時間學英文」 THEN 系統應該識別為創建重複課程意圖
- WHEN 用戶說「每週都要上游泳課」 THEN 系統應該識別為創建重複課程意圖

### 3. 起始日期智能判斷

**故事 3.1：智能判斷重複課程起始日期**
> 作為系統，我需要根據用戶輸入時間和當前時間智能判斷重複課程的起始日期

**驗收標準**：
- WHEN 用戶說「每天下午三點英文課」且當前時間已過下午三點 THEN 起始日期應為明天
- WHEN 用戶說「每天下午三點英文課」且當前時間未過下午三點 THEN 起始日期應為今天
- WHEN 用戶說「每週三下午三點英文課」且當前在週三下午三點以前 THEN 起始日期為本週三
- WHEN 用戶說「每週三下午三點英文課」且當前在週三下午三點以後 THEN 起始日期為下週三
- WHEN 用戶說「每月5號下午三點英文課」且當前在當月5號下午三點以前 THEN 起始日期為當月5號
- WHEN 用戶說「每月5號下午三點英文課」且當前在當月5號下午三點以後 THEN 起始日期為下月5號

### 4. 重複課程管理介面

**故事 4.1：修改重複課程**
> 作為學童家長，我希望能夠修改重複課程的設定

**驗收標準**：
- WHEN 用戶說「把數學課改到每週三」 THEN 系統應該詢問是否修改所有未來的重複課程
- WHEN 用戶確認修改 THEN 系統應該更新重複模式並重新生成未來課程
- WHEN 用戶只想修改單次課程 THEN 系統應該將該課程從重複群組中分離

**故事 4.2：停止重複課程**
> 作為學童家長，我希望能夠停止特定的重複課程

**驗收標準**：
- WHEN 用戶說「停止數學課的重複」 THEN 系統應該詢問是否取消所有未來的重複課程
- WHEN 用戶確認停止 THEN 系統應該將重複狀態設為停止，但保留已上的課程記錄
- WHEN 停止重複課程 THEN 系統應該通知用戶有多少課程被取消

**故事 4.3：查看重複課程資訊**
> 作為學童家長，我希望能夠查看重複課程的詳細資訊

**驗收標準**：
- WHEN 用戶查詢課程時 THEN 系統應該顯示該課程是否為重複課程（檢查 daily_recurring/weekly_recurring/monthly_recurring 欄位）
- WHEN 課程為重複課程 THEN 系統應該動態計算並顯示重複模式、下次上課時間
- WHEN 用戶要求查看重複課程列表 THEN 系統應該顯示所有重複課程並標註重複類型

### 5. 重複課程衝突檢測

**故事 5.1：時間衝突檢測**
> 作為系統，我需要檢測重複課程與現有課程的時間衝突

**驗收標準**：
- WHEN 創建重複課程時有時間衝突 THEN 系統應該列出所有衝突的時間點
- WHEN 檢測到衝突 THEN 系統應該詢問用戶是否要調整時間或取消衝突課程
- WHEN 用戶選擇調整時間 THEN 系統應該建議可用的時間段

**故事 5.2：重複課程間衝突處理**
> 作為系統，我需要處理多個重複課程之間的衝突

**驗收標準**：
- WHEN 兩個重複課程時間重疊 THEN 系統應該標記衝突並通知用戶
- WHEN 用戶要解決衝突 THEN 系統應該提供調整建議（時間或頻率）
- WHEN 衝突無法自動解決 THEN 系統應該要求用戶手動選擇保留哪個課程

### 6. 重複課程狀態管理

**故事 6.1：重複課程生命週期**
> 作為系統，我需要正確管理重複課程的各種狀態

**驗收標準**：
- WHEN 重複課程創建 THEN 狀態應該為「活躍」，對應的重複類型欄位設為 true
- WHEN 重複課程被暫停 THEN 狀態應該為「暫停」，查詢時不顯示未來課程
- WHEN 重複課程被停止 THEN 將重複類型欄位設為 false，保留歷史記錄
- WHEN 重複課程達到結束條件 THEN 狀態應該自動變為「已完成」

## 技術約束

### 數據一致性
- 重複課程必須正確設定 daily_recurring、weekly_recurring 或 monthly_recurring 欄位
- 動態計算的課程時間必須與儲存的重複規則保持一致
- 修改重複類型時必須確保數據完整性

### 性能要求
- 動態計算課程時間應該即時完成，避免延遲
- 衝突檢測應該有效率，避免全表掃描
- 查詢重複課程資訊時應該快速回應
- 避免預先創建大量課程實例造成資料庫負擔

### 使用者體驗
- 重複課程相關操作都應該有明確的確認步驟
- 錯誤訊息應該清楚說明問題和解決方案
- 系統應該主動提醒用戶重複課程的狀態變化

## 優先級排序

1. **高優先級**：語意解析重複性描述、動態計算重複課程、起始日期智能判斷
2. **中優先級**：重複課程管理介面、衝突檢測
3. **低優先級**：進階管理功能、統計報表