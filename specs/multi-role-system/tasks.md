# 多角色功能原子化任务清单

## 📋 任务总览

本清单包含所有原子化任务，每个任务都可以独立完成和测试。按照顺序执行，确保功能完整性和向后兼容性。

## 🗓️ Day 1: 数据库结构扩展

### Task 1.1: 更新 Firestore 集合定义
**文件**: `config/firestore-collections.json`
**状态**: ⏳ 待开始
**预计时间**: 2小时

#### 具体步骤
- [ ] 添加 `children` 集合定义
- [ ] 添加 `user_profiles` 集合定义
- [ ] 扩展 `courses` 集合，添加 `child_id` 和 `child_nickname` 字段
- [ ] 更新索引配置

#### 检查点
- [ ] 集合定义语法正确
- [ ] 字段类型和约束合理
- [ ] 索引配置完整
- [ ] 向后兼容性验证

### Task 1.2: 创建数据迁移脚本
**文件**: `scripts/migrations/002_multi_role_setup.js`
**状态**: ⏳ 待开始
**预计时间**: 3小时

#### 具体步骤
- [ ] 创建迁移脚本框架
- [ ] 实现为现有用户创建默认档案
- [ ] 实现为现有课程添加默认子女关联
- [ ] 添加回滚脚本
- [ ] 添加数据验证逻辑

#### 检查点
- [ ] 迁移脚本可以安全运行
- [ ] 现有数据不受影响
- [ ] 回滚脚本功能完整
- [ ] 数据完整性验证通过

### Task 1.3: 更新 DataService
**文件**: `src/services/dataService.js`
**状态**: ⏳ 待开始
**预计时间**: 4小时

#### 具体步骤
- [ ] 添加 `CHILDREN` 和 `USER_PROFILES` 到 `COLLECTIONS`
- [ ] 新增 `createChild()`, `getUserChildren()`, `updateChild()` 方法
- [ ] 新增 `createUserProfile()`, `getUserProfile()` 方法
- [ ] 修改 `createCourse()` 方法，支持 `child_id` 参数
- [ ] 添加 `getCoursesByChild()` 方法

#### 检查点
- [ ] 所有新方法功能正常
- [ ] 现有方法向后兼容
- [ ] 错误处理完善
- [ ] 日志记录完整

## 🗓️ Day 2: 服务层扩展

### Task 1.4: 创建 ChildService
**文件**: `src/services/childService.js`
**状态**: ⏳ 待开始
**预计时间**: 3小时

#### 具体步骤
- [ ] 创建服务类框架
- [ ] 实现子女 CRUD 操作
- [ ] 实现子女查询和验证逻辑
- [ ] 添加昵称重复检查
- [ ] 添加关联课程检查

#### 检查点
- [ ] 子女创建功能正常
- [ ] 子女查询功能正常
- [ ] 昵称重复检查有效
- [ ] 删除前检查关联课程

### Task 1.5: 创建 UserProfileService
**文件**: `src/services/userProfileService.js`
**状态**: ⏳ 待开始
**预计时间**: 2小时

#### 具体步骤
- [ ] 创建服务类框架
- [ ] 实现用户档案管理
- [ ] 实现默认子女设置
- [ ] 添加档案验证逻辑

#### 检查点
- [ ] 用户档案创建正常
- [ ] 默认子女设置功能正常
- [ ] 档案更新功能正常
- [ ] 验证逻辑完善

### Task 1.6: 更新 CourseService
**文件**: `src/services/courseService.js`
**状态**: ⏳ 待开始
**预计时间**: 2小时

#### 具体步骤
- [ ] 修改 `createCourse()` 方法，支持子女关联
- [ ] 修改 `getCoursesByUser()` 方法，支持按子女筛选
- [ ] 添加 `getCoursesByChild()` 方法
- [ ] 更新课程显示格式

#### 检查点
- [ ] 课程创建支持子女关联
- [ ] 课程查询支持子女筛选
- [ ] 现有功能不受影响
- [ ] 显示格式包含子女信息

## 🗓️ Day 3: 语义识别扩展

### Task 2.1: 更新 SemanticService
**文件**: `src/services/semanticService.js`
**状态**: ⏳ 待开始
**预计时间**: 4小时

#### 具体步骤
- [ ] 添加 `extractChildNickname()` 方法
- [ ] 修改 `extractCourseEntities()` 方法，支持子女昵称提取
- [ ] 添加子女昵称验证逻辑
- [ ] 更新实体提取规则，支持「小明明天下午两点钢琴课」格式
- [ ] 添加子女昵称验证方法

#### 检查点
- [ ] 子女昵称提取准确
- [ ] 实体提取功能正常
- [ ] 验证逻辑有效
- [ ] 向后兼容性保持

### Task 2.2: 更新意图规则配置
**文件**: `config/intent-rules.yaml`
**状态**: ⏳ 待开始
**预计时间**: 2小时

#### 具体步骤
- [ ] 添加子女管理相关意图：`add_child`, `list_children`, `switch_child`
- [ ] 更新现有意图规则，支持子女昵称
- [ ] 添加子女相关关键词
- [ ] 更新意图优先级

#### 检查点
- [ ] 新意图规则正确
- [ ] 现有意图不受影响
- [ ] 优先级设置合理
- [ ] 关键词覆盖全面

### Task 2.3: 创建子女管理服务
**文件**: `src/services/childManagementService.js`
**状态**: ⏳ 待开始
**预计时间**: 3小时

#### 具体步骤
- [ ] 创建服务类框架
- [ ] 实现子女添加、列表、切换功能
- [ ] 实现子女昵称解析和验证
- [ ] 添加子女管理业务逻辑
- [ ] 集成到现有服务

#### 检查点
- [ ] 子女管理功能完整
- [ ] 昵称解析准确
- [ ] 验证逻辑有效
- [ ] 集成无冲突

## 🗓️ Day 4: 对话上下文扩展

### Task 2.4: 更新 ConversationContext
**文件**: `src/utils/conversationContext.js`
**状态**: ⏳ 待开始
**预计时间**: 2小时

#### 具体步骤
- [ ] 添加 `current_child_id` 字段
- [ ] 添加子女切换逻辑
- [ ] 更新上下文保存逻辑
- [ ] 添加子女上下文验证

#### 检查点
- [ ] 子女上下文正确保存
- [ ] 切换逻辑正常
- [ ] 上下文验证有效
- [ ] 向后兼容性保持

### Task 2.5: 更新场景模板
**文件**: `src/scenario/templates/CourseManagementScenarioTemplate.js`
**状态**: ⏳ 待开始
**预计时间**: 3小时

#### 具体步骤
- [ ] 在课程操作中集成子女信息
- [ ] 更新消息模板，支持子女昵称显示
- [ ] 修改课程数据构建方法
- [ ] 更新成功消息格式

#### 检查点
- [ ] 子女信息正确集成
- [ ] 消息模板显示子女信息
- [ ] 数据构建支持子女
- [ ] 现有功能不受影响

## 🗓️ Day 5: 任务服务扩展

### Task 3.1: 更新 TaskService
**文件**: `src/services/taskService.js`
**状态**: ⏳ 待开始
**预计时间**: 4小时

#### 具体步骤
- [ ] 添加子女管理意图处理
- [ ] 修改课程相关意图，支持子女关联
- [ ] 添加子女切换和查询功能
- [ ] 实现 `handleAddChild()` 方法
- [ ] 实现 `handleListChildren()` 方法
- [ ] 实现 `handleSwitchChild()` 方法
- [ ] 实现 `handleRecordCourseWithChild()` 方法

#### 检查点
- [ ] 子女管理意图处理正确
- [ ] 课程意图支持子女关联
- [ ] 切换功能正常
- [ ] 向后兼容性保持

### Task 3.2: 更新场景配置
**文件**: `config/scenarios/course_management.yaml`
**状态**: ⏳ 待开始
**预计时间**: 2小时

#### 具体步骤
- [ ] 添加子女相关消息模板
- [ ] 更新业务规则，支持子女筛选
- [ ] 添加子女管理配置
- [ ] 更新验证规则

#### 检查点
- [ ] 消息模板完整
- [ ] 业务规则正确
- [ ] 配置语法正确
- [ ] 验证规则有效

### Task 3.3: 创建子女管理控制器
**文件**: `src/controllers/childController.js`
**状态**: ⏳ 待开始
**预计时间**: 3小时

#### 具体步骤
- [ ] 创建控制器框架
- [ ] 实现子女管理相关业务逻辑
- [ ] 集成到主控制器
- [ ] 添加错误处理
- [ ] 添加日志记录

#### 检查点
- [ ] 控制器功能完整
- [ ] 业务逻辑正确
- [ ] 集成无冲突
- [ ] 错误处理完善

## 🗓️ Day 6: 查询和显示优化

### Task 3.4: 更新课程查询逻辑
**文件**: `src/scenario/templates/CourseManagementScenarioTemplate.js`
**状态**: ⏳ 待开始
**预计时间**: 3小时

#### 具体步骤
- [ ] 修改 `queryEntities()` 方法，支持按子女筛选
- [ ] 更新课程显示格式，包含子女信息
- [ ] 添加子女切换功能
- [ ] 优化查询性能

#### 检查点
- [ ] 查询支持子女筛选
- [ ] 显示格式包含子女信息
- [ ] 切换功能正常
- [ ] 性能无退化

### Task 3.5: 更新消息模板
**文件**: `config/scenarios/course_management.yaml`
**状态**: ⏳ 待开始
**预计时间**: 2小时

#### 具体步骤
- [ ] 修改所有课程相关消息，包含子女昵称
- [ ] 添加子女管理相关消息
- [ ] 更新错误消息，支持子女上下文
- [ ] 添加帮助消息

#### 检查点
- [ ] 消息包含子女信息
- [ ] 管理消息完整
- [ ] 错误消息友好
- [ ] 帮助消息清晰

## 🗓️ Day 7: 测试和优化

### Task 4.1: 创建测试用例
**目录**: `tests/multi-role-system/`
**状态**: ⏳ 待开始
**预计时间**: 4小时

#### 具体步骤
- [ ] 创建 `basic.test.js` - 基础功能测试
- [ ] 创建 `semantic.test.js` - 语义识别测试
- [ ] 创建 `integration.test.js` - 集成测试
- [ ] 创建 `performance.test.js` - 性能测试

#### 检查点
- [ ] 基础功能测试通过
- [ ] 语义识别测试通过
- [ ] 集成测试通过
- [ ] 性能测试通过

### Task 4.2: 集成测试
**状态**: ⏳ 待开始
**预计时间**: 3小时

#### 具体步骤
- [ ] 测试「小明明天下午两点钢琴课」
- [ ] 测试「小美每周三早上十点法语课」
- [ ] 测试子女切换功能
- [ ] 测试多子女课程管理
- [ ] 测试向后兼容性

#### 检查点
- [ ] 子女课程创建正常
- [ ] 重复课程创建正常
- [ ] 切换功能正常
- [ ] 多子女管理正常
- [ ] 现有功能不受影响

### Task 4.3: 性能优化
**状态**: ⏳ 待开始
**预计时间**: 2小时

#### 具体步骤
- [ ] 优化查询性能
- [ ] 添加缓存机制
- [ ] 优化消息生成
- [ ] 监控性能指标

#### 检查点
- [ ] 查询性能无退化
- [ ] 缓存机制有效
- [ ] 消息生成快速
- [ ] 性能指标达标

## 📊 进度跟踪

### 总体进度
- **Phase 1**: 0% (0/6 任务完成)
- **Phase 2**: 0% (0/5 任务完成)
- **Phase 3**: 0% (0/5 任务完成)
- **Phase 4**: 0% (0/3 任务完成)

### 关键里程碑
- [ ] **Day 1 结束**: 数据层扩展完成
- [ ] **Day 2 结束**: 服务层扩展完成
- [ ] **Day 3 结束**: 语义识别扩展完成
- [ ] **Day 4 结束**: 对话上下文扩展完成
- [ ] **Day 5 结束**: 任务服务扩展完成
- [ ] **Day 6 结束**: 查询显示优化完成
- [ ] **Day 7 结束**: 测试优化完成

## 🚨 风险控制

### 高风险任务
1. **Task 1.2**: 数据迁移脚本 - 需要充分测试
2. **Task 2.1**: 语义识别扩展 - 需要验证准确性
3. **Task 3.1**: 任务服务扩展 - 需要确保向后兼容

### 缓解措施
- 每个任务完成后立即测试
- 高风险任务在测试环境充分验证
- 保持完整的回滚机制
- 密切监控系统性能

## 📝 验收标准

### 功能验收
- [ ] 「小明明天下午两点钢琴课」能正确识别并创建课程
- [ ] 「小美每周三早上十点法语课」能正确创建重复课程
- [ ] 课程查询显示包含子女昵称
- [ ] 支持子女添加、列表、切换功能
- [ ] 现有功能完全不受影响

### 技术验收
- [ ] 数据库查询性能不降低
- [ ] API响应时间保持现有水平
- [ ] 错误率 < 1%
- [ ] 向后兼容性 100%

### 用户体验验收
- [ ] 支持自然语言子女表达
- [ ] 子女信息在课程显示中清晰可见
- [ ] 子女管理操作简单直观
- [ ] 无学习成本，即插即用

## 🎯 成功完成

当所有任务完成并通过验收标准时，多角色功能将成功实施，为用户提供强大的多子女课程管理能力，同时保持系统的稳定性和向后兼容性。 