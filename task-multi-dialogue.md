# 多輪對話功能開發任務清單

## 功能概述
實現 LINE Bot 多輪對話功能，解決 Quick Reply 按鈕失效和上下文理解問題。通過 Redis 儲存對話狀態，支援複雜對話流程，提升用戶體驗。

## 核心技術要點
- **無狀態環境挑戰**：Vercel/Render 環境中應用實例會重啟，必須使用外部儲存
- **Redis 選擇原因**：高效能記憶體資料庫，原生 TTL 支援，Serverless 友好
- **對話狀態結構**：支援多意圖平行操作，避免流程干擾
- **上下文感知**：結合對話歷史補充缺失資訊，理解簡短回應

## 開發任務

### 里程碑 1：環境準備與基礎架構 (預估 3 天)

#### 任務 1：Redis 環境設定
- **描述**：設定 Redis 服務並配置連接
- **交付物**：
  - Redis 服務帳號與連接資訊
  - 環境變數配置文件更新
  - 連接測試腳本
- **工時**：0.5 天
- **前置依賴**：無
- **實作步驟**：
  1. 註冊 Upstash Redis 服務（推薦 Serverless 友好）
  2. 取得連接資訊並設定 `.env` 變數：
     ```bash
     REDIS_HOST=your-redis-host.upstash.io
     REDIS_PORT=6379
     REDIS_PASSWORD=your-redis-password
     REDIS_TLS=true
     ```
  3. 安裝依賴：`npm install ioredis`
  4. 建立測試腳本驗證連接：`tools/test-redis-connection.js`
- **驗收標準**：
  - ✅ Redis 連接成功並可執行 ping 命令
  - ✅ 環境變數正確載入
  - ✅ 連接測試腳本通過
- **測試要求**：
  - 測試連接穩定性（重複連接 10 次）
  - 測試基本讀寫操作
  - 測試 TTL 過期機制

#### 任務 2：ConversationManager 類實作
- **描述**：建立 Redis 版本的對話管理器
- **交付物**：
  - `src/services/ConversationManager.js`
  - `src/services/conversationManager.js` (單例包裝)
  - 健康檢查機制
- **工時**：1.5 天
- **前置依賴**：任務 1
- **實作步驟**：
  1. 實作 `ConversationManager` 類，包含：
     - Redis 連接管理與錯誤處理
     - 對話上下文的 CRUD 操作
     - TTL 管理（30分鐘滑動視窗）
     - 期待輸入狀態管理
  2. 實作單例模式包裝器
  3. 加入優雅關機處理
  4. 實作健康檢查方法
- **驗收標準**：
  - ✅ 可正確儲存和讀取對話狀態
  - ✅ TTL 機制正常運作（30分鐘後自動清理）
  - ✅ 連接失敗時優雅降級
  - ✅ 支援期待輸入設定與清除
- **測試要求**：
  - 單元測試：各方法的功能測試
  - 整合測試：與 Redis 的實際操作
  - 壓力測試：併發操作穩定性

#### 任務 3：操作性意圖定義
- **描述**：擴展意圖規則支援確認、修改、取消操作
- **交付物**：
  - 更新 `config/intent-rules.yaml`
  - 新增操作性意圖處理邏輯
- **工時**：1 天
- **前置依賴**：無（可平行進行）
- **實作步驟**：
  1. 在 `intent-rules.yaml` 新增操作性意圖：
     - `confirm_action`：確認、好、沒錯等
     - `modify_action`：修改、更改、調整等
     - `cancel_action`：取消、不要了、算了等
  2. 設定高優先級（priority: 15）
  3. 標記需要上下文（context_required: true）
  4. 加入 payload 回退支援
- **驗收標準**：
  - ✅ 新意圖可正確匹配對應關鍵詞
  - ✅ 優先級設定正確，不會被其他意圖誤判
  - ✅ 意圖規則通過驗證測試
- **測試要求**：
  - 關鍵詞匹配測試
  - 優先級衝突測試
  - 邊界情況測試（類似詞彙）

### 里程碑 2：上下文感知意圖解析 (預估 2 天)

#### 任務 4：上下文感知的 parseIntent 升級
- **描述**：修改意圖解析邏輯，支援上下文感知和 Quick Reply payload
- **交付物**：
  - 更新 `src/intent/parseIntent.js`
  - 新增 `parseIntentWithContext()` 函式
  - Quick Reply payload 處理邏輯
- **工時**：1.5 天
- **前置依賴**：任務 2, 3
- **實作步驟**：
  1. 修改 `parseIntent.js`：
     - 新增 `parseIntentWithContext(message, userId, event)` 函式
     - 支援 postback 事件的 payload 解析
     - 根據期待輸入推斷意圖
  2. 實作上下文推理邏輯：
     - 檢查期待輸入類型
     - 根據對話流程狀態推斷意圖
     - 處理肯定/否定性回應
  3. 加入操作性意圖驗證機制
- **驗收標準**：
  - ✅ 可正確解析 Quick Reply 的 postback 資料
  - ✅ 根據期待輸入正確推斷意圖
  - ✅ 操作性意圖只在有效上下文時觸發
  - ✅ 降級處理機制正常運作
- **測試要求**：
  - 各種 postback 格式測試
  - 上下文推理準確性測試
  - 邊界情況處理測試

#### 任務 5：上下文補充的 extractSlots 升級
- **描述**：修改 slot 提取邏輯，支援從對話上下文補充缺失資訊
- **交付物**：
  - 更新 `src/intent/extractSlots.js`
  - 新增 `extractSlotsWithContext()` 函式
  - 實體匹配與歧義消除邏輯
- **工時**：0.5 天
- **前置依賴**：任務 4
- **實作步驟**：
  1. 建立 `extractSlotsWithContext()` 函式
  2. 從對話上下文的 `mentionedEntities` 補充資訊：
     - 學生名稱（取最近提及）
     - 課程名稱（智慧匹配）
     - 日期時間（上下文相關）
  3. 標記資訊來源（`_fromContext` 標記）
  4. 實作歧義消除邏輯
- **驗收標準**：
  - ✅ 可正確從上下文補充缺失的 slots
  - ✅ 標記補充資訊的來源
  - ✅ 處理多個候選實體的歧義
  - ✅ 不覆蓋用戶明確提供的資訊
- **測試要求**：
  - 各種補充情境測試
  - 歧義處理準確性測試
  - 來源標記正確性測試

### 里程碑 3：Quick Reply 整合與操作處理 (預估 2 天)

#### 任務 6：操作性意圖處理函式
- **描述**：實作確認、修改、取消操作的具體處理邏輯
- **交付物**：
  - `src/tasks/handle_action_intent.js`
  - 各種操作的處理流程
  - Quick Reply 生成邏輯
- **工時**：1 天
- **前置依賴**：任務 4, 5
- **實作步驟**：
  1. 建立 `handle_action_intent.js`：
     - `handleConfirmAction()`：執行確認邏輯
     - `handleModifyAction()`：進入修改流程
     - `handleCancelAction()`：取消操作
  2. 實作 Quick Reply 生成函式：
     - `createPostbackQuickReply()`
     - 動態生成按鈕與 payload
  3. 整合對話狀態更新
- **驗收標準**：
  - ✅ 確認操作正確完成任務
  - ✅ 修改操作進入正確流程
  - ✅ 取消操作清除狀態
  - ✅ Quick Reply 按鈕正確生成
- **測試要求**：
  - 各操作類型功能測試
  - Quick Reply 按鈕互動測試
  - 狀態轉換正確性測試

#### 任務 7：webhook.js 整合對話管理
- **描述**：修改主要的訊息處理流程，整合對話管理器
- **交付物**：
  - 更新 `src/bot/webhook.js`
  - 新增 `handleTextMessageWithContext()` 函式
  - 操作性意圖路由邏輯
- **工時**：1 天
- **前置依賴**：任務 6
- **實作步驟**：
  1. 修改 `handleTextMessage()`：
     - 載入對話上下文
     - 使用上下文感知的意圖解析
     - 處理操作性意圖路由
  2. 實作 `handleActionIntent()` 路由器
  3. 更新對話上下文記錄邏輯
  4. 整合 Quick Reply 回覆機制
- **驗收標準**：
  - ✅ 對話上下文正確載入和更新
  - ✅ 操作性意圖正確路由到處理函式
  - ✅ Quick Reply 按鈕正常顯示和運作
  - ✅ 原有功能不受影響
- **測試要求**：
  - 完整對話流程測試
  - 各種操作情境測試
  - 回歸測試確保原功能正常

### 里程碑 4：優化與邊界處理 (預估 1.5 天)

#### 任務 8：錯誤處理與降級機制
- **描述**：實作完善的錯誤處理，確保系統穩定性
- **交付物**：
  - Redis 連接失敗處理
  - 對話上下文遺失處理
  - 超時和異常情況處理
- **工時**：0.5 天
- **前置依賴**：任務 7
- **實作步驟**：
  1. 實作 Redis 連接失敗降級：
     - 檢測連接狀態
     - 優雅降級為無狀態處理
     - 記錄錯誤但不中斷服務
  2. 處理對話上下文遺失：
     - 檢測無效上下文
     - 提示用戶重新開始
     - 清理無效狀態
  3. 超時處理：
     - 自動清理過期對話
     - 適當的錯誤訊息
- **驗收標準**：
  - ✅ Redis 故障時系統仍可基本運作
  - ✅ 上下文遺失時有適當提示
  - ✅ 超時情況得到妥善處理
  - ✅ 錯誤日誌完整記錄
- **測試要求**：
  - Redis 斷線模擬測試
  - 對話超時測試
  - 異常情況恢復測試

#### 任務 9：監控與日誌優化
- **描述**：加入必要的監控指標和詳細日誌
- **交付物**：
  - 對話狀態監控指標
  - 詳細的操作日誌
  - 性能監控點
- **工時**：0.5 天
- **前置依賴**：任務 8
- **實作步驟**：
  1. 加入關鍵監控點：
     - 對話創建/更新/刪除
     - Quick Reply 點擊統計
     - 上下文命中率
  2. 優化日誌輸出：
     - 結構化日誌格式
     - 關鍵操作追蹤
     - 錯誤堆疊記錄
  3. 性能監控：
     - Redis 操作延遲
     - 對話處理時間
- **驗收標準**：
  - ✅ 關鍵操作有完整日誌
  - ✅ 監控指標可正常收集
  - ✅ 性能瓶頸可識別
  - ✅ 日誌格式統一且易讀
- **測試要求**：
  - 日誌輸出格式測試
  - 監控指標準確性測試
  - 日誌效能影響測試

#### 任務 10：整合測試與文檔
- **描述**：進行完整的整合測試並更新相關文檔
- **交付物**：
  - 完整的測試場景驗證
  - 更新操作說明文檔
  - 性能基準測試報告
- **工時**：0.5 天
- **前置依賴**：任務 9
- **實作步驟**：
  1. 執行完整測試場景：
     - 基本 Quick Reply 流程
     - 修改操作流程
     - 上下文補充測試
     - 平行意圖處理
     - 圖片上傳與上下文關聯
  2. 性能基準測試：
     - 記憶體使用情況
     - 回應時間測試
     - 併發處理能力
  3. 更新文檔：
     - 新功能使用說明
     - 配置指南更新
     - 故障排除指南
- **驗收標準**：
  - ✅ 所有測試場景通過
  - ✅ 性能指標達到預期
  - ✅ 文檔準確且完整
  - ✅ 功能可正常部署使用
- **測試要求**：
  - 端到端功能測試
  - 負載測試（模擬多用戶）
  - 文檔準確性驗證

## 里程碑追蹤

### 關鍵路徑
```
任務1 → 任務2 → 任務4 → 任務5 → 任務6 → 任務7 → 任務8 → 任務9 → 任務10
      ↗ 任務3 ↙
```

### 里程碑檢查點

#### 🎯 里程碑 1 完成標準 (第 3 天結束)
- [ ] Redis 連接穩定運作
- [ ] ConversationManager 基礎功能完整
- [ ] 操作性意圖可正確匹配
- [ ] **交付物**：基礎架構完成，可儲存和讀取對話狀態

#### 🎯 里程碑 2 完成標準 (第 5 天結束)
- [ ] 上下文感知意圖解析運作
- [ ] Quick Reply payload 正確處理
- [ ] Slot 補充機制正常
- [ ] **交付物**：智慧意圖理解功能完成

#### 🎯 里程碑 3 完成標準 (第 7 天結束)
- [ ] Quick Reply 按鈕完全可用
- [ ] 確認/修改/取消操作正常
- [ ] webhook 整合完成
- [ ] **交付物**：完整多輪對話功能運作

#### 🎯 里程碑 4 完成標準 (第 8.5 天結束)
- [ ] 錯誤處理機制完善
- [ ] 監控和日誌系統就緒
- [ ] 所有測試場景通過
- [ ] **交付物**：生產就緒的多輪對話系統

## 測試場景清單

### 核心場景測試
1. **基本 Quick Reply 測試**
   ```
   用戶：小明今天下午3點數學課
   Bot：已安排... [確認][修改][取消]
   用戶：確認 ← 點擊按鈕
   Bot：✅ 課程已確認儲存
   ```

2. **修改流程測試**
   ```
   用戶：小明今天下午3點數學課
   Bot：已安排... [確認][修改][取消]
   用戶：修改 ← 點擊按鈕
   Bot：請問您要修改什麼？
   用戶：改成4點
   Bot：已更新為4點 [確認][取消]
   ```

3. **上下文補充測試**
   ```
   用戶：小明今天有什麼課？
   Bot：小明今天有數學課(15:00)和英文課(17:00)
   用戶：記錄數學課的內容 ← 系統理解是記錄數學課
   Bot：請輸入數學課的學習內容
   ```

4. **平行意圖處理測試**
   ```
   用戶：小明今天下午3點數學課
   Bot：已安排... [確認][修改][取消]
   用戶：記錄昨天英文課很棒 ← 新任務
   Bot：已記錄英文課內容
   用戶：確認 ← 應該確認數學課，非英文課
   Bot：✅ 已確認數學課安排
   ```

### 邊界情況測試
- Redis 連接失敗情況
- 對話超時處理
- 無效操作請求
- 歧義實體消除
- 併發用戶處理

## 部署與驗收

### 部署前檢查清單
- [ ] 所有環境變數正確設定
- [ ] Redis 連接測試通過
- [ ] 單元測試覆蓋率 > 80%
- [ ] 整合測試全部通過
- [ ] 性能基準測試達標
- [ ] 錯誤處理機制驗證
- [ ] 監控指標正常收集

### 上線後驗收標準
- [ ] Quick Reply 可用率 > 95%
- [ ] 上下文理解準確率 > 90%
- [ ] 平均對話輪數減少 30%
- [ ] "聽不懂"回應減少 50%
- [ ] 系統回應時間 < 2 秒
- [ ] Redis 連接穩定率 > 99%

---

**預估總工時**：8.5 天  
**關鍵里程碑**：4 個  
**核心交付物**：多輪對話功能完整運作的 LINE Bot  
**技術棧**：Node.js + Redis + LINE Messaging API  

**下一步建議**：完成此任務後，建議執行 `@jw-coder 執行 multi-dialogue 功能開發`