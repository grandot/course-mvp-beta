# 多輪對話意圖識別測試文檔

**目的**：系統性測試補充資訊時的意圖識別準確性  
**方法**：第一性原則分析 + 邊界情況測試  
**重點**：確保補充資訊不被誤判為新意圖

---

## 🎯 測試原理（第一性原則）

### 核心問題
多輪對話中，使用者的第二輪輸入本質上有兩種可能：
1. **補充資訊**：對之前意圖的實體填充（例如：提供缺失的學生名稱）
2. **新意圖**：開始全新的任務（例如：從查詢課程轉為新增課程）

系統必須基於上下文正確區分這兩種情況。

### 判斷邏輯
```
如果 (上下文存在 && 當前輸入可以填充缺失slots) {
    → 識別為補充資訊，沿用原意圖
} else if (上下文存在 && 當前輸入包含明確新意圖關鍵詞) {
    → 識別為新意圖，清空上下文
} else {
    → 根據正常規則判斷意圖
}
```

---

## 📋 測試案例分類

### A. 基礎補充資訊測試
測試各種缺失欄位的補充是否正確識別

### B. 歧義情況測試  
測試同樣輸入在不同上下文下的意圖識別

### C. 邊界與錯誤測試
測試超時、錯誤輸入、上下文衝突等情況

### D. 複雜情境測試
測試真實使用中的複雜對話流程

---

## 🧪 A. 基礎補充資訊測試

### A1. 新增課程 (add_course) - 補充測試

#### A1.1 缺失學生名稱
```
第一輪：
用戶: "明天下午3點有數學課"
系統: "請問是哪位學生的數學課？" 
上下文: {intent: "add_course", slots: {courseName: "數學課", courseDate: "明天", scheduleTime: "15:00"}}

第二輪測試：
用戶: "小明"
期望結果: ✅ 沿用 add_course 意圖，補充 studentName: "小明"
錯誤結果: ❌ 識別為新意圖或無法識別
```

#### A1.2 缺失課程名稱  
```
第一輪：
用戶: "小明明天下午3點有課"
系統: "請問是什麼課程？"
上下文: {intent: "add_course", slots: {studentName: "小明", courseDate: "明天", scheduleTime: "15:00"}}

第二輪測試：
用戶: "英文課"  
期望結果: ✅ 沿用 add_course 意圖，補充 courseName: "英文課"
錯誤結果: ❌ 被誤判為 query_schedule 或其他意圖
```

#### A1.3 缺失時間資訊
```
第一輪：
用戶: "小明明天要上英文課"
系統: "請問什麼時候上課？"
上下文: {intent: "add_course", slots: {studentName: "小明", courseName: "英文課", courseDate: "明天"}}

第二輪測試組：
用戶: "下午4點"     → 期望: ✅ 補充 scheduleTime: "16:00"
用戶: "4:30PM"      → 期望: ✅ 補充 scheduleTime: "16:30" 
用戶: "晚上8點半"   → 期望: ✅ 補充 scheduleTime: "20:30"
```

#### A1.4 缺失日期資訊
```
第一輪：
用戶: "小明下午3點有數學課"
系統: "請問是哪一天？"
上下文: {intent: "add_course", slots: {studentName: "小明", courseName: "數學課", scheduleTime: "15:00"}}

第二輪測試組：
用戶: "明天"       → 期望: ✅ 補充 courseDate: "tomorrow"
用戶: "週三"       → 期望: ✅ 補充 courseDate: "wednesday"
用戶: "8月10日"    → 期望: ✅ 補充 courseDate: "2025-08-10"
```

### A2. 查詢課程 (query_schedule) - 補充測試

#### A2.1 缺失學生名稱
```
第一輪：
用戶: "今天有什麼課？"
系統: "請問要查詢哪位學生的課程？"
上下文: {intent: "query_schedule", slots: {courseDate: "今天"}}

第二輪測試：
用戶: "小明"
期望結果: ✅ 沿用 query_schedule 意圖，補充 studentName: "小明"
錯誤結果: ❌ 識別為 add_course 或其他意圖
```

#### A2.2 缺失日期範圍
```
第一輪：
用戶: "小明有什麼課？"
系統: "請問要查詢哪一天的課程？"
上下文: {intent: "query_schedule", slots: {studentName: "小明"}}

第二輪測試組：
用戶: "今天"       → 期望: ✅ 補充 courseDate: "today"
用戶: "這週"       → 期望: ✅ 補充 dateRange: "this_week" 
用戶: "下個月"     → 期望: ✅ 補充 dateRange: "next_month"
```

### A3. 記錄內容 (record_content) - 補充測試

#### A3.1 缺失目標課程
```
第一輪：
用戶: "今天學了分數的加減法"
系統: "請問這是哪門課的內容？"
上下文: {intent: "record_content", slots: {courseContent: "學了分數的加減法", courseDate: "今天"}}

第二輪測試：
用戶: "數學課"
期望結果: ✅ 沿用 record_content 意圖，補充 courseName: "數學課"
錯誤結果: ❌ 被誤判為 add_course 或 query_schedule
```

#### A3.2 缺失學生資訊
```
第一輪：
用戶: "今天數學課學了分數"
系統: "請問是哪位學生的數學課？"
上下文: {intent: "record_content", slots: {courseName: "數學課", courseContent: "學了分數", courseDate: "今天"}}

第二輪測試：
用戶: "小明"
期望結果: ✅ 沿用 record_content 意圖，補充 studentName: "小明"
```

---

## 🔀 B. 歧義情況測試

### B1. 同樣輸入，不同上下文

#### B1.1 「數學課」的多重含義
```
情境1 - 查詢上下文：
用戶1: "今天有什麼課？"
系統: "請問是哪門課程？"
用戶2: "數學課"
期望: ✅ 沿用 query_schedule，查詢數學課

情境2 - 新增上下文：
用戶1: "小明明天下午3點有課"
系統: "請問是什麼課程？"
用戶2: "數學課" 
期望: ✅ 沿用 add_course，補充課程名稱

情境3 - 記錄上下文：
用戶1: "今天小明學了很多內容"
系統: "請問是哪門課的內容？"
用戶2: "數學課"
期望: ✅ 沿用 record_content，指定目標課程
```

#### B1.2 時間表達的歧義
```
情境1 - 新增課程上下文：
用戶1: "小明明天要上英文課"
系統: "請問什麼時候？"
用戶2: "下午3點"
期望: ✅ 沿用 add_course，補充時間

情境2 - 修改課程上下文：
用戶1: "修改小明的英文課時間"
系統: "請問要改成什麼時間？"
用戶2: "下午3點"
期望: ✅ 沿用 modify_course，更新時間
```

### B2. 邊界歧義測試

#### B2.1 強歧義情況（需要上下文消岐）
```
第一輪：
用戶: "小明"
系統期望: ❌ 應該回覆「我不太理解，請提供更多資訊」
而非強行猜測意圖

第二輪測試情境：
前置上下文1: {intent: "query_schedule", missing: ["studentName"]}
用戶: "小明" → 期望: ✅ 補充學生名稱進行查詢

前置上下文2: {intent: "add_course", missing: ["studentName"]}  
用戶: "小明" → 期望: ✅ 補充學生名稱建立課程

前置上下文3: 無上下文
用戶: "小明" → 期望: ✅ 要求更多資訊
```

---

## 🚧 C. 邊界與錯誤測試

### C1. 上下文超時測試
```
測試場景：上下文30分鐘超時機制

第一輪：
用戶: "明天下午3點有數學課"
系統: "請問是哪位學生？"
上下文: {intent: "add_course", ...}

[等待31分鐘]

第二輪：
用戶: "小明"
期望結果: ✅ 識別為新會話開始，要求完整資訊
錯誤結果: ❌ 仍嘗試使用過期上下文
```

### C2. 上下文衝突測試
```
測試場景：使用者在等待補充資訊時發起新意圖

第一輪：
用戶: "明天下午3點有數學課"
系統: "請問是哪位學生？"
上下文: {intent: "add_course", ...}

第二輪：
用戶: "查詢今天的課表"
期望結果: ✅ 清空舊上下文，處理新的 query_schedule 意圖
錯誤結果: ❌ 嘗試將「查詢今天的課表」當作學生名稱
```

### C3. 無效輸入處理
```
第一輪：
用戶: "小明明天下午有課"
系統: "請問是什麼課程？"
上下文: {intent: "add_course", missing: ["courseName"]}

第二輪無效輸入測試：
用戶: "abc123!@#"  → 期望: ✅ 要求重新輸入課程名稱
用戶: ""            → 期望: ✅ 要求提供課程名稱
用戶: "😊"          → 期望: ✅ 解釋需要課程名稱文字
```

### C4. 多實體混合輸入
```
第一輪：
用戶: "明天有課"
系統: "請提供學生名稱和課程名稱"
上下文: {intent: "add_course", missing: ["studentName", "courseName"]}

第二輪混合輸入測試：
用戶: "小明的數學課"  → 期望: ✅ 同時補充兩個欄位
用戶: "小明上英文"    → 期望: ✅ 解析出學生和課程
用戶: "小明 英文課"   → 期望: ✅ 空格分隔的多實體識別
```

---

## 🎭 D. 複雜情境測試

### D1. Quick Reply 按鈕測試

#### D1.1 確認操作
```
第一輪：
用戶: "小明明天下午3點數學課"
系統: "✅ 已安排小明明天15:00上數學課
      [確認] [修改] [取消]"
上下文: {intent: "add_course", lastAction: {...}, expectingConfirmation: true}

第二輪 Quick Reply 測試：
用戶: "確認"     → 期望: ✅ confirm_action 意圖，執行課程建立
用戶: "修改"     → 期望: ✅ modify_action 意圖，進入修改流程  
用戶: "取消"     → 期望: ✅ cancel_action 意圖，取消操作
```

#### D1.2 修改操作子流程
```
承上例，用戶選擇「修改」：

第二輪：
用戶: "修改"
系統: "請問要修改什麼？時間、課程或學生？"
上下文: {intent: "modify_action", originalData: {...}}

第三輪修改子項目測試：
用戶: "時間"     → 期望: ✅ 進入時間修改流程
用戶: "改時間"   → 期望: ✅ 同上，自然語言理解
用戶: "課程"     → 期望: ✅ 進入課程修改流程
用戶: "學生"     → 期望: ✅ 進入學生修改流程

第四輪具體修改測試：
前置: 選擇修改時間
用戶: "改成下午4點"  → 期望: ✅ 更新時間為16:00
用戶: "4:30"        → 期望: ✅ 更新時間為16:30
```

### D2. 糾錯場景測試

#### D2.1 立即糾錯
```
第一輪：
用戶: "小明明天下午3點數學課"
系統: "✅ 已安排小明明天15:00上數學課"

第二輪糾錯：
用戶: "不對，是4點"
期望結果: ✅ correction_intent，修改時間為16:00
錯誤結果: ❌ 被判斷為新的 add_course 或其他意圖
```

#### D2.2 延遲糾錯  
```
第一輪：
用戶: "小明明天下午3點數學課"
系統: "✅ 已安排小明明天15:00上數學課"

[5分鐘後]

第二輪：
用戶: "剛才的時間錯了，改成4點"
期望結果: ✅ 基於課程查找 + 時間修改
測試重點: 檢查系統是否能關聯到5分鐘前的課程
```

### D3. 多學生管理測試

#### D3.1 學生混淆場景
```
背景：用戶有兩個孩子：小明、小華

第一輪：
用戶: "明天下午3點有數學課"
系統: "您有兩個孩子（小明、小華），請問是誰的課程？"
上下文: {intent: "add_course", ambiguousStudents: ["小明", "小華"]}

第二輪學生指定：
用戶: "小明"     → 期望: ✅ 為小明建立課程
用戶: "小華的"   → 期望: ✅ 為小華建立課程  
用戶: "兩個都有" → 期望: ✅ 進入批量建立流程
```

#### D3.2 跨學生資訊引用
```
第一輪：
用戶: "查詢小明今天的課程"
系統: "小明今天有：15:00 數學課"

第二輪：
用戶: "小華也要加這堂課"
期望結果: ✅ 為小華新增同樣的數學課
測試重點: 是否能正確引用小明課程的時間和課名
```

---

## ⚡ 效能與可靠性測試

### E1. Redis 連接測試
```
測試場景：Redis 服務暫時不可用

第一輪：
用戶: "小明明天下午3點數學課"
系統正常回應並建立上下文

[Redis 連接中斷]

第二輪：
用戶: "確認"
期望結果: ✅ 降級處理，要求用戶重新提供完整資訊
錯誤結果: ❌ 系統錯誤或無回應
```

### E2. 併發處理測試
```
測試場景：同一用戶快速連續發送消息

用戶快速發送：
消息1: "小明明天"（0秒）
消息2: "下午3點"（0.5秒）  
消息3: "數學課"（1秒）

期望結果: ✅ 系統能正確處理和合併資訊
錯誤結果: ❌ 產生多個衝突的上下文
```

### E3. 大量上下文測試
```
測試場景：單一用戶長時間對話

模擬30分鐘內進行50次對話交互
測試重點：
- 上下文是否正確更新
- 記憶體使用是否合理
- 回應時間是否穩定
```

---

## 📊 測試執行指南

### 測試環境設定
```bash
# 1. 確保 Redis 連接正常
redis-cli ping

# 2. 設定測試環境變數  
export NODE_ENV=test
export ENABLE_DEBUG_LOGS=true

# 3. 啟動測試模式
npm run test:multi-dialogue
```

### 測試工具使用
```bash
# 使用測試工具發送消息
node tools/send-test-message.js "小明明天下午3點數學課"

# 檢查上下文狀態
node tools/check-conversation-state.js USER_ID

# 重置特定用戶上下文
node tools/reset-user-context.js USER_ID
```

### 成功標準

#### A級（必須通過）
- [ ] 基礎補充資訊識別準確率 ≥ 95%
- [ ] Quick Reply 確認操作準確率 = 100%
- [ ] 上下文超時機制正確運作

#### B級（重要指標）  
- [ ] 歧義情況處理準確率 ≥ 90%
- [ ] 糾錯操作識別準確率 ≥ 85%
- [ ] 多學生場景處理準確率 ≥ 90%

#### C級（優化目標）
- [ ] 複雜情境處理準確率 ≥ 80%
- [ ] 效能測試：回應時間 < 2秒
- [ ] 錯誤恢復：服務中斷後正常降級

---

## 🔧 問題排查指南

### 常見問題模式

#### 1. 補充資訊被誤判為新意圖
**症狀**: 用戶提供學生名稱，系統回應「我不理解」
**可能原因**:
- 上下文未正確儲存到 Redis  
- intent-rules.yaml 規則衝突
- extractSlots.js 實體提取邏輯錯誤

**排查步驟**:
```bash
# 檢查上下文
redis-cli get "conversation:USER_ID"

# 檢查意圖識別日誌
grep "Intent detected" logs/app.log

# 測試特定規則
node tools/test-intent-rule.js "小明" --context="add_course"
```

#### 2. Quick Reply 按鈕無回應
**症狀**: 用戶點擊確認，系統無反應
**可能原因**:
- confirm_action 規則優先級設定錯誤
- 上下文中缺少 expectingConfirmation 標記
- webhook.js 中 Quick Reply 處理邏輯問題

#### 3. 上下文管理異常
**症狀**: 對話狀態混亂或意外清空
**可能原因**:
- Redis TTL 設定過短
- 併發請求造成競爭條件
- 錯誤處理中意外清空上下文

---

## 📈 測試報告模板

### 執行紀錄
```
測試執行時間: YYYY-MM-DD HH:mm:ss
測試環境: 開發/測試/生產
Redis 版本: x.x.x
Node.js 版本: x.x.x

總測試案例: XXX 個
通過案例: XXX 個  
失敗案例: XXX 個
通過率: XX.X%
```

### 失敗案例詳情
```
測試ID: A1.1.001
描述: 新增課程缺失學生名稱補充測試
輸入: "小明"
預期: 沿用 add_course 意圖
實際: 識別為 unknown_intent
原因: [分析結果]
修復建議: [具體建議]
```

### 效能指標
```
平均回應時間: XXX ms
P95 回應時間: XXX ms  
Redis 連接數: XXX
記憶體使用峰值: XXX MB
錯誤率: X.XX%
```

---

**撰寫者**: Claude Code AI Assistant  
**文檔版本**: 1.0  
**最後更新**: 2025-08-07  
**適用版本**: 課程管理機器人 v1.2.1+

*此測試文檔基於第一性原則分析設計，涵蓋多輪對話意圖識別的關鍵情境和邊界條件，確保系統在各種複雜情況下都能正確識別使用者意圖。*