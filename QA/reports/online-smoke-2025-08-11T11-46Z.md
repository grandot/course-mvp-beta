### 線上冒煙測試（Render）詳細報告 - 2025-08-11 11:46Z

— 本報告針對剛才執行的最小冒煙（render-suite --basic）逐條收錄，重點在「人能看懂」的真實行為對照 —

## 環境與設定
- 目標：`https://course-mvp-beta.onrender.com`
- 啟用：`ENABLE_AI_FALLBACK=true`
- 決策管線：Safety → AI 主判 → 簡單規則兜底 →（必要時）規則回退
- AI 參數（程式內預設）：`AI_FALLBACK_MIN_CONFIDENCE=0.6`、`AI_FALLBACK_TIMEOUT_MS=900`
- 備註：stateless 未啟用；診斷已啟用（伺服器端）。

## 總結
- 本機對照（基線）：28 測試，通過 26，失敗 2（93%）
- 線上本輪：28 測試，通過 3，失敗 25（11%）
- 主要失敗型態：
  - 模糊句多落到「查表」而非澄清/導引
  - 記錄/提醒經常被誤導到查表或其他意圖
  - 複合句（先新增再查詢）缺少分步處理
  - 部分文案與測試期望不一致（例如需要具體關鍵詞）

## 前置快照（非線上請求）
- 套件在「正式打 Render 前」會印出課表格式示例，驗證渲染與去重；非線上實測，僅作對照。

## 詳細案例逐條

1) A1.1-A 新增單次課程（標準格式）
- 輸入：小明明天下午2點要上數學課
- HTTP：200
- 回覆：`✅ 課程已暫存成功（日曆稍後同步）！`
- 判定：PASS（語義對齊）
- 備註：新增邏輯正常

2) A1.3-C 模糊語句（意圖不明）
- 輸入：我想要什麼時候上課來著
- 回覆：`📅 所有學生未來7天的課表`
- 判定：FAIL（應先澄清/導引，而非直接查表）
- 可能原因：模糊句落入查詢兜底

3) A3.1-A 意圖邊界（查詢/新增分流）
- 輸入：我想了解一下課程安排的情況
- 回覆：`📅 所有學生未來7天的課表`
- 判定：FAIL（應提供查詢/新增導引）
- 可能原因：泛查詢詞被解讀為查表

4) A3.1-B 複合意圖處理（先新增再查詢）
- 輸入：幫我安排小明數學課，然後查一下他今天有什麼課
- 回覆：`📅 小明今天的課表`
- 判定：FAIL（應拆解為兩步或回「一次一件事」）

5) A3.2-A 系統錯誤恢復（提供導引）
- 輸入：（觸發系統錯誤的占位輸入）
- 回覆：`📅 我本週沒有安排課程`
- 判定：FAIL（應回「導引」而非查表空結果）

6) A3.2-B 輸入修正流程（無效→更正）
- 步驟：
  - 1/2：小明明天25點上課
  - 2/2：下午2點
- 回覆：`😊 不太理解您的意思，試試這些功能：`
- 判定：FAIL（應完成修正後進入新增確認）

7) B1.1-A 今日課程查詢
- 輸入：小明今天有什麼課？
- 回覆：`📅 小明今天的課表`
- 判定：PASS

8) B1.1-B 明日課程查詢
- 輸入：查詢Lumi明天的課表
- 回覆：`❓ 請問要查哪位學生的課表？`
- 判定：FAIL（應直接識別 Lumi；目前走多候選澄清流程）

9) B1.1-C 本週課程查詢（含重複課）
- 輸入：看一下小光這週的安排
- 回覆：`📅 小明今天的課表`
- 判定：FAIL（學生誤判/串台）

10) B1.2-A 無課程日查詢（空結果）
- 輸入：小王今天有什麼課？
- 回覆：`📅 小王今天沒有安排課程`
- 判定：PASS

11) B1.3-A 特定課程查詢（篩選）
- 輸入：小明的數學課什麼時候上？
- 回覆：`📅 小明本週的課表`
- 判定：FAIL（應回具體「時間」或列出數學課時段）

12) B1.3-B 每日重複課程查詢
- 輸入：小明的晨練課每天幾點？
- 回覆：`📅 小明本週的課表`
- 判定：FAIL（應回固定時間）

13) B1.3-C 重複課類型識別查詢
- 輸入：查詢Lumi的重複課程
- 回覆：`📅 Lumi本週沒有安排課程`
- 判定：FAIL（應至少辨識有無重複規則）

14) B2.1-A 當日課程記錄（標準）
- 輸入：今天小明的數學課學了分數加減法
- 回覆：`📅 小明本週的課表`
- 判定：FAIL（應回內容記錄成功/補件，而非查表）

15) B2.1-B 昨日課程補記錄
- 輸入：補記一下昨天Lumi鋼琴課的內容，練習了小星星
- 回覆：`❌ 找不到 該學生 的 鋼琴課（日期：2025-08-10）。請先建立對應課程後再記錄內容。`
- 判定：FAIL（預期應提示具體缺少/建立引導；目前文案與期望不符）

16) B2.2-A 查詢課程記錄
- 輸入：小明昨天數學課學了什麼？
- 回覆：`📅 小明昨天的課表`
- 判定：FAIL（應回內容摘要或「尚無記錄」）

17) B2.3-A 不存在課程記錄（應提示）
- 輸入：記錄小明今天化學課的內容
- 回覆：`📅 小明今天沒有安排課程`
- 判定：FAIL（應回「找不到課程/請先新增」類提示）

18) B3.1-A 標準提醒設定
- 輸入：提醒我小明的數學課
- 回覆：`📅 小明昨天的課表`
- 判定：FAIL（應回提醒設定確認或缺件提示）

19) B3.1-B 自訂提醒時間
- 輸入：Lumi鋼琴課前1小時提醒我
- 回覆：`❌ 請提供學生姓名，例如：「提醒我小明的數學課」`
- 判定：FAIL（已給缺件提示，但與預期不符；應能識別 Lumi）

20) B3.2-A 不存在課程提醒
- 輸入：提醒我小明的物理課
- 回覆：`📅 小明今天沒有安排課程`
- 判定：FAIL（應回「找不到該課程」類提示）

21) C1.1-A 修改課程時間（功能待落地）
- 輸入：小明的數學課改到下午4點
- 回覆：`🛠️ 修改課程功能開發中，近期開放。請先使用「取消」後重新新增或直接重新安排。`
- 判定：FAIL（目前屬明確占位文案；測試期望不同）

22) C1.1-B 修改每日重複課時間（系列操作）
- 輸入：小明每天的晨練課改到早上7點
- 回覆：`❌ 請提供學生姓名，例如：「提醒我小明的數學課」`
- 判定：FAIL（誤落到提醒缺件文案）

23) C1.1-C 修改重複類型（週→日）
- 輸入：Lumi的鋼琴課改成每天下午3點
- 回覆：`🛠️ 修改課程功能開發中，近期開放。請先使用「取消」後重新新增或直接重新安排。`
- 判定：FAIL

24) C2.1-A 取消單次課程
- 輸入：取消小明明天的數學課
- 回覆：`🛠️ 修改課程功能開發中...`
- 判定：FAIL（誤路由到修改）

25) C2.1-B 取消每日重複課程（提供範圍選項）
- 輸入：取消小明的晨練課
- 回覆：`請問是要取消哪個範圍？`
- 判定：FAIL（測試期望關鍵詞未命中；功能本身有反饋）

26) C2.1-C 取消下週範圍（部分）
- 輸入：取消小明下週的晨練課
- 回覆：`📅 小明明天的課表`
- 判定：FAIL（誤落查表/錯週）

27) C2.1-D 類型區分取消（daily/weekly）
- 輸入：
  - 1/2：取消小明每天的晨練課
  - 2/2：取消Lumi每週三的鋼琴課
- 回覆：`❌ 請提供學生姓名，例如：「取消小明的數學課」`
- 判定：FAIL（誤缺件）

28) C3.1-A 併發處理測試
- 輸入：（同時多使用者發起課表查詢，應全部成功）
- 回覆：`📅 所有學生本週的課表`
- 判定：FAIL（測試期望判定不符）

## 問題歸類（高層）
- 分流：模糊句與複合句 → 偏向查表；應加澄清/拆解
- 記錄/提醒：缺 Gatekeeper 與統一錯誤碼文案 → 常被誤導到查表
- 學生識別：多候選澄清與串台問題 → 需會話鎖+更穩定姓名抽取
- 文案對齊：多案例為文案/關鍵詞不匹配 → 需標準化模板

## 建議修正（下一輪）
- 取消 webhook 查詢覆寫（保留提醒覆寫），避免壓過 AI 判定
- record_content / set_reminder 加 Gatekeeper（MISSING_STUDENT / NOT_FOUND / PAST_*）與模板化文案
- 補 `query_course_time` 或擴展查詢以回「具體時間」
- 姓名抽取與會話鎖一致化，避免串台
- 驗證 /debug/decision：統計 ai-primary 命中率

— 完 —


