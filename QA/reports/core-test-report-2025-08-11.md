## 核心測試報告（本機 vs 線上）— 2025-08-11

### 本輪重要改動
- 決策觀測：新增 `DecisionLogger` 與 `/debug/decision`，webhook 記錄 nlp/slots/task/render 全鏈。
- 查詢體驗：多位學生候選不猜，改為澄清選單（Quick Reply）。
- 渲染統一：查詢空結果固定「課表＋三條指引」，錯誤代碼模板化接入。
- 時區修正：查詢日期範圍改用 Asia/Taipei 計算，修復今天/明天偏移。

### 總結
- 本機結果：28 測試，通過 25，失敗 3（通過率 89%）
- 線上結果：28 測試，通過 3，失敗 25（通過率 11%）
- 差異主因：
  - 查詢/新增分流在「課程安排」等模糊詞仍有誤蓋（規則需收斂）。
  - 記錄/提醒/取消的 Gatekeeper 錯誤模板尚未全面統一（關鍵字對齊不足）。
  - 個別「今天」仍落到「明天」的案例（舊會話/上下文或快取干擾）。

### 詳細用例結果（線上）
以下列出每一個用例的線上回覆與判定；本機細目 runner 未逐條輸出，本機總結見上。

#### A1.1-A 新增單次課程（標準格式）
- 步驟：小明明天下午2點要上數學課
- 回覆（線上）：✅ 課程已暫存成功（日曆稍後同步）！
- 結果：PASS

#### A1.3-C 模糊語句（意圖不明）
- 步驟：我想要什麼時候上課來著
- 回覆（線上）：❓ 請提供以下資訊：學生姓名、上課時間、課程日期
- 結果：PASS

#### A3.1-A 意圖邊界（查詢/新增分流）
- 步驟：我想了解一下課程安排的情況
- 回覆（線上）：📅 我本週沒有安排課程
- 結果：FAIL（預期查詢導引）

#### A3.1-B 複合意圖處理（先新增再查詢）
- 步驟：幫我安排小明數學課，然後查一下他今天有什麼課
- 回覆（線上）：❓ 請提供以下資訊：學生姓名、上課時間、課程日期
- 結果：FAIL（應拆解/提示）

#### A3.2-A 系統錯誤恢復（提供導引）
- 步驟：（觸發系統錯誤的占位輸入）
- 回覆（線上）：❌ 目前不支援「correction_intent」功能，請稍後再試
- 結果：FAIL（應提供導引）

#### A3.2-B 輸入修正流程（無效→更正）
- 步驟：小明明天25點上課 → 下午2點
- 回覆（線上）：😊 不太理解您的意思，試試這些功能：
- 結果：FAIL（應進入校正確認）

#### B1.1-A 今日課程查詢
- 步驟：小明今天有什麼課？
- 回覆（線上）：📅 小明明天的課表
- 結果：FAIL（應為今天）

#### B1.1-B 明日課程查詢
- 步驟：查詢Lumi明天的課表
- 回覆（線上）：❓ 請問要查哪位學生的課表？
- 結果：FAIL（應直接回 Lumi 明天課表）

#### B1.1-C 本週課程查詢（含重複課）
- 步驟：看一下小光這週的安排
- 回覆（線上）：📅 小明今天的課表
- 結果：FAIL（學生串台）

#### B1.2-A 無課程日查詢（空結果）
- 步驟：小王今天有什麼課？
- 回覆（線上）：📅 小王今天沒有安排課程
- 結果：PASS

#### B1.3-A 特定課程查詢（篩選）
- 步驟：小明的數學課什麼時候上？
- 回覆（線上）：❓ 請提供以下資訊：課程名稱、上課時間、課程日期
- 結果：FAIL（應給出時間/或澄清最小欄位）

#### B1.3-B 每日重複課程查詢
- 步驟：小明的晨練課每天幾點？
- 回覆（線上）：📅 小王今天沒有安排課程
- 結果：FAIL（學生/課程對應錯誤）

#### B1.3-C 重複課類型識別查詢
- 步驟：查詢Lumi的重複課程
- 回覆（線上）：📅 Lumi本週沒有安排課程
- 結果：FAIL（應回重複設定或對應清單）

#### B2.1-A 當日課程記錄（標準）
- 步驟：今天小明的數學課學了分數加減法
- 回覆（線上）：📅 小明本週的課表
- 結果：FAIL（應記錄內容）

#### B2.1-B 昨日課程補記錄
- 步驟：補記一下昨天Lumi鋼琴課的內容，練習了小星星
- 回覆（線上）：❓ 請提供以下資訊：學生姓名
- 結果：FAIL（表面缺學生，但句中已有，抽取需收斂）

#### B2.2-A 查詢課程記錄
- 步驟：小明昨天數學課學了什麼？
- 回覆（線上）：📅 小明今天的課表
- 結果：FAIL（應回內容/摘要）

#### B2.3-A 不存在課程記錄（應提示）
- 步驟：記錄小明今天化學課的內容
- 回覆（線上）：📅 小明今天沒有安排課程
- 結果：FAIL（應回 NOT_FOUND 明確引導）

#### B3.1-A 標準提醒設定
- 步驟：提醒我小明的數學課
- 回覆（線上）：❓ 請提供以下資訊：學生姓名
- 結果：FAIL（應識別學生並提示提醒時間）

#### B3.1-B 自訂提醒時間
- 步驟：Lumi鋼琴課前1小時提醒我
- 回覆（線上）：❌ 請提供學生姓名，例如：「提醒我小明的數學課」
- 結果：FAIL（應正常設置 60 分鐘提醒）

#### B3.2-A 不存在課程提醒
- 步驟：提醒我小明的物理課
- 回覆（線上）：📅 小明今天沒有安排課程
- 結果：FAIL（應回 NOT_FOUND 明確課程不存在）

#### C1.1-A 修改課程時間（功能待落地）
- 步驟：小明的數學課改到下午4點
- 回覆（線上）：🛠️ 修改課程功能開發中，近期開放。
- 結果：FAIL（測試期望與占位文案未對齊）

#### C1.1-B 修改每日重複課時間（系列操作）
- 步驟：小明每天的晨練課改到早上7點
- 回覆（線上）：❌ 請提供學生姓名，例如：「提醒我小明的數學課」
- 結果：FAIL（誤入提醒分流）

#### C1.1-C 修改重複類型（週→日）
- 步驟：Lumi的鋼琴課改成每天下午3點
- 回覆（線上）：🛠️ 修改課程功能開發中，近期開放。
- 結果：FAIL（同上）

#### C2.1-A 取消單次課程
- 步驟：取消小明明天的數學課
- 回覆（線上）：🛠️ 修改課程功能開發中，近期開放。
- 結果：FAIL（誤分流）

#### C2.1-B 取消每日重複課程（提供範圍選項）
- 步驟：取消小明的晨練課
- 回覆（線上）：請問是要取消哪個範圍？（三選項）
- 結果：FAIL（關鍵詞比對未命中，但行為方向正確）

#### C2.1-C 取消下週範圍（部分）
- 步驟：取消小明下週的晨練課
- 回覆（線上）：📅 小明明天的課表
- 結果：FAIL（誤分流）

#### C2.1-D 類型區分取消（daily/weekly）
- 步驟：取消小明每天的晨練課；取消Lumi每週三的鋼琴課
- 回覆（線上）：❌ 請提供學生姓名，例如：「取消小明的數學課」
- 結果：FAIL（抽取與分流需收斂）

#### C3.1-A 併發處理測試
- 步驟：（同時多使用者發起課表查詢，應全部成功）
- 回覆（線上）：❌ 找不到 小明 的 晨練課，請確認課程是否存在
- 結果：FAIL（測試假資料/上下文干擾）

### 差異分析與修復計畫（重點）
- 規則收斂：提高 Query 關鍵詞權重；Add 需同時命中「要上/安排/新增 + 時間」；避免「課程安排」搶判。
- Gatekeeper 模板化：`record/reminder/cancel` 錯誤碼與文案統一（MISSING_*/NOT_FOUND/PAST_*）。
- 會話鎖/上下文：檢查 pinned 寫入時機；非查詢意圖忽略查詢會話鎖；避免跨句影響。
- 文案對齊：修改占位回覆與測試期望一致（或反向修正測試期望）。

### 產出與觀測
- 決策鏈：`/debug/decision?limit=50` 可查最近決策（含 intent/slots/code/render）。
- 健康檢查：`/health/deps` 檢查 Redis/Firebase/OpenAI/GCal；`/health/gcal` 單項連接。

### 附錄
- Runner 集計（本機/線上）與每案輸出皆來自本輪 `node tools/render-suite.js --basic` 實跑結果。
- 本機逐案細目 runner 未逐條輸出；如需我可以追加本機逐案跑並補錄細目版本。


