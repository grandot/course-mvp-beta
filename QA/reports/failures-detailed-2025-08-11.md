## 失敗用例詳解（人讀版）— 2025-08-11 本機 vs 線上

目標：讓人一眼看懂每個 FAIL「輸入是什麼、預期是什麼、實際回覆是什麼、為什麼錯、下一步怎麼改」。不講行話、不藏細節。

---

### 總覽
- 本機：45 條，用例通過 38、失敗 7（來自 `QA/reports/test-report-1754706982038.md`）。
- 線上：28 條，用例通過 3、失敗 25（最新 `render-suite --basic` 實跑輸出）。

---

## 線上 FAIL 詳解

### 1) A3.1-A 意圖邊界（查詢/新增分流）
- 輸入：我想了解一下課程安排的情況
- 預期：詢問式導引（先確認是「查課表」還是「新增」）或直接回「本週課表」。
- 實際：📅 我本週沒有安排課程
- 問題：把「我」當成學生，變成查「我」的課表，語意錯位。
- 根因（人話）：分類器看見「課程安排」就直接查了，但沒有辨識到「我」不是學生名。
- 修正方案：
  - Router/規則：含「課表/安排/查詢」且是問句，優先 `query_schedule`；「我/我們」不當學生名。
  - 槽位：學生缺省時，不要硬套「我」，先回澄清「要查哪位學生」。
  - 代碼：`src/nlu/IntentRouter.js`、`src/intent/extractSlots.js`

### 2) A3.1-B 複合意圖（先新增再查詢）
- 輸入：幫我安排小明數學課，然後查一下他今天有什麼課
- 預期：回「我一次只能處理一件事，請先提供新增所需的時間」，或拆成兩步。
- 實際：❓ 請提供以下資訊：學生姓名、上課時間、課程日期
- 問題：訊息太籠統，沒有說清「請先完成新增流程」。
- 根因：多意圖指令未被拆分；缺少「單次只處理一件事」的提示模板。
- 修正方案：Router 加合併語句仲裁，回固定提示；`ResponseRenderer` 提供明確引導。

### 3) A3.2-A 系統錯誤恢復（導引）
- 輸入：（觸發系統錯誤的占位輸入）
- 預期：友善導引（例如：請提供學生與課程，再示範一句正確格式）。
- 實際：❌ 目前不支援「correction_intent」功能，請稍後再試
- 問題：對一般使用者不可理解。「功能未開」不是解法。
- 根因：未知/錯誤流量被導向 `correction_intent` 的占位文案。
- 修正方案：未知/錯誤一律走 `unknown` 導引模板；`ResponseRenderer.renderError('UNKNOWN')`。

### 4) A3.2-B 輸入修正流程（無效→更正）
- 輸入：小明明天25點上課 → 下午2點
- 預期：先提示「時間無效」，二步更正後成功固定到 14:00。
- 實際：😊 不太理解您的意思，試試這些功能：
- 問題：沒有進入校正對話，直接丟通用引導。
- 根因：沒有建立「修正時間」的補充狀態；對第二句沒有在原意圖上下文補全。
- 修正方案：ConversationManager 設 `expectedInput=schedule_time_input`；補齊後回確認。

### 5) B1.1-A 今日課程查詢
- 輸入：小明今天有什麼課？
- 預期：📅 小明今天的課表 …
- 實際：📅 小明明天的課表
- 問題：天數偏移。
- 根因：日期/時區或會話鎖干擾。我們已修正 Asia/Taipei，但現象仍偶發。
- 修正方案：
  - 檢查會話鎖 TTL 與寫入時機，避免跨輪影響。
  - 日期計算已改 Asia/Taipei；再加日誌比對輸入/輸出時間戳。

### 6) B1.1-B 明日課程查詢
- 輸入：查詢Lumi明天的課表
- 預期：📅 Lumi明天的課表 …
- 實際：❓ 請問要查哪位學生的課表？
- 問題：明明有學生名，卻要求澄清。
- 根因：`findAllStudentCandidates` 抓到多個候選，導致「不猜」。
- 修正方案：若 `slots.studentName` 已確定，忽略多候選；候選只在缺學生時使用。

### 7) B1.1-C 本週課程查詢
- 輸入：看一下小光這週的安排
- 預期：📅 小光本週的課表 …
- 實際：📅 小明今天的課表
- 問題：學生串台。
- 根因：查詢會話鎖覆寫當句學生；或上下文自動補全誤用。
- 修正方案：Query 套 pinned 僅在當句無學生時；有學生就以當句為準。

### 8) B1.3-A 特定課程查詢
- 輸入：小明的數學課什麼時候上？
- 預期：回時間（如：下午2點），或最小澄清（日期區間）。
- 實際：❓ 請提供以下資訊：課程名稱、上課時間、課程日期
- 問題：把問「什麼時候」誤當缺欄位。
- 根因：缺「查課程時間」的意圖分流與處理器。
- 修正方案：新增 `query_course_time` 或在 `query_schedule` 支援「學生+課名→下次時間」。

### 9) B1.3-B 每日重複課程查詢
- 輸入：小明的晨練課每天幾點？
- 預期：回固定時間（例如：每天 8:00）。
- 實際：📅 小王今天沒有安排課程
- 問題：學生錯、語義錯。
- 根因：上下文污染或抽取錯誤；`每日/每天` 未驅動重複課查詢邏輯。
- 修正方案：抽取修正與 `query_schedule` 內建重複課時間摘要。

### 10) B1.3-C 重複課類型識別查詢
- 輸入：查詢Lumi的重複課程
- 預期：列出重複課類型與時間。
- 實際：📅 Lumi本週沒有安排課程
- 問題：把「類型查詢」誤做成「本週課表」。
- 修正方案：為含「重複/定期」的查詢提供專屬分支與格式化輸出。

### 11) B2.1-A 當日課程記錄
- 輸入：今天小明的數學課學了分數加減法
- 預期：成功記錄內容，或若無課則回 NOT_FOUND。
- 實際：📅 小明本週的課表
- 問題：記錄被誤分流到查詢。
- 根因：意圖判定缺「內容記錄優先」；Gatekeeper 未兜底。
- 修正方案：規則與 Gatekeeper 雙保，先判 `record_content`，缺課回 NOT_FOUND。

### 12) B2.1-B 昨日課程補記錄
- 輸入：補記一下昨天Lumi鋼琴課的內容，練習了小星星
- 預期：成功記錄（學生=Lumi、課=鋼琴課、內容=小星星）。
- 實際：❓ 請提供以下資訊：學生姓名
- 問題：學生抽取失敗。
- 修正方案：加強 `提醒/補記/記錄` 句型的人名提取與英文名長度；已部分放寬，需驗證。

### 13) B2.2-A 查詢課程記錄
- 輸入：小明昨天數學課學了什麼？
- 預期：回內容摘要或「沒有記錄」。
- 實際：📅 小明今天的課表
- 問題：誤分流到查課表。
- 修正方案：新增 `query_course_content` 快徑；`ResponseRenderer` 模板化輸出。

### 14) B2.3-A 不存在課程記錄（應提示）
- 輸入：記錄小明今天化學課的內容
- 預期：❌ 找不到 小明 的 化學課（日期：X/X）。請先新增。
- 實際：📅 小明今天沒有安排課程
- 問題：語意不精確；應回 NOT_FOUND 而非空課表。
- 修正方案：`record_content` 失敗路徑統一錯誤碼與文案。

### 15) B3.1-A 標準提醒設定
- 輸入：提醒我小明的數學課
- 預期：預設 30 分鐘提醒或澄清提醒時間。
- 實際：❓ 請提供以下資訊：學生姓名
- 問題：學生已在句中，卻判缺。
- 修正方案：調整 `提醒.*我.*?([名])的` 抽取；已放寬，需再驗證。

### 16) B3.1-B 自訂提醒時間
- 輸入：Lumi鋼琴課前1小時提醒我
- 預期：設置 60 分鐘提醒。
- 實際：❌ 請提供學生姓名，例如：「提醒我小明的數學課」
- 問題：英文名抽取失敗。
- 修正方案：已放寬英文名長度；增強英文優先規則。

### 17) B3.2-A 不存在課程提醒
- 輸入：提醒我小明的物理課
- 預期：❌ 找不到 小明 的 物理課（請先新增）。
- 實際：📅 小明今天沒有安排課程
- 問題：錯誤碼/文案不精確。
- 修正方案：`set_reminder` NOT_FOUND 模板化。

### 18) C1.1-A 修改課程時間
- 輸入：小明的數學課改到下午4點
- 預期：功能占位也需清楚敘述，或調整測試期望。
- 實際：🛠️ 修改課程功能開發中 …
- 問題：測試與占位未對齊；屬策略差異。
- 修正方案：在測試期望改為「功能開發中」，或先落最小可用改時間流程。

### 19) C1.1-B 修改每日重複課時間
- 輸入：小明每天的晨練課改到早上7點
- 預期：提供「修改所有/只修改今天」選項。
- 實際：❌ 請提供學生姓名 …（或誤分流到提醒）
- 問題：改→提醒/新增分流混亂。
- 修正方案：強化 `modify_course` 快徑與模板，避免落入其他意圖。

### 20) C1.1-C 修改重複類型（週→日）
- 輸入：Lumi的鋼琴課改成每天下午3點
- 實際：🛠️ 修改課程功能開發中 …
- 問題：同 C1.1-A。

### 21) C2.1-A 取消單次課程
- 輸入：取消小明明天的數學課
- 預期：已取消明天單次課。
- 實際：🛠️ 修改課程功能開發中 …
- 問題：誤分流到修改。
- 修正方案：`cancel_course` Safety 覆寫優先級最高；Router 收斂。

### 22) C2.1-B 取消每日重複課（範圍選項）
- 輸入：取消小明的晨練課
- 預期：三選項（只今天/明天起全部/刪除整個重複）。
- 實際：請問是要取消哪個範圍？（已正確）但測試關鍵詞比對未命中 → 判 FAIL。
- 修正方案：調整測試期望關鍵詞，或文案加上測試關鍵詞。

### 23) C2.1-C 取消下週範圍（部分）
- 輸入：取消小明下週的晨練課
- 實際：📅 小明明天的課表
- 問題：誤分流。
- 修正方案：Router 對「取消+時間參考」直達 cancel，避免被 query 搶走。

### 24) C2.1-D 類型區分取消（daily/weekly）
- 輸入：取消小明每天的晨練課；取消Lumi每週三的鋼琴課
- 實際：❌ 請提供學生姓名 …（第二步）
- 問題：抽取與分流雙重失敗。
- 修正方案：`cancel_course` 補齊學生/課名的抽取規則；多輪澄清。

### 25) C3.1-A 併發處理
- 輸入：（同時多使用者發起課表查詢）
- 預期：全部成功查表。
- 實際：❌ 找不到 小明 的 晨練課 …
- 問題：測試數據/上下文干擾導致。
- 修正方案：每輪測試加 `X-QA-Reset-Context: true`；建議測試前置數據清理。

---

## 本機 FAIL 詳解（取自 `test-report-1754706982038.md`）

### L1) A1.2-C 多輪對話完成流程
- 輸入：明天下午2點
- 預期：✅ 課程已安排成功！
- 實際：❓ 請提供以下資訊：學生姓名、課程名稱 …
- 問題：多輪補齊沒被觸發（缺 pending flow）。
- 修正：ConversationManager 設 `expectedInput` 並合併到原意圖。

### L2) A2.1-E 每月重複課程
- 輸入：小光每月第一個週一上午10點評鑑
- 預期：重複課排程成功
- 實際：❓ 請提供課程名稱 …
- 問題：課名抽取被時間詞干擾。
- 修正：`extractCourseName` 提升「的XX課/評鑑」優先級、排除時間殘片。

### L3) A2.2-D 功能開關測試
- 輸入：小明每天早上8點英文課
- 預期：（未定義，但應保持穩定）
- 實際：⚠️ 時間衝突 …
- 問題：測試期望未定義；輸出穩定但不匹配。
- 修正：補 `expected.code` 或關鍵詞。

### L4) B1.1-B 明天課程查詢
- 輸入：查詢Lumi明天的課表
- 預期：Lumi 明天課表
- 實際：📅 Lumi明天的課程安排 …
- 問題：文案差異（課程安排 vs 課表）。
- 修正：已統一為「課表」，對齊測試。

### L5) B2.1-A 當日課程記錄
- 輸入：今天小明的數學課學了分數加減法
- 預期：記錄成功
- 實際：❌ 找不到 小明 的 數學課（日期：2025-08-09）…
- 判斷：此為合理失敗（本機數據無課），測試期望應為 NOT_FOUND。

### L6) C1.1-B 修改每日重複課時間
- 輸入：小明每天的晨練課改到早上7點
- 預期：詢問修改範圍
- 實際：直接安排成功（誤新增）。
- 修正：`modify_course` 快徑與 Gatekeeper，避免落入新增。

### L7) C2.1-D 重複課程類型區分取消
- 輸入：取消Lumi每週三的鋼琴課
- 預期：（未定義）
- 實際：❌ 請提供學生姓名 …
- 修正：抽取規則與多輪澄清。

---

## 修復優先級（給人看的行動清單）
1) 意圖分流收斂（先護住查詢，不被新增/提醒/修改搶判）
   - 檔：`src/nlu/IntentRouter.js`、`config/mvp/intent-rules.yaml`
2) Gatekeeper 模板化（record/reminder/cancel 的 NOT_FOUND/MISSING_* 一致文案）
   - 檔：`src/tasks/handle_*.js` + `src/nlu/ResponseRenderer.js`
3) 查詢會話鎖嚴格條件（當句有學生就不用 pinned；僅 Query 套用）
   - 檔：`src/conversation/ConversationManager.js`、`src/intent/extractSlots.js`
4) 查「什麼時候/每天幾點」專用路徑（時間查詢）
   - 新意圖或 `query_schedule` 擴充
5) 測試期望校正（占位功能用例、錯誤碼/關鍵詞）
   - 檔：`QA/plans/*.md` 生成器 or 手動


