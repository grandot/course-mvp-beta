# ç”¨æˆ¶æµç¨‹è©³è§£

## ğŸ“Š ç”¨æˆ¶è¼¸å…¥è™•ç†æµç¨‹

### å®Œæ•´è™•ç†æµç¨‹åœ–
```
ç”¨æˆ¶è¼¸å…¥ 
    â†“
ç´”æ™‚é–“æª¢æ¸¬æ””æˆª
    â†“
ä¸Šä¸‹æ–‡åŠ è¼‰
    â†“
è¦å‰‡å¼•æ“æ™ºèƒ½æ‰“åˆ†
    â†“
çµ±ä¸€å¯¦é«”æå–
    â†“
é—œéµä¿¡å¿ƒåº¦æ¸¬è©¦
    â†“
Slot Template è™•ç†ï¼ˆå¯é¸ï¼‰
    â†“
æ§½ä½ç‹€æ…‹ç®¡ç†
    â†“
å•é¡Œæª¢æ¸¬
    â†“
æ™ºèƒ½åˆ†é›¢è™•ç†
    â†“
å•é¡Œç­–ç•¥è™•ç†
    â†“
ä»»å‹™åŸ·è¡Œ
    â†“
å›æ‡‰ç”Ÿæˆ
```

### å¢å¼·ç‰ˆå¤šè¼ªå°è©±è™•ç†

#### è©³ç´°è™•ç†æ­¥é©Ÿ

**Step 1: æ¥æ”¶ç”¨æˆ¶è¼¸å…¥**
- `lineController` æ¥æ”¶ä¾†è‡ª LINE Platform çš„ Webhook äº‹ä»¶
- æå–ç”¨æˆ¶ IDã€è¨Šæ¯å…§å®¹ã€æ™‚é–“æˆ³ç­‰åŸºæœ¬ä¿¡æ¯
- åˆå§‹åŒ–è«‹æ±‚ä¸Šä¸‹æ–‡

**Step 2: ä¸Šä¸‹æ–‡åŠ è¼‰**
- `conversationContext` æ¨¡çµ„å¾ Firestore åŠ è¼‰ç”¨æˆ¶å°è©±ä¸Šä¸‹æ–‡
- åŒ…å«å°è©±æ­·å²ã€ç”¨æˆ¶åå¥½ã€æœªå®Œæˆä»»å‹™ç­‰
- å»ºç«‹å®Œæ•´çš„ç”¨æˆ¶æœƒè©±ç‹€æ…‹

**Step 3: ç´”æ™‚é–“æª¢æ¸¬æ””æˆª**
```javascript
// æ””æˆªç„¡æ„ç¾©çš„ç´”æ™‚é–“è¼¸å…¥ï¼Œé¿å…ç³»çµ±è³‡æºæµªè²»
const pureTimeInputs = [
  "æ˜å¤©ä¸‹åˆå››é»",
  "ä»Šå¤©æ™šä¸Šå…«é»", 
  "ä¸‹é€±ä¸‰ä¸Šåˆåé»"
];

// æª¢æ¸¬é‚è¼¯
function detectPureTimeInput(text) {
  const pureTimePatterns = [
    /^(æ˜å¤©|ä»Šå¤©|å¾Œå¤©|ä¸‹é€±\w+)\s*(ä¸Šåˆ|ä¸‹åˆ|æ™šä¸Š)?\s*\d{1,2}é»åŠ?$/,
    /^\d{1,2}:\d{2}$/,
    /^\d{1,2}é»\d{0,2}åˆ†?$/
  ];
  
  return pureTimePatterns.some(pattern => pattern.test(text.trim()));
}

// è™•ç†çµæœ
detectPureTimeInput("æ˜å¤©ä¸‹åˆå››é»") â†’ ç›´æ¥æ‹’çµ•ï¼Œè¿”å›å‹å–„æç¤º
detectPureTimeInput("æ˜å¤©ä¸‹åˆå››é»è·†æ‹³é“") â†’ é€šéæª¢æ¸¬ï¼Œç¹¼çºŒè™•ç†
```

**Step 4: å ´æ™¯è·¯ç”±**
- `ScenarioManager` æ ¹æ“šæ„åœ–è¦å‰‡å’Œå°è©±æ­·å²æ±ºå®šç•¶å‰å°è©±å ´æ™¯
- è¼‰å…¥å°æ‡‰çš„ Scenario Template å’Œé…ç½®
- è¨­å®šå ´æ™¯ç‰¹å®šçš„è™•ç†è¦å‰‡

**Step 5: è¦å‰‡å¼•æ“æ™ºèƒ½æ‰“åˆ†**
```javascript
// IntentRuleEngine åŸºæ–¼ intent-rules.yaml é…ç½®é€²è¡Œæ„åœ–è­˜åˆ¥
const examples = [
  {
    input: "å–æ¶ˆæ•¸å­¸èª²",
    output: { intent: 'cancel_course', confidence: 0.8, keywords: ['å–æ¶ˆ'] }
  },
  {
    input: "æˆ‘æƒ³å­¸é»ä»€éº¼",
    output: { intent: 'unknown', confidence: 0.0, keywords: [] }
  },
  {
    input: "æ˜å¤©æœ‰è‹±æ–‡èª²",
    output: { intent: 'record_course', confidence: 0.7, keywords: ['æœ‰'] }
  }
];

// è¦å‰‡åŒ¹é…éç¨‹
function analyzeWithRules(text) {
  const rules = loadIntentRules(); // å¾ YAML è¼‰å…¥è¦å‰‡
  let bestMatch = { intent: 'unknown', confidence: 0.0 };
  
  for (const [intent, rule] of Object.entries(rules)) {
    const score = calculateMatchScore(text, rule);
    if (score > bestMatch.confidence) {
      bestMatch = { intent, confidence: score };
    }
  }
  
  return bestMatch;
}
```

**Step 6: çµ±ä¸€å¯¦é«”æå–**
```javascript
// SemanticService æä¾›çµ±ä¸€çš„å¯¦é«”æå–æ¥å£
// å…§éƒ¨ä½¿ç”¨ OpenAI + æ­£å‰‡è¡¨é”å¼ fallback æ©Ÿåˆ¶

const extractionExamples = [
  {
    input: "æ˜å¤©ä¸‹åˆå››é»åŠè·†æ‹³é“",
    output: {
      course_name: "è·†æ‹³é“",
      timeInfo: {
        date: "2025-07-31",
        time: "16:30", 
        confidence: 0.9,
        original: "æ˜å¤©ä¸‹åˆå››é»åŠ"
      },
      location: null,
      teacher: null
    }
  },
  {
    input: "é€±ä¸‰ä¸Šåˆåé»åœ¨é«”è‚²é¤¨ä¸Šé«”è‚²èª²",
    output: {
      course_name: "é«”è‚²èª²",
      timeInfo: {
        date: "2025-08-06", // ä¸‹é€±ä¸‰
        time: "10:00",
        confidence: 0.8
      },
      location: "é«”è‚²é¤¨",
      teacher: null
    }
  }
];

// æå–éç¨‹
async function extractCourseEntities(text) {
  try {
    // å„ªå…ˆä½¿ç”¨ OpenAI é€²è¡Œæ™ºèƒ½æå–
    const aiResult = await openaiService.extractEntities(text);
    if (aiResult.confidence > 0.7) return aiResult;
  } catch (error) {
    console.log('OpenAI extraction failed, using fallback');
  }
  
  // Fallback åˆ°æ­£å‰‡è¡¨é”å¼æå–
  return regexBasedExtraction(text);
}
```

**Step 7: é—œéµä¿¡å¿ƒåº¦æ¸¬è©¦**
```javascript
// æ™ºèƒ½åˆ¤æ–·æ±ºç­–é»
function shouldUseAI(ruleResult, entityResult) {
  // é«˜ä¿¡å¿ƒåº¦è¦å‰‡åŒ¹é… + å¯¦é«”æå–æˆåŠŸ â†’ è·³é AI
  if (ruleResult.confidence >= 0.8 && 
      ruleResult.intent !== 'unknown' && 
      entityResult.hasRequiredFields) {
    return false; // 60-70% æ¡ˆä¾‹ï¼Œæ¯«ç§’ç´šéŸ¿æ‡‰
  }
  
  // ä½ä¿¡å¿ƒåº¦æˆ–è¤‡é›œèªç¾© â†’ ä½¿ç”¨ AI
  return true; // 30-40% æ¡ˆä¾‹ï¼Œæ·±åº¦ç†è§£
}

// è™•ç†åˆ†æµ
if (shouldUseAI(ruleResult, entityResult)) {
  // AI æ·±åº¦åˆ†æè·¯å¾„
  const aiAnalysis = await OpenAI.analyzeIntent(text, context);
  return mergeResults(ruleResult, entityResult, aiAnalysis);
} else {
  // è¦å‰‡å¼•æ“ç›´æ¥è·¯å¾„
  return formatResult(ruleResult, entityResult);
}
```

**Step 8: æ§½ä½ç‹€æ…‹ç®¡ç†**ï¼ˆSlot Template ç³»çµ±å•Ÿç”¨æ™‚ï¼‰
- `slotStateManager` æ¥æ”¶èªç¾©åˆ†æçµæœ
- æ›´æ–°ç•¶å‰å ´æ™¯çš„æ§½ä½ç‹€æ…‹
- è™•ç†æ§½ä½å¡«å……ã€ç¢ºèªã€æ¾„æ¸…ç­‰æ“ä½œ

**Step 9: å•é¡Œæª¢æ¸¬**
- `slotProblemDetector` æª¢æŸ¥ç•¶å‰æ§½ä½æ˜¯å¦å­˜åœ¨å•é¡Œ
- è­˜åˆ¥ä¿¡æ¯æ¨¡ç³Šã€è¡çªã€ç¼ºå¤±ç­‰æƒ…æ³
- ç”Ÿæˆéœ€è¦ç”¨æˆ¶æ¾„æ¸…çš„å•é¡Œåˆ—è¡¨

**Step 10: æ™ºèƒ½åˆ†é›¢è™•ç†**
```javascript
// è™•ç†æ··é›œçš„æ§½ä½å…§å®¹ï¼Œä¾‹å¦‚ï¼š
const mixedInput = "æ˜å¤©æ•¸å­¸èª²æ”¹åˆ°å¾Œå¤©ï¼Œé‚„æœ‰é€±ä¸‰çš„è‹±æ–‡èª²å–æ¶ˆ";

// åˆ†é›¢è™•ç†
const separatedIntents = [
  {
    action: "modify_course",
    entities: { course_name: "æ•¸å­¸èª²", timeChange: "æ˜å¤©â†’å¾Œå¤©" }
  },
  {
    action: "cancel_course", 
    entities: { course_name: "è‹±æ–‡èª²", time: "é€±ä¸‰" }
  }
];

// åˆ†åˆ¥è™•ç†æ¯å€‹æ„åœ–
for (const intent of separatedIntents) {
  await processIntent(intent);
}
```

**Step 11: å•é¡Œç­–ç•¥è™•ç†**
```javascript
// æ ¹æ“šå•é¡Œæ•¸é‡æ¡ç”¨ä¸åŒç­–ç•¥
function handleProblems(problems) {
  switch (problems.length) {
    case 0:
      // ç„¡å•é¡Œï¼šç›´æ¥åŸ·è¡Œä»»å‹™
      return executeTask();
      
    case 1:
      // å–®ä¸€å•é¡Œï¼šå‰µå»ºæš«å­˜ç‹€æ…‹ï¼Œç”Ÿæˆæ¾„æ¸…å•é¡Œ
      createTempState(problems[0]);
      return generateClarificationQuestion(problems[0]);
      
    default:
      // å¤šå€‹å•é¡Œï¼šè¦æ±‚ç”¨æˆ¶é‡æ–°è¼¸å…¥å®Œæ•´ä¿¡æ¯
      return requestCompleteInformation(problems);
  }
}
```

**Step 12: ä»»å‹™åŸ·è¡Œ**
- `taskService` èª¿ç”¨ç›¸æ‡‰çš„å¾Œç«¯æœå‹™
- ä¾‹å¦‚ `courseService` æˆ– `dataService`
- åŸ·è¡Œå…·é«”çš„æ¥­å‹™é‚è¼¯æ“ä½œ

**Step 13: å›æ‡‰ç”Ÿæˆ**
- `humanPromptGenerator` æ ¹æ“šè™•ç†çµæœç”Ÿæˆè‡ªç„¶å›æ‡‰
- è€ƒæ…®ç”¨æˆ¶å‹å–„æ€§å’Œä¿¡æ¯å®Œæ•´æ€§
- çµ±ä¸€æ ¼å¼åŒ–è¼¸å‡º

**Step 14: å›æ‡‰ç™¼é€**
- `lineService` å°‡ç”Ÿæˆçš„å›æ‡‰é€šé LINE Messaging API ç™¼é€çµ¦ç”¨æˆ¶
- è¨˜éŒ„å°è©±æ­·å²å’Œç”¨æˆ¶äº’å‹•æ•¸æ“š

## ğŸ“ˆ è™•ç†æ•ˆç‡çµ±è¨ˆ

### æ€§èƒ½åˆ†æ

| è™•ç†å±¤ç´š | æ¡ˆä¾‹æ¯”ä¾‹ | éŸ¿æ‡‰æ™‚é–“ | æº–ç¢ºç‡ | æˆæœ¬ | ç¯„ä¾‹ |
|---------|---------|----------|--------|------|------|
| **ç´”æ™‚é–“æ””æˆª** | ~5% | <1ms | 100% | å…è²» | "æ˜å¤©ä¸‹åˆå››é»" |
| **è¦å‰‡å¼•æ“** | ~60-70% | <10ms | 100% | å…è²» | "å–æ¶ˆæ•¸å­¸èª²" |
| **OpenAIè™•ç†** | ~30-40% | 200-500ms | 95%+ | ä»˜è²» | "æˆ‘æƒ³å­¸é»ä»€éº¼" |
| **Slot Template** | ~20-30% | 100-300ms | 98%+ | ä¸­ç­‰ | è¤‡é›œå¤šè¼ªå°è©± |

### å„ªåŒ–æ•ˆæœ

**æ•ˆèƒ½æœ€ä½³åŒ–**ï¼š
- âœ… 70% è«‹æ±‚æ¯«ç§’ç´šéŸ¿æ‡‰ï¼ˆè¦å‰‡å¼•æ“è™•ç†ï¼‰
- âœ… AI èª¿ç”¨é‡æ¸›å°‘ 70%ï¼Œå¤§å¹…é™ä½æˆæœ¬
- âœ… ç³»çµ±è³‡æºä½¿ç”¨æœ€å°åŒ–
- âœ… å¤šè¼ªå°è©±æ™ºèƒ½è£œå…¨ï¼Œæ¸›å°‘ç”¨æˆ¶é‡è¤‡è¼¸å…¥

**æº–ç¢ºæ€§ä¿è­‰**ï¼š
- âœ… ç¢ºå®šæ€§æ„åœ– 100% æº–ç¢ºè­˜åˆ¥
- âœ… è¤‡é›œèªç¾©äº¤ç”± AI æ·±åº¦ç†è§£
- âœ… åˆ†å±¤ fallback ç¢ºä¿ç©©å®šæ€§
- âœ… æ™ºèƒ½å•é¡Œæª¢æ¸¬å’Œåˆ†é›¢è™•ç†

## ğŸ¯ ç”¨æˆ¶å ´æ™¯ç¯„ä¾‹

### å ´æ™¯ 1: ç°¡å–®èª²ç¨‹æ–°å¢
```
ç”¨æˆ¶: "æ˜å¤©ä¸‹åˆ2é»æ•¸å­¸èª²"
è™•ç†: è¦å‰‡å¼•æ“è­˜åˆ¥ â†’ å¯¦é«”æå– â†’ ç›´æ¥åŸ·è¡Œ
å›æ‡‰: "âœ… èª²ç¨‹ã€Œæ•¸å­¸èª²ã€å·²æˆåŠŸæ–°å¢ï¼ğŸ•’ æ™‚é–“ï¼š07/31 2:00 PM"
è€—æ™‚: <10ms
```

### å ´æ™¯ 2: è¤‡é›œæ„åœ–ç†è§£
```
ç”¨æˆ¶: "æˆ‘æƒ³å­¸é»ä»€éº¼æ¯”è¼ƒå¥½"
è™•ç†: è¦å‰‡å¼•æ“ä½ä¿¡å¿ƒåº¦ â†’ OpenAI æ·±åº¦åˆ†æ â†’ æ¨è–¦å›æ‡‰
å›æ‡‰: "æˆ‘å¯ä»¥å¹«æ‚¨æ¨è–¦ä¸€äº›ç†±é–€èª²ç¨‹ï¼Œæˆ–è€…æ‚¨å¯ä»¥å‘Šè¨´æˆ‘æ‚¨çš„èˆˆè¶£æ–¹å‘..."
è€—æ™‚: ~300ms
```

### å ´æ™¯ 3: å¤šè¼ªå°è©±è£œå…¨
```
ç”¨æˆ¶: "æ•¸å­¸èª²"
ç³»çµ±: "è«‹å•æ‚¨è¦å°æ•¸å­¸èª²åšä»€éº¼æ“ä½œå‘¢ï¼Ÿ"
ç”¨æˆ¶: "æ”¹æ™‚é–“"
ç³»çµ±: "è«‹å•è¦æ”¹åˆ°ä»€éº¼æ™‚é–“ï¼Ÿ"
ç”¨æˆ¶: "æ˜å¤©æ™šä¸Š8é»"
è™•ç†: æš«å­˜ç‹€æ…‹ç®¡ç† â†’ æ§½ä½è£œå…¨ â†’ åŸ·è¡Œä¿®æ”¹
å›æ‡‰: "âœ… èª²ç¨‹ã€Œæ•¸å­¸èª²ã€æ™‚é–“å·²ä¿®æ”¹ç‚º 07/31 8:00 PM"
```

### å ´æ™¯ 4: æ™ºèƒ½åˆ†é›¢è™•ç†
```
ç”¨æˆ¶: "æ˜å¤©æ•¸å­¸èª²æ”¹åˆ°å¾Œå¤©ï¼Œé€±ä¸‰è‹±æ–‡èª²å–æ¶ˆ"
è™•ç†: æ™ºèƒ½åˆ†é›¢ â†’ å…©å€‹ç¨ç«‹ä»»å‹™ â†’ åˆ†åˆ¥åŸ·è¡Œ
å›æ‡‰: "âœ… å·²å®Œæˆå…©é …æ“ä½œï¼š
1. æ•¸å­¸èª²æ™‚é–“å·²ä¿®æ”¹ç‚º 08/01 [åŸæ™‚é–“]
2. é€±ä¸‰çš„è‹±æ–‡èª²å·²å–æ¶ˆ"
```

## ğŸ›¡ï¸ éŒ¯èª¤è™•ç†æµç¨‹

### å¸¸è¦‹éŒ¯èª¤é¡å‹

**1. ç´”æ™‚é–“è¼¸å…¥éŒ¯èª¤**
```
ç”¨æˆ¶: "æ˜å¤©ä¸‹åˆ3é»"
ç³»çµ±: "è«‹å‘Šè¨´æˆ‘æ˜å¤©ä¸‹åˆ3é»è¦åšä»€éº¼èª²ç¨‹æˆ–æ´»å‹• ğŸ˜Š"
```

**2. æ¨¡ç³Šæ„åœ–éŒ¯èª¤**
```
ç”¨æˆ¶: "é‚£å€‹èª²"
ç³»çµ±: "è«‹å•æ‚¨æŒ‡çš„æ˜¯å“ªä¸€å ‚èª²å‘¢ï¼Ÿæ‚¨å¯ä»¥èªªèª²ç¨‹åç¨±ï¼Œæ¯”å¦‚ã€Œæ•¸å­¸èª²ã€æˆ–ã€Œè‹±æ–‡èª²ã€"
```

**3. æ™‚é–“è¡çªéŒ¯èª¤**
```
ç”¨æˆ¶: "æ˜å¤©ä¸‹åˆ2é»è‹±æ–‡èª²"
ç³»çµ±: "âš ï¸ æ˜å¤©ä¸‹åˆ2é»æ‚¨å·²ç¶“æœ‰æ•¸å­¸èª²äº†ï¼Œè«‹é¸æ“‡å…¶ä»–æ™‚é–“æˆ–å–æ¶ˆåŸæœ‰èª²ç¨‹"
```

**4. ç³»çµ±éŒ¯èª¤è™•ç†**
```
OpenAI API éŒ¯èª¤ â†’ è‡ªå‹• fallback åˆ°è¦å‰‡å¼•æ“
Firebase é€£æ¥éŒ¯èª¤ â†’ æš«å­˜æœ¬åœ°ä¸¦ç¨å¾Œé‡è©¦
LINE API éŒ¯èª¤ â†’ è¨˜éŒ„éŒ¯èª¤ä¸¦é€šçŸ¥ç®¡ç†å“¡
```

## ğŸ“± å¤šè¼ªå°è©±å¢å¼·æ©Ÿåˆ¶

### æš«å­˜ç‹€æ…‹ç®¡ç†
```javascript
// å–®ä¸€å•é¡Œæª¢æ¸¬æ™‚å‰µå»ºæš«å­˜ç‹€æ…‹
const tempState = {
  userId: "user123",
  pendingIntent: "record_course",
  partialEntities: {
    course_name: "æ•¸å­¸èª²",
    timeInfo: null  // ç¼ºå¤±ä¿¡æ¯
  },
  missingFields: ["timeInfo"],
  timestamp: Date.now(),
  expiresAt: Date.now() + (5 * 60 * 1000) // 5åˆ†é˜éæœŸ
};

// ç”¨æˆ¶è£œå……ä¿¡æ¯æ™‚
ç”¨æˆ¶: "æ˜å¤©ä¸‹åˆ3é»"
// ç³»çµ±è‡ªå‹•