# 部署與運維指南

## 🚀 部署環境

### 主要部署平台
- **Render** (主要): 自動部署，支援環境變數
- **Vercel** (備選): Serverless 部署
- **Heroku** (支援): 傳統 PaaS 部署

### 當前部署信息
- **平台**: Render.com
- **部署方式**: Git 自動部署
- **服務 ID**: `srv-d21f9u15pdvs73frvns0`
- **工作空間**: `tea-d1otdn7fte5s73bnf3k0`

## ⚙️ 環境變數配置

### 必要環境變數
```env
# OpenAI 配置
OPENAI_API_KEY=your_openai_api_key

# Firebase 配置  
FIREBASE_PROJECT_ID=your_firebase_project_id
FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n"
FIREBASE_CLIENT_EMAIL=your_service_account_email

# LINE Bot 配置
LINE_CHANNEL_ACCESS_TOKEN=your_line_channel_access_token
LINE_CHANNEL_SECRET=your_line_channel_secret

# 管理後台配置
ADMIN_KEY=course-admin-2024
BASIC_AUTH_USER=grandot
BASIC_AUTH_PASS=your_admin_password

# 場景配置
SCENARIO_TYPE=course_management

# 應用配置
NODE_ENV=production
PORT=3000
```

### 環境變數安全注意事項
- ✅ 使用 Render 的環境變數功能，不要將敏感信息寫入代碼
- ✅ Firebase 私鑰需要保持換行格式
- ✅ 定期輪換 API Keys
- ❌ 絕不將 `.env` 檔案提交到 git

## 📊 監控與日誌

### Render CLI 設置
```bash
# 安裝 Render CLI
brew install render

# 登錄 Render（已配置）
render auth login

# 查看服務狀態
render services list

# 查看日誌
render logs -s srv-d21f9u15pdvs73frvns0
```

### 日誌查詢腳本
```bash
# 基本查詢（最近50條）
./scripts/get-app-logs.sh 50

# 搜索特定關鍵詞
./scripts/get-app-logs.sh 30 "用戶輸入內容"

# 查找錯誤日誌
./scripts/get-app-logs.sh 100 "ERROR"

# 查找警告
./scripts/get-app-logs.sh 50 "WARN"
```

### 常見日誌查詢場景
```bash
# 語義解析問題
./scripts/get-app-logs.sh 50 "SemanticService"

# 時間處理問題  
./scripts/get-app-logs.sh 30 "TimeService"

# 課程操作問題
./scripts/get-app-logs.sh 40 "CourseManagement"

# API調用問題
./scripts/get-app-logs.sh 50 "POST"

# OpenAI 相關問題
./scripts/get-app-logs.sh 30 "OpenAI"

# Firebase 連接問題
./scripts/get-app-logs.sh 30 "Firebase"
```

## 🐛 故障排除

### 調試流程
1. **用戶報告模板**
   ```
   我剛輸入"XXX"但返回結果不對，查render日誌分析問題
   ```

2. **標準調試步驟**
   ```bash
   # 1. 立即查詢應用程序日誌
   ./scripts/get-app-logs.sh 50
   
   # 2. 搜索用戶輸入相關日誌
   ./scripts/get-app-logs.sh 30 "用戶輸入內容"
   
   # 3. 分析錯誤模式
   ./scripts/get-app-logs.sh 100 "ERROR"
   ```

3. **調試後續流程**
   - 分析日誌找出問題根源
   - 定位相關代碼文件  
   - 修復代碼邏輯
   - 更新 CHANGELOG.md
   - 推送到 git（必須先更新 CHANGELOG.md）

### 常見問題解決

#### 1. OpenAI API 錯誤
```bash
# 檢查 API Key 狀態
curl -H "Authorization: Bearer $OPENAI_API_KEY" \
     https://api.openai.com/v1/models

# 常見錯誤類型
# - 401: API Key 無效或過期
# - 429: 請求頻率超限
# - 500: OpenAI 服務錯誤
```

**解決方法**:
- 驗證 API Key 是否正確
- 檢查 OpenAI 帳戶餘額
- 確認請求頻率在限制內

#### 2. Firebase 連接問題
```bash
# 檢查服務帳號金鑰格式
echo $FIREBASE_PRIVATE_KEY | head -c 100

# 驗證項目 ID
echo $FIREBASE_PROJECT_ID
```

**解決方法**:
- 確認 Firebase 項目 ID 正確
- 檢查服務帳號金鑰格式（保持換行）
- 驗證服務帳號權限

#### 3. LINE API 錯誤  
```bash
# 檢查 Channel Access Token
curl -H "Authorization: Bearer $LINE_CHANNEL_ACCESS_TOKEN" \
     https://api.line.me/v2/bot/info

# 驗證 Webhook URL
curl -X POST https://api.line.me/v2/bot/channel/webhook/test \
     -H "Authorization: Bearer $LINE_CHANNEL_ACCESS_TOKEN"
```

**解決方法**:
- 確認 Channel Access Token 有效
- 檢查 Webhook URL 設置
- 驗證 LINE Bot 設定

#### 4. 部署失敗
**常見原因**:
- 環境變數缺失或格式錯誤
- 依賴包安裝失敗
- 端口配置問題

**解決步驟**:
```bash
# 1. 檢查 Render 部署日誌
render logs -s srv-d21f9u15pdvs73frvns0 --tail

# 2. 驗證 package.json
npm install  # 本地測試

# 3. 檢查環境變數
# 在 Render Dashboard 中逐一確認
```

#### 5. 記憶體或性能問題
```bash
# 查看系統資源使用
./scripts/get-app-logs.sh 50 "memory"
./scripts/get-app-logs.sh 50 "timeout"

# 檢查大量請求
./scripts/get-app-logs.sh 100 | grep -E "(POST|GET)" | wc -l
```

**優化方法**:
- 檢查是否有記憶體洩漏
- 優化數據庫查詢
- 增加 Render 服務資源

## 📈 性能監控

### 關鍵指標監控
```bash
# API 響應時間
./scripts/get-app-logs.sh 100 | grep "Response time"

# 錯誤率統計
./scripts/get-app-logs.sh 200 | grep "ERROR" | wc -l

# OpenAI Token 使用量
./scripts/get-app-logs.sh 100 | grep "token_usage"

# 用戶活躍度
./scripts/get-app-logs.sh 200 | grep "user_id" | sort | uniq -c
```

### 成本控制監控
```javascript
// Token 使用統計查詢
{
  user_id: "LINE User ID",
  model: "gpt-3.5-turbo",
  total_tokens: 2280,
  total_cost_twd: 0.11,              // 新台幣成本
  user_message: "原始訊息",
  timestamp: "ISO 時間"
}
```

```bash
# 查看今日成本
./scripts/get-app-logs.sh 500 | grep "total_cost_twd" | \
awk '{sum+=$NF} END {print "今日總成本: $" sum " TWD"}'

# 查看用戶使用排行
./scripts/get-app-logs.sh 1000 | grep "user_id" | \
sort | uniq -c | sort -nr | head -10
```

## 🔒 安全管理

### 管理後台安全
- **多層防護**: Basic Auth + Admin Key
- **訪問控制**: 僅限授權人員
- **操作日誌**: 記錄所有管理操作

### 數據備份
```bash
# Firebase 數據匯出（需要在 Firebase Console 操作）
# 1. 進入 Firebase Console
# 2. 選擇 Firestore Database
# 3. 選擇 "匯出資料"
# 4. 設定匯出設定並執行

# 環境變數備份（安全存儲）
# 定期備份 Render 環境變數設定
```

### 災難復原計劃
1. **數據備份**: 每週自動備份 Firestore 數據
2. **代碼備份**: Git 倉庫作為主要備份
3. **配置備份**: 環境變數和部署設定文檔化
4. **快速復原**: 準備好的部署腳本和環境設定

## 📱 多環境管理

### 開發環境
```bash
# 本地開發
npm run dev
# 使用 .env.local 配置
```

### 測試環境（可選）
```bash
# 設置測試環境變數
SCENARIO_TYPE=course_management_test
NODE_ENV=staging
```

### 生產環境
```bash
# Render 生產環境
SCENARIO_TYPE=course_management
NODE_ENV=production
```

## 🔄 CI/CD 流程（簡化版）

### 當前部署流程
```
代碼推送 → GitHub → Render 自動拉取 → 構建 → 部署 → 健康檢查
```

### 部署檢查清單
- [ ] 更新 CHANGELOG.md
- [ ] 測試主要功能路徑
- [ ] 確認環境變數配置
- [ ] 檢查依賴包版本
- [ ] 驗證 API 端點正常
- [ ] 監控部署後日誌

### 回滾程序
```bash
# 1. 在 Render Dashboard 中選擇回滾
# 2. 或者推送回滾提交
git revert <commit-hash>
git push origin main

# 3. 確認服務狀態
render services list
```

## 📞 緊急聯絡

### 服務中斷處理
1. **立即檢查**: Render 服務狀態
2. **查看日誌**: 最近的錯誤信息
3. **通知用戶**: 必要時通過 LINE 官方帳號
4. **記錄事件**: 在 CHANGELOG.md 中記錄

### 聯絡信息
- **Render 支援**: render.com/support
- **OpenAI 狀態**: status.openai.com
- **Firebase 狀態**: status.firebase.google.com