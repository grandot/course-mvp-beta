# ç³»çµ±æ¶æ§‹è¨­è¨ˆæ–‡æª”

## ğŸ—ï¸ ä¸‰å±¤èªç¾©æ¶æ§‹

### æ ¸å¿ƒç†å¿µ
**åˆ†é›¢å¼æ¶æ§‹è¨­è¨ˆ** - Single Source of Truth + Forced Boundaries

```
ç”¨æˆ¶è‡ªç„¶èªè¨€ â†’ èªç¾©è™•ç†å±¤ â†’ æ™‚é–“è™•ç†å±¤ â†’ ä»»å‹™åŸ·è¡Œå±¤ â†’ çµ±ä¸€æ ¼å¼å›è¦†
```

### ç³»çµ±æ€§è¨­è¨ˆåŸå‰‡

**Single Source of Truth**ï¼šæ¯ç¨®åŠŸèƒ½åªæœ‰ä¸€å€‹å”¯ä¸€å…¥å£
- âœ… æ‰€æœ‰æ™‚é–“ç›¸é—œ â†’ `TimeService`
- âœ… æ‰€æœ‰èªç¾©ç›¸é—œ â†’ `SemanticService`  
- âœ… æ‰€æœ‰æ•¸æ“šç›¸é—œ â†’ `DataService`

**Forced Boundaries**ï¼šé€šéæŠ€è¡“æ‰‹æ®µå¼·åˆ¶é‚Šç•Œç´„æŸ
- âœ… ESLint è¦å‰‡ç¦æ­¢è·¨å±¤èª¿ç”¨
- âœ… æ¨¡çµ„å°è£éš±è—å…§éƒ¨å¯¦ç¾
- âœ… æ¥å£å¥‘ç´„æ˜ç¢ºè·è²¬é‚Šç•Œ

**No Cross-Layer Access**ï¼šç¦æ­¢è·¨å±¤ç›´æ¥èª¿ç”¨
- âŒ Controllers ä¸å¾—ç›´æ¥èª¿ç”¨ OpenAI
- âŒ Services ä¸å¾—ç›´æ¥ä½¿ç”¨ `new Date()`
- âŒ Utils ä¸å¾—ç›´æ¥æ“ä½œæ•¸æ“šåº«

## ğŸ¯ Scenario Layer æ¶æ§‹ï¼ˆv9.0ï¼‰

### Template-Based å¤šå ´æ™¯æ¥­å‹™å¹³å°
å¾å–®ä¸€èª²ç¨‹ç®¡ç†ç³»çµ±è½‰æ›ç‚ºé€šç”¨å¤šå ´æ™¯å¹³å°

```
ç”¨æˆ¶è‡ªç„¶èªè¨€ â†’ èªç¾©è™•ç†å±¤ â†’ Scenario Layer â†’ EntityService â†’ çµ±ä¸€æ ¼å¼å›è¦†
```

### ScenarioTemplate æŠ½è±¡åŸºé¡
```javascript
class ScenarioTemplate {
  constructor(config) {
    this.config = config;
    this.entityType = config.entity_type;
    this.entityName = config.entity_name;
  }

  // çµ±ä¸€æ¥­å‹™æ¥å£ - æ‰€æœ‰å ´æ™¯å¿…é ˆå¯¦ç¾
  async createEntity(entities, userId) { throw new Error('Must implement'); }
  async modifyEntity(entities, userId) { throw new Error('Must implement'); }
  async cancelEntity(entities, userId) { throw new Error('Must implement'); }
  async queryEntities(entities, userId) { throw new Error('Must implement'); }
  async clearAllEntities(userId) { throw new Error('Must implement'); }

  // é€šç”¨å·¥å…·æ–¹æ³• - çµ±ä¸€å¯¦ç¾
  formatMessage(template, variables) { /* çµ±ä¸€è¨Šæ¯æ ¼å¼åŒ– */ }
  formatConfigMessage(messageKey, variables) { /* é…ç½®é©…å‹•è¨Šæ¯ */ }
  validateRequiredFields(entities) { /* çµ±ä¸€æ¬„ä½é©—è­‰ */ }
}
```

### ScenarioManager å–®ä¾‹æ¨¡å¼ï¼ˆæ€§èƒ½å„ªåŒ–ï¼‰
```javascript
class ScenarioManager {
  // ğŸ¯ å•Ÿå‹•æ™‚ä¸€æ¬¡æ€§é åŠ è¼‰ç•¶å‰å ´æ™¯
  static async initialize() {
    const scenarioType = process.env.SCENARIO_TYPE || 'course_management';
    console.log(`ğŸ­ [ScenarioManager] åˆå§‹åŒ–å–®ä¸€å ´æ™¯: ${scenarioType}`);
    
    // åªåŠ è¼‰ç•¶å‰éƒ¨ç½²å ´æ™¯ï¼Œä¸åŠ è¼‰å…¶ä»–å ´æ™¯
    await this.preloadScenario(scenarioType);
    this.currentScenarioType = scenarioType;
    
    console.log(`âœ… [ScenarioManager] å ´æ™¯ "${scenarioType}" åˆå§‹åŒ–å®Œæˆï¼Œè€—æ™‚ 3ms`);
    console.log(`ğŸ¯ WebService æ¨¡å¼: å–®ä¸€å ´æ™¯éƒ¨ç½²`);
  }

  // ğŸ¯ ç²å–ç•¶å‰å ´æ™¯å¯¦ä¾‹ï¼ˆO(1) æŸ¥æ‰¾ï¼Œç„¡æ–‡ä»¶ I/Oï¼‰
  static getCurrentScenario() {
    return this.scenarios.get(this.currentScenarioType);
  }
}
```

### TaskService å§”è¨—æ¶æ§‹ï¼ˆå„ªåŒ–ç‰ˆï¼‰
```javascript
// é‡æ§‹ç‰ˆï¼šinstance-based with scenario delegation + æ€§èƒ½å„ªåŒ–
class TaskService {
  constructor() {
    // âš¡ ä½¿ç”¨é åŠ è¼‰çš„å ´æ™¯å¯¦ä¾‹ï¼Œé¿å…é‡è¤‡å‰µå»ºå’Œæ–‡ä»¶ I/O
    this.scenario = ScenarioManager.getCurrentScenario();
  }
  
  async executeIntent(intent, entities, userId) {
    // ç´”å§”è¨—æ¨¡å¼ - æ‰€æœ‰æ¥­å‹™é‚è¼¯å§”è¨—çµ¦ Scenario Template
    const intentMethodMap = {
      'record_course': 'createEntity',
      'modify_course': 'modifyEntity',
      'cancel_course': 'cancelEntity',
      'query_courses': 'queryEntities',
      'clear_courses': 'clearAllEntities'
    };
    
    return this.scenario[intentMethodMap[intent]](entities, userId);
  }
}
```

## ğŸš€ ç¨ç«‹ WebService éƒ¨ç½²æ¨¡å¼

### æ ¸å¿ƒåŸå‰‡
æ¯å€‹ chatbot æ˜¯å®Œå…¨ç¨ç«‹çš„ webserviceï¼ŒåªåŒ…å«ä¸€å€‹æ¥­å‹™å ´æ™¯

```
èª²ç¨‹ç®¡ç† Chatbot:
- éƒ¨ç½²åœ°å€: render.com/course-bot
- ç’°å¢ƒè®Šæ•¸: SCENARIO_TYPE=course_management  
- LINE Bot è¨­å®š: é€£æ¥åˆ°èª²ç¨‹ç®¡ç† webhook
- åªåŠ è¼‰: èª²ç¨‹ç®¡ç†é…ç½® + æ¨¡æ¿ + ç›¸é—œä¾è³´

é•·ç…§ç³»çµ± Chatbot:
- éƒ¨ç½²åœ°å€: render.com/healthcare-bot
- ç’°å¢ƒè®Šæ•¸: SCENARIO_TYPE=healthcare_management
- å®Œå…¨ç¨ç«‹: èˆ‡èª²ç¨‹ç³»çµ±ç„¡ä»»ä½•å…±äº«

ä¿éšªæ¥­å‹™ Chatbot:
- éƒ¨ç½²åœ°å€: render.com/insurance-bot
- ç’°å¢ƒè®Šæ•¸: SCENARIO_TYPE=insurance_sales
- ç¨ç«‹æ“´å±•: å¯æ ¹æ“šæ¥­å‹™éœ€æ±‚ç¨ç«‹èª¿æ•´è³‡æº
```

### å¾®æœå‹™æ¶æ§‹å„ªå‹¢
- âœ… **è³‡æºéš”é›¢**: èª²ç¨‹ bot ä¸ä½”ç”¨é•·ç…§/ä¿éšªçš„å…§å­˜å’Œé…ç½®
- âœ… **å®‰å…¨éš”é›¢**: ä¸åŒæ¥­å‹™å ´æ™¯æ•¸æ“šå®Œå…¨åˆ†é›¢
- âœ… **æ•…éšœéš”é›¢**: ä¸€å€‹å ´æ™¯æ•…éšœä¸å½±éŸ¿å…¶ä»–å ´æ™¯
- âœ… **ç¨ç«‹æ“´å±•**: æ ¹æ“šå„å ´æ™¯è² è¼‰ç¨ç«‹èª¿æ•´å¯¦ä¾‹æ•¸é‡
- âœ… **æŠ€è¡“éš”é›¢**: ä¸åŒå ´æ™¯å¯ä½¿ç”¨ä¸åŒçš„æŠ€è¡“æ ˆç‰ˆæœ¬

## ğŸ”§ çµ±ä¸€æœå‹™å±¤æ¶æ§‹

### åˆ†é›¢å¼æ¶æ§‹ç´„æŸ (Single Source of Truth)

| åŠŸèƒ½åŸŸ | å”¯ä¸€å…¥å£ | è·è²¬ | ç¦æ­¢äº‹é … |
|-------|---------|------|---------|
| **Scenario Layer** | `ScenarioTemplate` | æ¥­å‹™é‚è¼¯å¯¦ç¾ | âŒ ç›´æ¥èª¿ç”¨ DataService |
| **èªç¾©è™•ç†** | `SemanticService` | æ„åœ–+å¯¦é«”+ä¸Šä¸‹æ–‡ | âŒ ç›´æ¥èª¿ç”¨ OpenAI/è¦å‰‡å¼•æ“ |
| **å¯¦é«”æ“ä½œ** | `EntityService` | é€šç”¨ CRUD + é©—è­‰ | âŒ ç›´æ¥èª¿ç”¨ Firebase |
| **æ™‚é–“è™•ç†** | `TimeService` | è§£æ+æ ¼å¼åŒ–+è¨ˆç®—+é©—è­‰ | âŒ ç›´æ¥ä½¿ç”¨ `new Date()` |
| **æ•¸æ“šè™•ç†** | `DataService` | å­˜å–+æŸ¥è©¢+æ ¼å¼åŒ– | âŒ ç›´æ¥èª¿ç”¨ Firebase |
| **ä»»å‹™åŸ·è¡Œ** | `TaskService` | å ´æ™¯å§”è¨—å”èª¿ | âŒ ç¡¬ç·¨ç¢¼æ¥­å‹™é‚è¼¯ |

### SemanticServiceï¼ˆèªç¾©è™•ç†å”¯ä¸€å…¥å£ï¼‰
```javascript
class SemanticService {
  static async analyzeMessage(text, context) {
    // å…§éƒ¨å”èª¿ï¼šè¦å‰‡å¼•æ“ + OpenAI + ä¸Šä¸‹æ–‡åˆ†æ
    // å¤–éƒ¨æ¥å£ï¼šçµ±ä¸€çš„èªç¾©åˆ†æçµæœ
  }
  
  static async extractCourse(text) {
    // å°ˆé–€çš„èª²ç¨‹åç¨±æå–
  }
  
  static async extractTime(text) {
    // å°ˆé–€çš„æ™‚é–“ä¿¡æ¯æå–
  }
}
```

### TimeServiceï¼ˆæ™‚é–“è™•ç†å”¯ä¸€å…¥å£ï¼‰
```javascript
class TimeService {
  static getCurrentUserTime() {
    // æ›¿æ›æ‰€æœ‰ new Date() ä½¿ç”¨
  }
  
  static parseTimeString(str, referenceTime) {
    // çµ±ä¸€çš„æ™‚é–“è§£æå…¥å£
  }
  
  static formatForDisplay(time, format) {
    // çµ±ä¸€çš„æ™‚é–“æ ¼å¼åŒ–å…¥å£
  }
}
```

### EntityService - é€šç”¨å¯¦é«”æ“ä½œ
```javascript
class EntityService {
  // é€šç”¨ CRUD æ“ä½œ - æ”¯æŒæ‰€æœ‰å¯¦é«”é¡å‹
  static async createEntity(entityType, entityData) {
    // çµ±ä¸€å‰µå»ºé‚è¼¯ + æ™‚é–“æˆ³ + æ•¸æ“šé©—è­‰
  }
  
  static async updateEntity(entityType, entityId, updateData) {
    // çµ±ä¸€æ›´æ–°é‚è¼¯ + è¡çªæª¢æŸ¥
  }
  
  static async queryEntities(entityType, criteria) {
    // çµ±ä¸€æŸ¥è©¢é‚è¼¯ + éæ¿¾æ’åº
  }
  
  static async checkTimeConflicts(entityType, userId, date, time, excludeId) {
    // çµ±ä¸€æ™‚é–“è¡çªæª¢æŸ¥
  }
}
```

## ğŸ¯ é…ç½®é©…å‹•è¨­è¨ˆ

### å ´æ™¯é…ç½®çµæ§‹ (YAML)
```yaml
# config/scenarios/course_management.yaml
scenario_name: "course_management"
entity_type: "courses"                    # Firebase é›†åˆåç¨±
entity_name: "èª²ç¨‹"                       # é¡¯ç¤ºåç¨±
required_fields: ["course_name", "timeInfo"]

# è¨Šæ¯æ¨¡æ¿
messages:
  create_success: "âœ… {entity_name}ã€Œ{course_name}ã€å·²æˆåŠŸæ–°å¢ï¼\nğŸ•’ æ™‚é–“ï¼š{schedule_time}"
  modify_success: "âœ… {entity_name}ã€Œ{course_name}ã€æ™‚é–“å·²ä¿®æ”¹ç‚º {schedule_time}"
  cancel_success: "âœ… {entity_name}ã€Œ{course_name}ã€å·²å–æ¶ˆ"
  
# æ¥­å‹™è¦å‰‡
business_rules:
  create:
    allow_duplicate_names: false
    auto_generate_missing_fields: true
  modify:
    allowed_fields: ["schedule_time", "course_date", "location", "teacher"]
    conflict_resolution: "time_priority"
  cancel:
    confirmation_required: false
    soft_delete: true

# é©—è­‰è¦å‰‡
validation_rules:
  time_conflict_check: true
  name_format_check: true
  
# å ´æ™¯ç‰¹å®šé…ç½®
course_specific:
  course_types: ["å­¸ç§‘", "æ‰è—", "èªè¨€", "é‹å‹•"]
  time_slots: ["ä¸Šåˆ", "ä¸‹åˆ", "æ™šä¸Š"]
```

### æ„åœ–è¦å‰‡é…ç½® (`intent-rules.yaml`)
```yaml
# ç³¾éŒ¯æ„åœ– (æœ€é«˜å„ªå…ˆç´š)
correction_intent:
  keywords: ['ä¸å°', 'éŒ¯äº†', 'ä¸æ˜¯', 'æ”¹æˆ']
  priority: 15
  requires_context: true

# èª²ç¨‹æ“ä½œæ„åœ–
cancel_course:
  keywords: ['å–æ¶ˆ', 'åˆªé™¤', 'ç§»é™¤', 'ä¸è¦', 'ä¸ä¸Š']
  priority: 10
  exclusions: ['æ–°å¢', 'å®‰æ’', 'é ç´„']
  
record_course:
  keywords: ['æ–°å¢', 'å®‰æ’', 'é ç´„', 'ä¸Šèª²', 'å­¸ç¿’', 'æœ‰']
  priority: 5
  exclusions: ['å–æ¶ˆ', 'åˆªé™¤', 'ä¸è¦']
```

## ğŸ§  Ultra-Hard è¨­è¨ˆåŸå‰‡

### ç¬¬ä¸€æ€§åŸå‰‡ï¼šç¢ºå®šæ€§å•é¡Œç”¨è¦å‰‡ï¼Œè¤‡é›œæ€§å•é¡Œç”¨AI
```javascript
// âœ… æ­£ç¢ºï¼šç¢ºå®šæ€§æ„åœ–ç”¨è¦å‰‡åŒ¹é…
"å–æ¶ˆè©¦è½" â†’ IntentRuleEngine â†’ cancel_course (100% æº–ç¢º)

// âœ… æ­£ç¢ºï¼šè¤‡é›œèªç¾©ç”¨ AI ç†è§£
"æˆ‘æƒ³å­¸é»ä»€éº¼" â†’ OpenAI â†’ æ¨¡ç³Šæ„åœ– + ä¸Šä¸‹æ–‡åˆ†æ

// âŒ éŒ¯èª¤ï¼šè®“ AI åšç¢ºå®šæ€§å·¥ä½œ
"å–æ¶ˆè©¦è½" â†’ OpenAI â†’ record_course (éŒ¯èª¤è­˜åˆ¥)
```

### å‰ƒåˆ€æ³•å‰‡ï¼šèƒ½ç”¨ç°¡å–®è¦å‰‡è§£æ±ºçš„ï¼Œä¸ç”¨è¤‡é›œAI
```yaml
# é…ç½®é©…å‹•ï¼šè¦–è¦ºåŒ–ã€å¯ç¶­è­·
cancel_course:
  keywords: ['å–æ¶ˆ', 'åˆªé™¤']
  priority: 10
  
# è€Œéä»£ç¢¼ç¡¬ç·¨ç¢¼
if (message.includes('å–æ¶ˆ')) return 'cancel_course'
```

## ğŸ”® æ“´å±•æ–°å ´æ™¯æµç¨‹
1. **å‰µå»ºé…ç½®**: è¤‡è£½ `config/scenarios/template.yaml` ç‚ºæ–°å ´æ™¯é…ç½®
2. **å¯¦ç¾æ¨¡æ¿**: ç¹¼æ‰¿ `ScenarioTemplate` å¯¦ç¾æ¥­å‹™é‚è¼¯
3. **ç¨ç«‹éƒ¨ç½²**: è¨­ç½® `SCENARIO_TYPE=new_scenario` éƒ¨ç½²æ–°å¯¦ä¾‹
4. **LINE æ•´åˆ**: å‰µå»ºæ–°çš„ LINE Bot é€£æ¥åˆ°æ–°å¯¦ä¾‹
5. **å®Œå…¨éš”é›¢**: æ–°å ´æ™¯èˆ‡ç¾æœ‰å ´æ™¯å®Œå…¨ç¨ç«‹é‹è¡Œ