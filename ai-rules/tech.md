# æŠ€è¡“æ¶æ§‹èˆ‡å¯¦ä½œæŒ‡å—

æœ¬æ–‡ä»¶èªªæ˜ç³»çµ±çš„æ¶æ§‹è¨­è¨ˆæ±ºç­–ã€æŠ€è¡“é¸å‹ç†ç”±ã€é–‹ç™¼ç’°å¢ƒé™åˆ¶ï¼Œä»¥åŠå¯¦ä½œç´°ç¯€ã€‚

## 1. æ ¸å¿ƒè¨­è¨ˆæ±ºç­–

### ç‚ºä»€éº¼é¸æ“‡ Google Calendar + Firebaseï¼Ÿ

**è¨­è¨ˆåŸå‰‡ï¼šä¸é‡è¤‡é€ è¼ªå­**

æˆ‘å€‘é¢è‡¨çš„æ ¸å¿ƒæŒ‘æˆ°æ˜¯è™•ç†è¤‡é›œçš„æ™‚é–“é‚è¼¯ï¼š
- é‡è¤‡èª²ç¨‹è¦å‰‡ï¼ˆæ¯é€±ä¸‰ã€æ¯æœˆç¬¬ä¸€å€‹é€±ä¸€ç­‰ï¼‰
- æ™‚é–“è¡çªæª¢æ¸¬
- æé†’æ©Ÿåˆ¶

**æŠ€è¡“é¸å‹åˆ†æ**ï¼š

| æ–¹æ¡ˆ | å„ªé» | ç¼ºé» |
|------|------|------|
| ç´” Firebase | å®Œå…¨è‡ªä¸»æ§åˆ¶ | éœ€è‡ªè¡Œå¯¦ç¾æ‰€æœ‰æ™‚é–“é‚è¼¯ |
| Google Calendar + Firebase | Calendar è™•ç†æ™‚é–“é‚è¼¯æˆç†Ÿå¯é  | éœ€æ•´åˆå…©å€‹ç³»çµ± |

**æœ€çµ‚æ±ºç­–**ï¼šæ¡ç”¨ Google Calendar è™•ç†æ™‚é–“é‚è¼¯ï¼ŒFirebase å„²å­˜æ¥­å‹™è³‡æ–™ï¼Œç†ç”±æ˜¯ï¼š
1. Google Calendar çš„é‡è¤‡è¦å‰‡å¼•æ“ç¶“éå¤šå¹´é©—è­‰
2. é¿å…é‡æ–°å¯¦ç¾è¤‡é›œçš„æ™‚å€å’Œå¤ä»¤æ™‚è™•ç†
3. å°ˆæ³¨æ–¼æ¥­å‹™é‚è¼¯é–‹ç™¼ï¼Œè€ŒéåŸºç¤è¨­æ–½

**âš ï¸ é‡è¦è¨­è¨ˆç†å¿µï¼šå”ä½œé—œä¿‚ï¼Œéä¸»å¾é—œä¿‚**
- Google Calendar å’Œ Firebase **ä¸æ˜¯ä¸»å¾é—œä¿‚**ï¼Œè€Œæ˜¯**åˆ†å·¥å”ä½œé—œä¿‚**
- Google Calendarï¼šå°ˆç²¾æ™‚é–“é‚è¼¯è™•ç†ï¼ˆé‡è¤‡è¦å‰‡ã€è¡çªæª¢æ¸¬ã€æ™‚å€è¨ˆç®—ï¼‰
- Firebaseï¼šå°ˆç²¾æ¥­å‹™è³‡æ–™ç®¡ç†ï¼ˆç”¨æˆ¶è³‡è¨Šã€èª²ç¨‹å…§å®¹ã€æé†’è¨­å®šï¼‰
- å…©è€…å„å¸å…¶è·ï¼Œäº’ç›¸è£œå¼·ï¼Œå…±åŒå®Œæˆå®Œæ•´çš„æ¥­å‹™åŠŸèƒ½
- ä¸æ‡‰å°‡ Google Calendar è¦–ç‚ºã€Œè¡ç”Ÿè¡¨ç¾å±¤ã€ï¼Œé€™æ¨£æœƒå¤±å»å…¶æ™‚é–“è™•ç†çš„æ ¸å¿ƒåƒ¹å€¼

### ç‚ºä»€éº¼ä½¿ç”¨ Firebase Scheduled Functions è€Œé Google Calendar æé†’ï¼Ÿ

ç¶“éæŠ€è¡“èª¿ç ”ç™¼ç¾ï¼š
- Google Calendar Webhook åªèƒ½é€šçŸ¥ã€Œè³‡æºè®Šæ›´ã€ï¼Œç„¡æ³•åœ¨ã€Œäº‹ä»¶é–‹å§‹æ™‚ã€è§¸ç™¼
- ä½¿ç”¨ Firebase Scheduled Functions å¯ä»¥ç²¾ç¢ºæ§åˆ¶æé†’é‚è¼¯
- ä¾¿æ–¼åŠ å…¥è‡ªå®šç¾©çš„æé†’è¦å‰‡ï¼ˆå¦‚åªæé†’æ¨™è¨˜çš„èª²ç¨‹ï¼‰

## 2. é–‹ç™¼ç’°å¢ƒé™åˆ¶ï¼ˆå¿…è®€ï¼‰âš ï¸

### éƒ¨ç½²ç’°å¢ƒæœ¬è³ª
**æˆ‘å€‘çš„éƒ¨ç½²ç’°å¢ƒï¼šRenderï¼ˆç„¡ç‹€æ…‹ Serverlessï¼‰**

#### ç’°å¢ƒç‰¹æ€§ï¼ˆç¬¬ä¸€æ€§åŸå‰‡ï¼‰
1. **ç„¡ç‹€æ…‹**ï¼šæ¯å€‹ HTTP è«‹æ±‚å¯èƒ½ç”±ä¸åŒçš„å¯¦ä¾‹è™•ç†
2. **çŸ­ç”Ÿå‘½é€±æœŸ**ï¼šå¯¦ä¾‹éš¨æ™‚å¯èƒ½è¢«çµ‚æ­¢å’Œé‡å•Ÿ
3. **ç„¡æŒä¹…è¨˜æ†¶é«”**ï¼šç¨‹åºè¨˜æ†¶é«”æœƒéš¨å¯¦ä¾‹æ¶ˆå¤±
4. **æ°´å¹³æ“´å±•**ï¼šå¤šå€‹å¯¦ä¾‹åŒæ™‚é‹è¡Œï¼Œç„¡æ³•å…±äº«è¨˜æ†¶é«”

| ç‰¹æ€§ | èªªæ˜ | å½±éŸ¿ |
|------|------|------|
| **ç„¡ç‹€æ…‹** | æ¯å€‹è«‹æ±‚å¯èƒ½ç”±ä¸åŒå¯¦ä¾‹è™•ç† | ä¸èƒ½ä¾è³´ç¨‹åºè¨˜æ†¶é«” |
| **è‡ªå‹•ä¼‘çœ ** | 15åˆ†é˜ç„¡æ´»å‹•å¾Œä¼‘çœ  | å†·å•Ÿå‹•å»¶é² |
| **éš¨æ©Ÿé‡å•Ÿ** | éƒ¨ç½²ã€æ›´æ–°ã€æ•…éšœæ™‚é‡å•Ÿ | è¨˜æ†¶é«”è³‡æ–™éºå¤± |
| **æ°´å¹³æ“´å±•** | å¯èƒ½åŒæ™‚é‹è¡Œå¤šå€‹å¯¦ä¾‹ | å¯¦ä¾‹é–“ç„¡æ³•å…±äº«ç‹€æ…‹ |

#### âŒ çµ•å°ä¸å¯ä½¿ç”¨çš„æ–¹æ¡ˆ
- **Map() / Object**ï¼šå­˜åœ¨è¨˜æ†¶é«”ä¸­ï¼Œé‡å•Ÿå°±æ¶ˆå¤±
- **å…¨åŸŸè®Šæ•¸**ï¼šæ¯å€‹å¯¦ä¾‹æœ‰è‡ªå·±çš„å‰¯æœ¬ï¼Œç„¡æ³•åŒæ­¥
- **æœ¬åœ°æª”æ¡ˆç³»çµ±**ï¼šæª”æ¡ˆç³»çµ±æ˜¯è‡¨æ™‚çš„ï¼Œæœƒè¢«æ¸…é™¤
- **SQLite**ï¼šéœ€è¦æœ¬åœ°æª”æ¡ˆï¼Œä¸é©åˆç„¡ç‹€æ…‹ç’°å¢ƒ

```javascript
// éŒ¯èª¤ï¼šä½¿ç”¨è¨˜æ†¶é«”å„²å­˜
const cache = new Map();
const users = {};
let globalState = null;

// éŒ¯èª¤ï¼šä½¿ç”¨æœ¬åœ°æª”æ¡ˆ
const fs = require('fs');
fs.writeFileSync('./data.json', data);

// éŒ¯èª¤ï¼šå‡è¨­å–®ä¸€å¯¦ä¾‹
class Singleton {
  static instance = null;
}
```

#### âœ… å¿…é ˆä½¿ç”¨çš„æ–¹æ¡ˆ
- **Redis**ï¼šçŸ­æœŸç‹€æ…‹ç®¡ç†ï¼ˆå°è©±ä¸Šä¸‹æ–‡ã€å¿«å–ï¼‰
- **Firebase Firestore**ï¼šæ¥­å‹™è³‡æ–™æŒä¹…åŒ–å„²å­˜
- **Firebase Storage**ï¼šæª”æ¡ˆå’Œåœ–ç‰‡å„²å­˜
- **Google Calendar**ï¼šæ™‚é–“é‚è¼¯å’Œæ’ç¨‹ç®¡ç†

```javascript
// æ­£ç¢ºï¼šä½¿ç”¨ Redis
const redis = new Redis(process.env.REDIS_URL);
await redis.set('key', value);

// æ­£ç¢ºï¼šä½¿ç”¨è³‡æ–™åº«
await firebaseService.saveData(data);

// æ­£ç¢ºï¼šç„¡ç‹€æ…‹è¨­è¨ˆ
function processRequest(input) {
  // æ¯æ¬¡éƒ½å¾å¤–éƒ¨ç²å–ç‹€æ…‹
  const state = await redis.get(userId);
  // è™•ç†é‚è¼¯
  await redis.set(userId, newState);
}
```

### æ¶æ§‹è¨­è¨ˆæª¢æŸ¥æ¸…å–®
åœ¨è¨­è¨ˆä»»ä½•åŠŸèƒ½å‰ï¼Œå¿…é ˆç¢ºèªï¼š
- [ ] æ˜¯å¦éœ€è¦è·¨è«‹æ±‚ä¿å­˜ç‹€æ…‹ï¼Ÿ
- [ ] ç‹€æ…‹å„²å­˜æ˜¯å¦ç¨ç«‹æ–¼æ‡‰ç”¨å¯¦ä¾‹ï¼Ÿ
- [ ] æœå‹™é‡å•Ÿå¾ŒåŠŸèƒ½æ˜¯å¦æ­£å¸¸ï¼Ÿ
- [ ] å¤šå¯¦ä¾‹ä¸¦è¡Œæ™‚æ˜¯å¦æœƒæœ‰ç«¶çˆ­æ¢ä»¶ï¼Ÿ
- [ ] æ˜¯å¦æœ‰é©ç•¶çš„éŒ¯èª¤è™•ç†å’Œé™ç´šæ–¹æ¡ˆï¼Ÿ

### å¿…è¦çš„å¤–éƒ¨æœå‹™

1. **Redis**ï¼ˆå°è©±ç‹€æ…‹ç®¡ç†ï¼‰
   - ç”¨é€”ï¼šæš«å­˜å°è©±ä¸Šä¸‹æ–‡
   - æœå‹™ï¼šUpstash æˆ– Redis Labs
   - TTLï¼š30åˆ†é˜è‡ªå‹•éæœŸ

2. **Firebase**ï¼ˆæ¥­å‹™è³‡æ–™ï¼‰
   - ç”¨é€”ï¼šèª²ç¨‹ã€ç”¨æˆ¶ã€è¨˜éŒ„
   - æŒä¹…åŒ–ï¼šæ°¸ä¹…å„²å­˜

3. **Google Calendar**ï¼ˆæ™‚é–“é‚è¼¯ï¼‰
   - ç”¨é€”ï¼šæ’ç¨‹ã€é‡è¤‡è¦å‰‡
   - APIï¼šç„¡ç‹€æ…‹å‘¼å«

## 3. ç’°å¢ƒè®Šæ•¸é…ç½®

### åŸºæœ¬é…ç½®
```bash
# Redisï¼ˆå¿…éœ€ï¼‰- Upstash æ ¼å¼
REDIS_HOST=xxx.upstash.io
REDIS_PORT=6379
REDIS_PASSWORD=default:your_upstash_token_here
REDIS_TLS=true

# Firebaseï¼ˆå¿…éœ€ï¼‰
FIREBASE_PROJECT_ID=xxx
FIREBASE_CLIENT_EMAIL=xxx
FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n"

# LINE Botï¼ˆå¿…éœ€ï¼‰
LINE_CHANNEL_ACCESS_TOKEN=xxx
LINE_CHANNEL_SECRET=xxx

# éƒ¨ç½²ç’°å¢ƒ
NODE_ENV=production
PORT=3000
```

### Upstash Redis é€£æ¥é…ç½® âš ï¸ é‡è¦

Upstash éœ€è¦ç‰¹æ®Šçš„èªè­‰æ ¼å¼ï¼š

```javascript
const Redis = require('ioredis');

const redis = new Redis({
  host: process.env.REDIS_HOST,
  port: parseInt(process.env.REDIS_PORT),
  username: 'default',  // Upstash å›ºå®šä½¿ç”¨ 'default'
  password: process.env.REDIS_PASSWORD.replace('default:', ''),  // ç§»é™¤å‰ç¶´
  tls: {},  // Upstash å¿…éœ€ TLS
  family: 4,
  retryStrategy: (times) => Math.min(times * 50, 2000)
});
```

**ç’°å¢ƒè®Šæ•¸æ ¼å¼**ï¼š
- âœ… æ­£ç¢ºï¼š`REDIS_PASSWORD=default:ATpyAAI...`ï¼ˆä¿ç•™å‰ç¶´ï¼‰
- âŒ éŒ¯èª¤ï¼š`REDIS_PASSWORD=ATpyAAI...`ï¼ˆä¸è¦æ‰‹å‹•ç§»é™¤å‰ç¶´ï¼‰

### é–‹ç™¼æ™‚æ³¨æ„äº‹é …

1. **æœ¬åœ°é–‹ç™¼ vs ç”Ÿç”¢ç’°å¢ƒ**
   ```javascript
   // âŒ éŒ¯èª¤ï¼šé–‹ç™¼ç’°å¢ƒçµ•å°ä¸èƒ½ç”¨ Map
   // å› ç‚ºéƒ¨ç½²ç’°å¢ƒæ˜¯ç„¡ç‹€æ…‹çš„ï¼Œæœ¬åœ°æ¸¬è©¦å¿…é ˆèˆ‡ç”Ÿç”¢ä¸€è‡´
   const storage = new RedisStorage();  // æ°¸é ä½¿ç”¨ Redis
   ```

2. **éŒ¯èª¤è™•ç†**
   ```javascript
   // å¤–éƒ¨æœå‹™å¯èƒ½å¤±æ•—ï¼Œéœ€è¦é™ç´š
   try {
     const context = await redis.get(key);
   } catch (error) {
     console.error('Redis failed, degrading...');
     // é™ç´šç‚ºç„¡ç‹€æ…‹è™•ç†
   }
   ```

3. **å†·å•Ÿå‹•å„ªåŒ–**
   ```javascript
   // å»¶é²åˆå§‹åŒ–ï¼Œé¿å…å•Ÿå‹•æ™‚é€£æ¥æ‰€æœ‰æœå‹™
   let redis;
   function getRedis() {
     if (!redis) redis = new Redis();
     return redis;
   }
   ```

### éƒ¨ç½²å‰æª¢æŸ¥æ¸…å–®

- [ ] æ²’æœ‰ä½¿ç”¨ Map() æˆ–å…¨åŸŸè®Šæ•¸å„²å­˜ç‹€æ…‹
- [ ] æ²’æœ‰ä¾è³´æœ¬åœ°æª”æ¡ˆç³»çµ±
- [ ] æ‰€æœ‰ç‹€æ…‹éƒ½å„²å­˜åœ¨å¤–éƒ¨æœå‹™
- [ ] æœ‰é©ç•¶çš„éŒ¯èª¤è™•ç†å’Œé™ç´šæ–¹æ¡ˆ
- [ ] ç’°å¢ƒè®Šæ•¸éƒ½å·²æ­£ç¢ºè¨­å®š
- [ ] è€ƒæ…®äº†å†·å•Ÿå‹•çš„å½±éŸ¿

### å¸¸è¦‹éŒ¯èª¤æ¡ˆä¾‹

1. **å°è©±ç®¡ç†å™¨ä½¿ç”¨ Map**
   - å•é¡Œï¼šæœå‹™é‡å•Ÿå¾Œå°è©±ä¸Šä¸‹æ–‡æ¶ˆå¤±
   - è§£æ³•ï¼šæ”¹ç”¨ Redis

2. **æª”æ¡ˆä¸Šå‚³åˆ°æœ¬åœ°**
   - å•é¡Œï¼šæª”æ¡ˆæœƒè¢«æ¸…é™¤
   - è§£æ³•ï¼šç›´æ¥ä¸Šå‚³åˆ° Firebase Storage

3. **ä½¿ç”¨ setTimeout åšå®šæ™‚ä»»å‹™**
   - å•é¡Œï¼šæœå‹™å¯èƒ½åœ¨åŸ·è¡Œå‰é‡å•Ÿ
   - è§£æ³•ï¼šä½¿ç”¨ Firebase Scheduled Functions

## 4. ç³»çµ±æ¶æ§‹

### ğŸ¯ æ ¸å¿ƒæ¶æ§‹

**ç›®æ¨™**ï¼šå¿«é€Ÿä¸Šç·šï¼Œé©—è­‰ç”¢å“æ¦‚å¿µ

**æŠ€è¡“ç‰¹å¾µ**ï¼š
- è¦å‰‡å„ªå…ˆçš„æ„åœ–è­˜åˆ¥ï¼ˆæ¸›å°‘ API æˆæœ¬ï¼‰
- ç°¡åŒ–çš„è³‡æ–™æ¨¡å‹
- å–®é«”å¼æ¶æ§‹ï¼Œä¾¿æ–¼éƒ¨ç½²

**æ¶æ§‹åœ–**ï¼š
```
LINE Bot â†’ Express Server â†’ Intent Parser â†’ Task Handler â†’ Google Calendar
                                                        â†˜
                                                         Firebase
```

### Feature Flag ç­–ç•¥

#### è¨­è¨ˆç†å¿µ
é€é Feature Flag å¯¦ç¾æ¼¸é€²å¼ç™¼å¸ƒï¼Œé™ä½é¢¨éšªã€‚

#### å¯¦ä½œæ–¹å¼
```javascript
// src/config/features.js
const FEATURES = {
  SLOT_TEMPLATE_SYSTEM: {
    enabled: false,
    phase: 'Phase 2',
    rolloutPercentage: 0,  // ç°åº¦ç™¼å¸ƒç™¾åˆ†æ¯”
    enabledUsers: []       // ç™½åå–®ç”¨æˆ¶
  }
};
```

#### å‡ç´šæµç¨‹
1. **é–‹ç™¼éšæ®µ**ï¼šenabled = falseï¼Œåƒ…é–‹ç™¼ç’°å¢ƒæ¸¬è©¦
2. **ç°åº¦ç™¼å¸ƒ**ï¼šrolloutPercentage = 10ï¼Œ10% ç”¨æˆ¶é«”é©—æ–°åŠŸèƒ½
3. **å…¨é¢ç™¼å¸ƒ**ï¼šenabled = trueï¼Œæ‰€æœ‰ç”¨æˆ¶ä½¿ç”¨æ–°åŠŸèƒ½

## 5. æŠ€è¡“å‚µå‹™ç®¡ç†

### ç•¶å‰å·²çŸ¥çš„æŠ€è¡“å‚µå‹™
1. **ç¼ºä¹è‡ªå‹•åŒ–æ¸¬è©¦**
   - å½±éŸ¿ï¼šé‡æ§‹é¢¨éšªé«˜
   - è¨ˆç•«ï¼šåŠ å…¥å–®å…ƒæ¸¬è©¦å’Œæ•´åˆæ¸¬è©¦

2. **éŒ¯èª¤è™•ç†ä¸å¤ å®Œå–„**
   - å½±éŸ¿ï¼šç”¨æˆ¶é«”é©—ä¸ä½³
   - è¨ˆç•«ï¼šå»ºç«‹çµ±ä¸€çš„éŒ¯èª¤è™•ç†ä¸­é–“ä»¶

3. **æ—¥èªŒç³»çµ±ç°¡é™‹**
   - å½±éŸ¿ï¼šå•é¡Œè¿½è¹¤å›°é›£
   - è¨ˆç•«ï¼šæ•´åˆ Cloud Logging

### å„Ÿé‚„ç­–ç•¥
- æ¯å€‹ Sprint åˆ†é… 20% æ™‚é–“è™•ç†æŠ€è¡“å‚µå‹™
- å„ªå…ˆè™•ç†å½±éŸ¿ç”¨æˆ¶é«”é©—çš„é …ç›®
- å»ºç«‹æŠ€è¡“å‚µå‹™è¿½è¹¤çœ‹æ¿

è©³ç´°çš„æŠ€è¡“å‚µè¨˜éŒ„è«‹åƒè€ƒ [technical-debt.md](../doc/technical-debt.md)

ä¸»è¦æŠ€è¡“å‚µé …ç›®ï¼š
1. **LINE Bot åœ–ç‰‡ä¸‹è¼‰ 404 éŒ¯èª¤** - é«˜å„ªå…ˆç´šï¼Œå½±éŸ¿åœ–ç‰‡ä¸Šå‚³åŠŸèƒ½
2. **å°è©±ç‹€æ…‹æŒä¹…åŒ–** - ä¸­å„ªå…ˆç´šï¼Œå½±éŸ¿ç”¨æˆ¶é«”é©—
3. **éŒ¯èª¤æ¢å¾©æ©Ÿåˆ¶** - ä¸­å„ªå…ˆç´šï¼Œå½±éŸ¿è³‡æ–™ä¸€è‡´æ€§

## 6. æ“´å±•æ€§è€ƒé‡

### å‚ç›´æ“´å±•
- ç•¶å‰æ¶æ§‹æ”¯æ´åˆ° ~1000 æ´»èºç”¨æˆ¶
- ç“¶é ¸ï¼šå–®ä¸€ Google Service Account çš„ API é…é¡

### æ°´å¹³æ“´å±•ç­–ç•¥
1. **å¤š Service Account**ï¼šçªç ´ API é™åˆ¶
2. **è®€å¯«åˆ†é›¢**ï¼šFirebase æŸ¥è©¢å„ªåŒ–
3. **å€åŸŸéƒ¨ç½²**ï¼šé™ä½å»¶é²

### æˆæœ¬å„ªåŒ–
- ä½¿ç”¨ Firestore æŸ¥è©¢ç´¢å¼•æ¸›å°‘è®€å–æ¬¡æ•¸
- å¯¦æ–½ API å‘¼å«å¿«å–æ©Ÿåˆ¶
- æ¡ç”¨ Cloud Scheduler å–ä»£é«˜é »è¼ªè©¢

## 7. å®‰å…¨æ€§è¨­è¨ˆ

### ç•¶å‰å¯¦æ–½
- LINE Signature é©—è­‰
- ç’°å¢ƒè®Šæ•¸ç®¡ç†æ•æ„Ÿè³‡è¨Š
- Firebase Security Rules

### æœªä¾†åŠ å¼·
- API Rate Limiting
- ç”¨æˆ¶è³‡æ–™åŠ å¯†
- å®šæœŸå®‰å…¨å¯©è¨ˆ

## 8. ç›£æ§èˆ‡å¯è§€æ¸¬æ€§

### åŸºç¤ç›£æ§ï¼ˆç•¶å‰ï¼‰
- Console æ—¥èªŒ
- åŸºæœ¬éŒ¯èª¤è¿½è¹¤

### é€²éšç›£æ§ï¼ˆæœªä¾†ï¼‰
- Application Performance Monitoring
- è‡ªå®šç¾©æŒ‡æ¨™å„€è¡¨æ¿
- å‘Šè­¦æ©Ÿåˆ¶

### æ™ºæ…§é‹ç¶­ï¼ˆé•·æœŸï¼‰
- é æ¸¬æ€§å‘Šè­¦
- è‡ªå‹•åŒ–å•é¡Œè¨ºæ–·
- SLA ç›£æ§

## 9. é—œéµè¨­è¨ˆæ±ºç­–èˆ‡å¯¦ä½œç´°ç¯€

æœ¬ç¯€æ¾„æ¸…æ–‡æª”é–“çš„çŸ›ç›¾ï¼Œæä¾›æ˜ç¢ºçš„å¯¦ä½œæŒ‡å¼•ã€‚

### 9.1 æé†’ç³»çµ±æ¶æ§‹

**æ±ºç­–ï¼šæ¡ç”¨ç¨ç«‹ `/reminders` é›†åˆ**

```javascript
// Firebase çµæ§‹
/reminders/{reminderId}: {
  courseId: "èª²ç¨‹ID",
  userId: "LINEç”¨æˆ¶ID",
  studentName: "å­¸ç”Ÿåç¨±",
  courseName: "èª²ç¨‹åç¨±",
  reminderTime: 30, // æå‰å¹¾åˆ†é˜
  triggerTime: "2025-01-15T13:30:00+08:00",
  executed: false
}

/courses/{courseId}: {
  hasReminder: true  // åƒ…ä½œç‚º UI æ¨™è¨˜
}
```

### 9.2 è³‡æ–™åŒæ­¥ç­–ç•¥

**æ±ºç­–ï¼šå³æ™‚å¯«å…¥ç‚ºä¸»ï¼Œå®šæ™‚åŒæ­¥ç‚ºè¼”**

- **å³æ™‚å¯«å…¥**ï¼šæ–°å¢/ä¿®æ”¹/åˆªé™¤èª²ç¨‹æ™‚åŒæ­¥æ›´æ–°å…©é‚Š
- **å®šæ™‚åŒæ­¥**ï¼šæ¯æ—¥å‡Œæ™¨æ ¡é©—è³‡æ–™ä¸€è‡´æ€§ï¼Œä¸è¦†è“‹åªæ¨™è¨˜

### 9.3 çµ±ä¸€å‘½åè¦ç¯„

| æ¦‚å¿µ | æ­£ç¢ºç”¨è© | ç¦ç”¨è© |
|------|----------|---------|
| å­¸ç”Ÿ | student, studentName | child, kid |
| èª²ç¨‹ | course, courseName | lesson, class |
| æ™‚é–“ | scheduleTime | time, classTime |

### 9.4 Calendar è­˜åˆ¥ç¢¼æ¾„æ¸…

- **calendarId**ï¼šGoogle è‡ªå‹•ç”Ÿæˆï¼ˆå¦‚ `x7i2...@group.calendar.google.com`ï¼‰
- **summary**ï¼šé¡¯ç¤ºåç¨±ï¼ˆå¦‚ "å°æ˜çš„èª²ç¨‹è¡¨"ï¼‰

### 9.5 éŒ¯èª¤è™•ç†ç­–ç•¥

**åœ–ç‰‡ä¸Šå‚³å¤±æ•—**ï¼š
- æ–‡å­—å…§å®¹å„ªå…ˆä¿å­˜
- åœ–ç‰‡å®¹è¨±éƒ¨åˆ†å¤±æ•—
- è¿”å›éƒ¨åˆ†æˆåŠŸè¨Šæ¯

**è³‡æ–™ä¸ä¸€è‡´**ï¼š
- Google æˆåŠŸ Firebase å¤±æ•—ï¼šé‡è©¦3æ¬¡
- Firebase æˆåŠŸ Google å¤±æ•—ï¼šå›æ»¾æ“ä½œ

### 9.6 æ„åœ–å„ªå…ˆç´šé‚è¼¯

1. é—œéµè©åŒ¹é…è©•åˆ†ï¼ˆè¶Šå¤šè¶Šå„ªå…ˆï¼‰
2. ç›¸åŒåˆ†æ•¸çœ‹ priorityï¼ˆæ•¸å­—è¶Šå°è¶Šå„ªå…ˆï¼‰
3. ç„¡æ³•åˆ¤æ–·æ™‚å‘¼å« OpenAI

### 9.7 å°è©±ç‹€æ…‹ç®¡ç†è¨­è¨ˆ

**åŸºç¤çµæ§‹**ï¼š
```javascript
// Redis çŸ­æœŸå„²å­˜ï¼Œ30åˆ†é˜è¶…æ™‚
const conversationState = new Map();

// å®Œæ•´çš„å°è©±ç‹€æ…‹çµæ§‹
{
  userId: {
    lastIntent: "query_schedule",
    lastActivity: Date.now(),
    context: {
      // æ ¸å¿ƒå¯¦é«”
      studentName: "å°æ˜",
      courseName: "æ•¸å­¸èª²",
      courseDate: "2025-01-15",
      
      // å°è©±æ­·å²ï¼ˆæœ€å¤šä¿ç•™3è¼ªï¼‰
      history: [
        { role: "user", message: "å°æ˜ä»Šå¤©æœ‰èª²å—ï¼Ÿ" },
        { role: "bot", message: "å°æ˜ä»Šå¤©æœ‰æ•¸å­¸èª²å’Œè‹±æ–‡èª²" }
      ],
      
      // æœ€å¾Œæåˆ°çš„å¯¦é«”
      lastMentioned: {
        students: ["å°æ˜"],
        courses: ["æ•¸å­¸èª²", "è‹±æ–‡èª²"],
        dates: ["ä»Šå¤©"]
      }
    }
  }
}
```

**ä¸Šä¸‹æ–‡å‚³éé‚è¼¯**ï¼š
```javascript
// å¾ä¸Šä¸‹æ–‡è£œå……ç¼ºå¤±çš„ slots
function enrichSlotsFromContext(slots, context) {
  // 1. å¦‚æœç¼ºå°‘ studentNameï¼Œå¾æœ€å¾Œæåˆ°çš„å­¸ç”Ÿå–å¾—
  if (!slots.studentName && context.lastMentioned.students.length > 0) {
    slots.studentName = context.lastMentioned.students[0];
  }
  
  // 2. å¦‚æœç¼ºå°‘ courseNameï¼Œæ ¹æ“šé—œéµè©åŒ¹é…
  if (!slots.courseName && context.lastMentioned.courses.length > 0) {
    // ä¾‹å¦‚ç”¨æˆ¶èªªã€Œè¨˜éŒ„æ•¸å­¸èª²ã€ï¼ŒåŒ¹é…ã€Œæ•¸å­¸ã€
    for (const course of context.lastMentioned.courses) {
      if (userMessage.includes(course.substring(0, 2))) {
        slots.courseName = course;
        break;
      }
    }
  }
  
  // 3. æ™‚é–“åƒè€ƒç¹¼æ‰¿
  if (!slots.courseDate && context.courseDate) {
    slots.courseDate = context.courseDate;
  }
  
  return slots;
}

// å°è©±ç‹€æ…‹è¶…æ™‚è™•ç†
function handleExpiredContext(userId, newIntent) {
  const state = conversationState.get(userId);
  
  if (!state || Date.now() - state.lastActivity > 30 * 60 * 1000) {
    // è¶…æ™‚æˆ–ç„¡ç‹€æ…‹
    return {
      needsFullInfo: true,
      message: "æ‚¨å¥½ï¼Œè®“æˆ‘å€‘é‡æ–°é–‹å§‹ã€‚è«‹å‘Šè¨´æˆ‘å®Œæ•´çš„è³‡è¨Šã€‚"
    };
  }
  
  // æª¢æŸ¥æ˜¯å¦éœ€è¦ä¹‹å‰çš„ä¸Šä¸‹æ–‡
  const contextDependentIntents = ['record_content', 'set_reminder', 'cancel_course'];
  if (contextDependentIntents.includes(newIntent) && !state.context.studentName) {
    return {
      needsFullInfo: true,
      message: "è«‹å‘Šè¨´æˆ‘æ˜¯å“ªä½å­¸ç”Ÿçš„å“ªé–€èª²ç¨‹ï¼Ÿ"
    };
  }
  
  return { needsFullInfo: false };
}
```

### 9.8 èª²ç¨‹æ™‚é–“è¡çªè™•ç†

**è¡çªæª¢æ¸¬è¦å‰‡**ï¼š
```javascript
// è¡çªæª¢æ¸¬é…ç½®
const CONFLICT_RULES = {
  bufferTime: 30,        // èª²ç¨‹é–“éš”ç·©è¡æ™‚é–“ï¼ˆåˆ†é˜ï¼‰
  overlapAllowed: false, // æ˜¯å¦å…è¨±æ™‚é–“é‡ç–Š
  transportTime: {       // ä¸åŒåœ°é»é–“çš„äº¤é€šæ™‚é–“
    "default": 30,
    "same_location": 0
  }
};

// è¡çªæª¢æ¸¬å‡½å¼
async function checkTimeConflict(studentName, newCourse) {
  const startTime = new Date(`${newCourse.date}T${newCourse.time}:00`);
  const endTime = new Date(startTime.getTime() + newCourse.duration * 60000);
  
  // æŸ¥è©¢å‰å¾Œå„ 2 å°æ™‚çš„èª²ç¨‹
  const rangeStart = new Date(startTime.getTime() - 2 * 60 * 60000);
  const rangeEnd = new Date(endTime.getTime() + 2 * 60 * 60000);
  
  const existingCourses = await queryCoursesInRange(studentName, rangeStart, rangeEnd);
  
  const conflicts = [];
  for (const course of existingCourses) {
    const courseStart = new Date(`${course.date}T${course.time}:00`);
    const courseEnd = new Date(courseStart.getTime() + course.duration * 60000);
    
    // æª¢æŸ¥æ™‚é–“é‡ç–Š
    if (startTime < courseEnd && endTime > courseStart) {
      conflicts.push({
        type: 'overlap',
        course: course,
        message: `èˆ‡ ${course.courseName} æ™‚é–“é‡ç–Š`
      });
    }
    // æª¢æŸ¥é–“éš”æ™‚é–“
    else if (Math.abs(startTime - courseEnd) < CONFLICT_RULES.bufferTime * 60000) {
      conflicts.push({
        type: 'buffer',
        course: course,
        message: `èˆ‡ ${course.courseName} é–“éš”ä¸è¶³ ${CONFLICT_RULES.bufferTime} åˆ†é˜`
      });
    }
  }
  
  return conflicts;
}
```

**è¡çªè™•ç†æµç¨‹**ï¼š
```javascript
// è™•ç†ä½¿ç”¨è€…å›æ‡‰
async function handleConflictDecision(conflicts, userDecision, newCourse) {
  if (userDecision === 'continue') {
    // 1. æ¨™è¨˜ç‚ºã€Œæœ‰è¡çªä½†ä½¿ç”¨è€…ç¢ºèªã€
    newCourse.hasConflict = true;
    newCourse.conflictDetails = conflicts;
    
    // 2. åœ¨ Google Calendar äº‹ä»¶æè¿°ä¸­åŠ å…¥è¡çªæç¤º
    newCourse.description = `âš ï¸ æ³¨æ„ï¼š${conflicts[0].message}\n${newCourse.description || ''}`;
    
    // 3. æ­£å¸¸å»ºç«‹èª²ç¨‹
    return await createCourse(newCourse);
  } 
  else if (userDecision === 'modify') {
    // è¿”å›å»ºè­°çš„å¯ç”¨æ™‚æ®µ
    return {
      success: false,
      suggestions: await findAvailableTimeSlots(newCourse.studentName, newCourse.date)
    };
  }
  else { // cancel
    return {
      success: false,
      message: "å·²å–æ¶ˆæ–°å¢èª²ç¨‹"
    };
  }
}
```

**é‡è¤‡èª²ç¨‹çš„ç‰¹æ®Šè™•ç†**ï¼š
```javascript
// æª¢æŸ¥é‡è¤‡èª²ç¨‹çš„æ‰€æœ‰å¯¦ä¾‹
async function checkRecurringConflicts(pattern, duration = 4) {
  // æª¢æŸ¥æœªä¾† 4 é€±çš„è¡çª
  const conflicts = [];
  const instances = generateRecurringInstances(pattern, duration);
  
  for (const instance of instances) {
    const instanceConflicts = await checkTimeConflict(instance.studentName, instance);
    if (instanceConflicts.length > 0) {
      conflicts.push({
        date: instance.date,
        conflicts: instanceConflicts
      });
    }
  }
  
  // å¦‚æœè¶…é 20% çš„å¯¦ä¾‹æœ‰è¡çªï¼Œæé†’ä½¿ç”¨è€…
  if (conflicts.length > instances.length * 0.2) {
    return {
      hasConflicts: true,
      conflictRate: conflicts.length / instances.length,
      details: conflicts,
      message: `æ­¤é‡è¤‡èª²ç¨‹åœ¨æœªä¾† ${duration} é€±å…§æœ‰ ${conflicts.length} æ¬¡æ™‚é–“è¡çª`
    };
  }
  
  return { hasConflicts: false };
}
```

## ç¸½çµ

æœ¬æ¶æ§‹è¨­è¨ˆéµå¾ªä»¥ä¸‹åŸå‰‡ï¼š
1. **ç„¡ç‹€æ…‹å„ªå…ˆ**ï¼šæ‰€æœ‰ç‹€æ…‹å„²å­˜åœ¨å¤–éƒ¨æœå‹™
2. **æŠ€è¡“å‚µå‹™å¯æ§**ï¼šå®šæœŸè©•ä¼°å’Œå„Ÿé‚„
3. **æˆæœ¬æ•ˆç›Šå¹³è¡¡**ï¼šé¸æ“‡åˆé©çš„æŠ€è¡“ï¼Œè€Œéæœ€æ–°çš„æŠ€è¡“
4. **å¯ç¶­è­·æ€§å„ªå…ˆ**ï¼šä»£ç¢¼æ¸…æ™°æ¯”æ•ˆèƒ½å„ªåŒ–æ›´é‡è¦ï¼ˆåœ¨åˆç†ç¯„åœå…§ï¼‰

è©³ç´°çš„å¯¦ä½œæŒ‡å—è«‹åƒè€ƒ [Developer Guide](../doc/developer-guide.md)ã€‚

---

## åƒè€ƒè³‡æ–™

- [Render æ–‡æª” - ç„¡ç‹€æ…‹æ‡‰ç”¨](https://render.com/docs/web-services)
- [Vercel æ–‡æª” - Serverless Functions](https://vercel.com/docs/functions)
- [Redis æœ€ä½³å¯¦è¸](https://redis.io/docs/manual/patterns/)