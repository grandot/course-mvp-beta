# Developer Guide

æ­¡è¿ä¾†åˆ° LINE èª²ç¨‹ç®¡ç†æ©Ÿå™¨äººå°ˆæ¡ˆï¼é€™ä»½æŒ‡å—å°‡å¹«åŠ©ä½ å¿«é€Ÿç†è§£ç³»çµ±æ¶æ§‹å’Œé–‹ç™¼æµç¨‹ã€‚

## 0. é–‹ç™¼ç’°å¢ƒé™åˆ¶ï¼ˆå¿…è®€ï¼‰âš ï¸

### éƒ¨ç½²ç’°å¢ƒæœ¬è³ª
**æˆ‘å€‘çš„éƒ¨ç½²ç’°å¢ƒï¼šRenderï¼ˆç„¡ç‹€æ…‹ Serverlessï¼‰**

#### ç’°å¢ƒç‰¹æ€§ï¼ˆç¬¬ä¸€æ€§åŸå‰‡ï¼‰
1. **ç„¡ç‹€æ…‹**ï¼šæ¯å€‹ HTTP è«‹æ±‚å¯èƒ½ç”±ä¸åŒçš„å¯¦ä¾‹è™•ç†
2. **çŸ­ç”Ÿå‘½é€±æœŸ**ï¼šå¯¦ä¾‹éš¨æ™‚å¯èƒ½è¢«çµ‚æ­¢å’Œé‡å•Ÿ
3. **ç„¡æŒä¹…è¨˜æ†¶é«”**ï¼šç¨‹åºè¨˜æ†¶é«”æœƒéš¨å¯¦ä¾‹æ¶ˆå¤±
4. **æ°´å¹³æ“´å±•**ï¼šå¤šå€‹å¯¦ä¾‹åŒæ™‚é‹è¡Œï¼Œç„¡æ³•å…±äº«è¨˜æ†¶é«”

#### âŒ çµ•å°ä¸å¯ä½¿ç”¨çš„æ–¹æ¡ˆ
- **Map() / Object**ï¼šå­˜åœ¨è¨˜æ†¶é«”ä¸­ï¼Œé‡å•Ÿå°±æ¶ˆå¤±
- **å…¨åŸŸè®Šæ•¸**ï¼šæ¯å€‹å¯¦ä¾‹æœ‰è‡ªå·±çš„å‰¯æœ¬ï¼Œç„¡æ³•åŒæ­¥
- **æœ¬åœ°æª”æ¡ˆç³»çµ±**ï¼šæª”æ¡ˆç³»çµ±æ˜¯è‡¨æ™‚çš„ï¼Œæœƒè¢«æ¸…é™¤
- **SQLite**ï¼šéœ€è¦æœ¬åœ°æª”æ¡ˆï¼Œä¸é©åˆç„¡ç‹€æ…‹ç’°å¢ƒ

#### âœ… å¿…é ˆä½¿ç”¨çš„æ–¹æ¡ˆ
- **Redis**ï¼šçŸ­æœŸç‹€æ…‹ç®¡ç†ï¼ˆå°è©±ä¸Šä¸‹æ–‡ã€å¿«å–ï¼‰
- **Firebase Firestore**ï¼šæ¥­å‹™è³‡æ–™æŒä¹…åŒ–å„²å­˜
- **Firebase Storage**ï¼šæª”æ¡ˆå’Œåœ–ç‰‡å„²å­˜
- **Google Calendar**ï¼šæ™‚é–“é‚è¼¯å’Œæ’ç¨‹ç®¡ç†

### æ¶æ§‹è¨­è¨ˆæª¢æŸ¥æ¸…å–®
åœ¨è¨­è¨ˆä»»ä½•åŠŸèƒ½å‰ï¼Œå¿…é ˆç¢ºèªï¼š
- [ ] æ˜¯å¦éœ€è¦è·¨è«‹æ±‚ä¿å­˜ç‹€æ…‹ï¼Ÿ
- [ ] ç‹€æ…‹å„²å­˜æ˜¯å¦ç¨ç«‹æ–¼æ‡‰ç”¨å¯¦ä¾‹ï¼Ÿ
- [ ] æœå‹™é‡å•Ÿå¾ŒåŠŸèƒ½æ˜¯å¦æ­£å¸¸ï¼Ÿ
- [ ] å¤šå¯¦ä¾‹ä¸¦è¡Œæ™‚æ˜¯å¦æœƒæœ‰ç«¶çˆ­æ¢ä»¶ï¼Ÿ
- [ ] æ˜¯å¦æœ‰é©ç•¶çš„éŒ¯èª¤è™•ç†å’Œé™ç´šæ–¹æ¡ˆï¼Ÿ

### å„²å­˜æ–¹æ¡ˆé¸æ“‡æŒ‡å—

| é¡åˆ¥ | ä½¿ç”¨ Redis | ä½¿ç”¨ Firebase Firestore | åŸå›  |
|------|-----------|------------------------|------|
| **å°è©±è¨˜æ†¶**<br>ï¼ˆcurrentFlowã€expectingInputï¼‰ | âœ… | âŒ | çŸ­æœŸç‹€æ…‹ï¼Œ30åˆ†é˜éæœŸ |
| **Quick Reply ä¸Šä¸‹æ–‡**<br>ï¼ˆlastActionsã€pendingDataï¼‰ | âœ… | âŒ | è‡¨æ™‚äº’å‹•ç‹€æ…‹ï¼Œæ¯«ç§’ç´šè®€å– |
| **èª²ç¨‹ç´€éŒ„**<br>ï¼ˆæ—¥æœŸã€å…§å®¹ã€è€å¸«ï¼‰ | âŒ | âœ… | æ¥­å‹™æ ¸å¿ƒè³‡æ–™ï¼Œéœ€æ°¸ä¹…ä¿å­˜ |
| **åœ–ç‰‡ï¼å½±ç‰‡é€£çµ** | âŒ | âœ… | æª”æ¡ˆå…ƒè³‡æ–™ï¼Œé—œè¯æ¥­å‹™è¨˜éŒ„ |
| **èª²ç¨‹å­¸ç¿’æ‘˜è¦é€±å ±** | âŒ | âœ… | é•·æœŸåˆ†æè³‡æ–™ï¼Œéœ€æŒä¹…åŒ– |
| **ä½¿ç”¨è€…è¨­å®š**<br>ï¼ˆå¤šå­å¥³ã€åå¥½ï¼‰ | âŒ | âœ… | ç”¨æˆ¶å€‹äººè³‡æ–™ï¼Œè·¨æœƒè©±ä½¿ç”¨ |
| **èªæ„ä»»å‹™æ­·ç¨‹**<br>ï¼ˆChronix Engine é•·æœŸä»»å‹™ç‹€æ…‹ï¼‰ | âŒ | âœ… | ä»»å‹™ç”Ÿå‘½é€±æœŸç®¡ç† |
| **æ„åœ–è­˜åˆ¥å¿«å–**<br>ï¼ˆå¸¸è¦‹å•å¥çµæœï¼‰ | âœ… | âŒ | æ•ˆèƒ½å„ªåŒ–ï¼Œå¯é‡æ–°è¨ˆç®— |

### é¸æ“‡åŸå‰‡
- **Redis**ï¼šæœƒè©±ç´šåˆ¥ã€å¯é‡æ–°è¨ˆç®—ã€æ•ˆèƒ½æ•æ„Ÿ
- **Firebase**ï¼šæ¥­å‹™æ ¸å¿ƒã€éœ€è¦æŸ¥è©¢ã€è·¨æœƒè©±ä½¿ç”¨

> âš ï¸ **é‡è¦æé†’**ï¼šæ‰€æœ‰æ¶‰åŠç‹€æ…‹ç®¡ç†çš„è¨­è¨ˆï¼Œéƒ½å¿…é ˆè€ƒæ…®ç„¡ç‹€æ…‹ç’°å¢ƒçš„é™åˆ¶
>
> è©³ç´°è³‡è¨Šè«‹åƒè€ƒï¼š`/doc/ENVIRONMENT.md`

### å°è©±æ™‚é–“çª—èˆ‡ä¸Šä¸‹æ–‡åŸå‰‡ï¼ˆé‡è¦ï¼‰

- ä¸‰ç¨®æ™‚é–“è¦–çª—ï¼ˆå¯é…ç½®/å…§å»ºï¼‰ï¼š
  - 2 åˆ†é˜ã€ŒæœŸå¾…è¼¸å…¥ã€è¶…æ™‚ï¼šç”¨æ–¼ Quick Reply/è£œå……æ¬„ä½æµç¨‹ï¼Œé€¾æ™‚æ¸…é™¤ `expectingInput/pendingData`ã€‚
  - ç´„ 1 åˆ†é˜ã€ŒæŸ¥è©¢æœƒè©±é–ã€ï¼šé™å®šåŒä¸€è¼ªæŸ¥è©¢çš„å­¸ç”Ÿ/æ™‚é–“ï¼ˆ`QUERY_SESSION_TTL_MS`ï¼Œé è¨­ 60000msï¼‰ã€‚
  - 5 åˆ†é˜ã€Œå°è©±è¨˜æ†¶ TTLã€ï¼š`CONVERSATION_TTL_SECONDS`ï¼ˆé è¨­ 300 ç§’ï¼‰ï¼Œä¿å­˜æœ€è¿‘æåŠçš„å­¸ç”Ÿ/èª²å/æ™‚é–“ç­‰ã€‚

- ä¸Šä¸‹æ–‡è£œå€¼åˆ†é¡åŸå‰‡ï¼š
  - è®€å–å‹æŸ¥è©¢ï¼ˆ`query_schedule`ã€`query_course_content`ï¼‰ï¼šä¸è‡ªå‹•è£œ `courseName`ï¼ˆé¿å…æŠŠå¯¬æŸ¥è©¢èª¤ç¸®çª„ï¼‰ï¼›å…è¨±è£œ `studentName/æ™‚é–“åƒè€ƒ`ã€‚
  - å¯«å…¥/ä¿®æ”¹å‹ï¼ˆæ–°å¢/ä¿®æ”¹/å–æ¶ˆ/æé†’/è¨˜éŒ„ï¼‰ï¼šåƒ…åœ¨æœ‰æ˜ç¢ºéŒ¨é»æ™‚è£œå€¼ï¼ˆæ­£åœ¨æœŸå¾…è¼¸å…¥ï¼Œæˆ–å‰›å®Œæˆçš„æœ€è¿‘æ“ä½œåœ¨çŸ­çª—å…§ï¼‰ï¼Œå¦å‰‡å¯§å¯è«‹ç”¨æˆ¶æ˜ç¢ºèªªæ˜ã€‚

- èª²åæ­£è¦åŒ–ï¼ˆæŸ¥è©¢ï¼‰ï¼š
  - éæ¿¾æ¡ç”¨ã€Œç§»é™¤å°¾å­—ã€èª²ã€ï¼‹é›™å‘åŒ…å«ã€æ¯”å°ï¼Œæå‡ã€Œè·†æ‹³é“ã€èˆ‡ã€Œè·†æ‹³é“èª²ã€çš„ä¸€è‡´æ€§ã€‚

## 1. ç³»çµ±ç¸½è¦½èˆ‡æ¨¡çµ„åˆ†å·¥

### æ ¸å¿ƒç†å¿µ
æˆ‘å€‘å€Ÿç”¨ Google Calendar è™•ç†è¤‡é›œçš„æ™‚é–“é‚è¼¯ï¼ˆé‡è¤‡è¦å‰‡ã€è¡çªæª¢æ¸¬ï¼‰ï¼Œç”¨ Firebase å„²å­˜æ¥­å‹™è³‡æ–™ã€‚å…©è€…åˆ†å·¥æ˜ç¢ºï¼Œä¸é‡è¤‡é€ è¼ªå­ã€‚

### æ¨¡çµ„æ¶æ§‹
```
LINE Bot â†’ æ„åœ–è­˜åˆ¥ â†’ å¯¦é«”æå– â†’ ä»»å‹™åŸ·è¡Œ â†’ è³‡æ–™å„²å­˜
   â†‘                                          â†“
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å›è¦†çµæœ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 2. ä½¿ç”¨æµç¨‹ï¼šå¾ LINE è¨Šæ¯åˆ°è³‡æ–™å¯«å…¥çš„å…¨æµç¨‹åœ–

```mermaid
graph LR
    A[ä½¿ç”¨è€…ç™¼é€LINEè¨Šæ¯] --> B[bot/webhook.js æ¥æ”¶]
    B --> C[intent/parseIntent.js åˆ¤æ–·æ„åœ–]
    C --> D[intent/extractSlots.js æå–å¯¦é«”]
    D --> E[tasks/handle_XXX_task.js åŸ·è¡Œä»»å‹™]
    E --> F{å¯«å…¥è³‡æ–™}
    F --> G[Google Calendar API]
    F --> H[Firebase Firestore]
    G --> I[å›å‚³æˆåŠŸè¨Šæ¯çµ¦ä½¿ç”¨è€…]
    H --> I
```

### å¯¦éš›ç¯„ä¾‹æµç¨‹
```
ä½¿ç”¨è€…ï¼šã€Œå°æ˜æ¯é€±ä¸‰ä¸‹åˆ3é»æ•¸å­¸èª²ã€
â†“
æ„åœ–è­˜åˆ¥ï¼šadd_course (æ–°å¢èª²ç¨‹)
â†“
å¯¦é«”æå–ï¼š{studentName: "å°æ˜", scheduleTime: "15:00", courseName: "æ•¸å­¸èª²", recurring: true}
â†“
åŸ·è¡Œä»»å‹™ï¼š
  1. æŸ¥è©¢ Firebase æ‰¾åˆ°å°æ˜çš„ calendarId
  2. å‘¼å« Google Calendar API å»ºç«‹é‡è¤‡äº‹ä»¶
  3. å°‡èª²ç¨‹è³‡è¨Šå­˜å…¥ Firebase /courses
â†“
å›è¦†ï¼šã€Œâœ… å°æ˜æ¯é€±ä¸‰ä¸‹åˆ3:00çš„æ•¸å­¸èª²å·²å®‰æ’å¥½äº†ã€
```

## 3. å„æ¨¡çµ„èªªæ˜

### ğŸ“ `/bot/` - LINE Webhook è™•ç†å±¤
**ä¸»è¦æª”æ¡ˆ**ï¼š`webhook.js`
**é€²å…¥é»å‡½å¼**ï¼š`handleWebhook(req, res)`

```javascript
// æ ¸å¿ƒé‚è¼¯
async function handleWebhook(req, res) {
  const events = req.body.events;
  for (const event of events) {
    if (event.type === 'message' && event.message.type === 'text') {
      const userMessage = event.message.text;
      const userId = event.source.userId;
      
      // å‘¼å«æ„åœ–è­˜åˆ¥
      const intent = await parseIntent(userMessage);
      // æå–å¯¦é«”
      const slots = await extractSlots(userMessage, intent);
      // åŸ·è¡Œå°æ‡‰ä»»å‹™
      const result = await executeTask(intent, slots, userId);
      // å›è¦†LINEè¨Šæ¯
      await replyMessage(event.replyToken, result.message);
    }
  }
}
```

### ğŸ“ `/intent/` - èªæ„åˆ†æå±¤
**ä¸»è¦æª”æ¡ˆ**ï¼š
- `parseIntent.js` - åˆ¤æ–·ä½¿ç”¨è€…æ„åœ–
- `extractSlots.js` - æå–é—œéµè³‡è¨Š

**parseIntent é‹ä½œæµç¨‹**ï¼š
1. å…ˆæª¢æŸ¥ `/config/mvp/intent-rules.yaml` çš„é—œéµè©è¦å‰‡
2. å¦‚æœç„¡æ³•åˆ¤æ–·ï¼Œæ‰å‘¼å« OpenAI API
3. å›å‚³æ„åœ–é¡å‹ï¼ˆå¦‚ï¼šadd_courseã€query_scheduleï¼‰

**extractSlots é‹ä½œæµç¨‹**ï¼š
1. æ ¹æ“šæ„åœ–é¡å‹ï¼Œæ±ºå®šè¦æå–å“ªäº›æ¬„ä½
2. ä½¿ç”¨ OpenAI API é€²è¡Œè‡ªç„¶èªè¨€è™•ç†
3. å›å‚³çµæ§‹åŒ–è³‡æ–™ï¼ˆslots mapï¼‰

### ğŸ“ `/tasks/` - ä»»å‹™åŸ·è¡Œå±¤
**å‘½åè¦å‰‡**ï¼š`handle_[intent]_task.js`
**å…±åŒä»‹é¢**ï¼š
```javascript
async function handle_XXX_task(slots, userId) {
  // åŸ·è¡Œæ¥­å‹™é‚è¼¯
  return { success: boolean, message: string };
}
```

**ä¸»è¦ä»»å‹™å‡½å¼**ï¼š
- `handle_add_course_task.js` - æ–°å¢èª²ç¨‹
- `handle_query_schedule_task.js` - æŸ¥è©¢èª²è¡¨
- `handle_set_reminder_task.js` - è¨­å®šæé†’
- `handle_cancel_course_task.js` - å–æ¶ˆèª²ç¨‹
- `handle_record_content_task.js` - è¨˜éŒ„èª²ç¨‹å…§å®¹

### ğŸ“ `/services/` - æ ¸å¿ƒæœå‹™å±¤
**ä¸»è¦æœå‹™**ï¼š
- `googleCalendarService.js` - Google Calendar API å°è£
  - `createCalendarEvent()` - å»ºç«‹äº‹ä»¶
  - `updateCalendarEvent()` - æ›´æ–°äº‹ä»¶
  - `deleteCalendarEvent()` - åˆªé™¤äº‹ä»¶
  - `getCalendarEvents()` - æŸ¥è©¢äº‹ä»¶

- `firebaseService.js` - Firebase è³‡æ–™å­˜å–
  - `saveCourse()` - å„²å­˜èª²ç¨‹è³‡æ–™
  - `getCoursesByStudent()` - æŸ¥è©¢å­¸ç”Ÿèª²ç¨‹
  - `updateCourseRecord()` - æ›´æ–°èª²ç¨‹è¨˜éŒ„

- `semanticService.js` - AI èªæ„åˆ†ææœå‹™
  - OpenAI API å‘¼å«å°è£

## 4. è³‡æ–™æµèªªæ˜

### æ–°å¢èª²ç¨‹çš„è³‡æ–™æµ
```
1. LINEè¨Šæ¯ã€Œå°æ˜é€±ä¸‰ä¸‹åˆ3é»æ•¸å­¸èª²ã€
   â†“
2. æå–è³‡æ–™ï¼š
   - studentName: "å°æ˜"
   - scheduleTime: "15:00"
   - courseName: "æ•¸å­¸èª²"
   - recurring: true (æ¯é€±)
   â†“
3. æŸ¥è©¢ Firebase /parents/{userId}/students
   æ‰¾åˆ°å°æ˜çš„ calendarId
   â†“
4. å‘¼å« Google Calendar API
   å»ºç«‹é‡è¤‡äº‹ä»¶ï¼Œå–å¾— eventId
   â†“
5. å„²å­˜åˆ° Firebase /courses/{courseId}
   åŒ…å« eventId é—œè¯
   â†“
6. å›è¦†æˆåŠŸè¨Šæ¯çµ¦ä½¿ç”¨è€…
```

### æé†’ä»»å‹™çš„æµç¨‹
```
Firebase Scheduled Functions (æ¯5åˆ†é˜åŸ·è¡Œ)
   â†“
æŸ¥è©¢ Firebase /reminders
where executed == false
and triggerTime <= ç¾åœ¨æ™‚é–“
   â†“
å°æ¯ç­†ç¬¦åˆçš„æé†’
   â†“
ä½¿ç”¨ LINE Push API
æ¨é€æé†’çµ¦å°æ‡‰çš„ userId
   â†“
æ¨™è¨˜æé†’ç‚ºå·²åŸ·è¡Œ (executed: true)
```

## 5. ç¯„ä¾‹ä»»å‹™æ‹†è§£

### ğŸ“Œ `add_course` æ–°å¢èª²ç¨‹
**è§¸ç™¼èªå¥ç¯„ä¾‹**ï¼š
- ã€Œå°æ˜æ¯é€±ä¸‰ä¸‹åˆ3é»æ•¸å­¸èª²ã€
- ã€Œå¹«æˆ‘å®‰æ’Lumiæ˜ŸæœŸäº”çš„é‹¼ç´èª²ã€
- ã€Œå°å…‰æ˜å¤©è¦ä¸Šè‹±æ–‡èª²ã€

**å¿…è¦ slots**ï¼š
```javascript
{
  studentName: "å°æ˜",      // å¿…å¡«
  courseName: "æ•¸å­¸èª²",     // å¿…å¡«
  scheduleTime: "15:00",    // å¿…å¡«ï¼Œçµ±ä¸€è½‰ç‚º24å°æ™‚åˆ¶
  courseDate: "2025-01-15", // å–®æ¬¡èª²ç¨‹å¿…å¡«
  recurring: true,          // æ˜¯å¦é‡è¤‡
  dayOfWeek: 3              // é‡è¤‡èª²ç¨‹çš„æ˜ŸæœŸå¹¾
}
```

**åŸ·è¡Œæµç¨‹**ï¼š
```javascript
async function handle_add_course_task(slots, userId) {
  // 1. æŸ¥æ‰¾å­¸ç”Ÿçš„ calendarId
  const student = await firebaseService.getStudent(userId, slots.studentName);
  
  // 2. å»ºç«‹ Google Calendar äº‹ä»¶
  const event = {
    summary: slots.courseName,
    start: { dateTime: buildDateTime(slots) },
    end: { dateTime: addOneHour(buildDateTime(slots)) },
    recurrence: slots.recurring ? [`RRULE:FREQ=WEEKLY;BYDAY=${dayMapping[slots.dayOfWeek]}`] : []
  };
  const calendarEvent = await googleCalendarService.createEvent(student.calendarId, event);
  
  // 3. å„²å­˜åˆ° Firebase
  await firebaseService.saveCourse({
    ...slots,
    userId,
    calendarEventId: calendarEvent.id,
    createdAt: new Date()
  });
  
  return {
    success: true,
    message: `âœ… ${slots.studentName}çš„${slots.courseName}å·²å®‰æ’å¥½äº†`
  };
}
```

### ğŸ“Œ `set_reminder` è¨­å®šæé†’
**è§¸ç™¼èªå¥ç¯„ä¾‹**ï¼š
- ã€Œæé†’æˆ‘å°æ˜çš„æ•¸å­¸èª²ã€
- ã€Œé‹¼ç´èª²å‰ä¸€å°æ™‚é€šçŸ¥æˆ‘ã€
- ã€Œå¹«æˆ‘è¨­å®šæé†’ï¼Œè¨˜å¾—å¸¶ç´è­œã€

**å¿…è¦ slots**ï¼š
```javascript
{
  studentName: "å°æ˜",           // å¿…å¡«
  courseName: "æ•¸å­¸èª²",          // å¿…å¡«ï¼ˆæˆ– courseIdï¼‰
  reminderTime: 30,             // æå‰å¹¾åˆ†é˜æé†’ï¼ˆé è¨­30ï¼‰
  reminderNote: "è¨˜å¾—å¸¶èª²æœ¬"     // é¸å¡«ï¼Œé™„åŠ æé†’å…§å®¹
}
```

**åŸ·è¡Œæµç¨‹**ï¼š
```javascript
async function handle_set_reminder_task(slots, userId) {
  // 1. æŸ¥æ‰¾å°æ‡‰çš„èª²ç¨‹
  const course = await firebaseService.findCourse(userId, slots.studentName, slots.courseName);
  
  // 2. è¨ˆç®—æé†’è§¸ç™¼æ™‚é–“
  const courseDateTime = new Date(`${course.courseDate}T${course.scheduleTime}:00+08:00`);
  const reminderTime = slots.reminderTime || 30;
  const triggerTime = new Date(courseDateTime.getTime() - reminderTime * 60000);
  
  // 3. å‰µå»ºæé†’è¨˜éŒ„
  await firebaseService.createReminder({
    courseId: course.courseId,
    userId,
    studentName: slots.studentName,
    courseName: slots.courseName,
    reminderTime,
    reminderNote: slots.reminderNote || null,
    triggerTime,
    executed: false
  });
  
  return {
    success: true,
    message: `âœ… å°‡åœ¨èª²ç¨‹é–‹å§‹å‰${reminderTime}åˆ†é˜æé†’æ‚¨`
  };
}
```

## 6. å¸¸ç”¨è³‡æ–™æ ¼å¼

### Slots Map ç¯„ä¾‹
```json
{
  "studentName": "å°æ˜",
  "courseName": "æ•¸å­¸èª²",
  "scheduleTime": "15:00",
  "courseDate": "2025-01-15",
  "recurring": true,
  "dayOfWeek": 3,
  "reminderNote": "è¨˜å¾—å¸¶èª²æœ¬"
}
```

### Firebase `/courses` è³‡æ–™çµæ§‹
```json
{
  "courseId": "auto-generated-id",
  "userId": "Uxxxxxxx",
  "studentName": "å°æ˜",
  "courseName": "æ•¸å­¸èª²",
  "courseDate": "2025-01-15",
  "scheduleTime": "15:00",
  "calendarEventId": "google-event-id",
  "isRecurring": true,
  "courseRecord": {
    "notes": "ä»Šå¤©å­¸äº†åˆ†æ•¸åŠ æ¸›æ³•",
    "photos": ["https://storage.url/photo1.jpg"],
    "updatedAt": "2025-01-15T16:00:00Z"
  },
  "createdAt": "2025-01-10T10:00:00Z"
}
```

### Firebase `/reminders` è³‡æ–™çµæ§‹
```json
{
  "reminderId": "auto-generated-id",
  "courseId": "èª²ç¨‹ID",
  "userId": "Uxxxxxxx",
  "studentName": "å°æ˜",
  "courseName": "æ•¸å­¸èª²",
  "reminderTime": 30,
  "reminderNote": "è¨˜å¾—å¸¶èª²æœ¬",
  "triggerTime": "2025-01-15T14:30:00+08:00",
  "executed": false,
  "createdAt": "2025-01-10T10:00:00Z"
}
```

### Google Calendar Event çµæ§‹
```json
{
  "summary": "æ•¸å­¸èª²",
  "description": "å°æ˜çš„èª²ç¨‹",
  "start": {
    "dateTime": "2025-01-15T15:00:00+08:00",
    "timeZone": "Asia/Taipei"
  },
  "end": {
    "dateTime": "2025-01-15T16:00:00+08:00",
    "timeZone": "Asia/Taipei"
  },
  "recurrence": ["RRULE:FREQ=WEEKLY;BYDAY=WE"],
  "reminders": {
    "useDefault": false,
    "overrides": []
  }
}
```

## 5.1 Google Calendar æ•´åˆåŸå‰‡èˆ‡å–æ¶ˆ/æ’¤éŠ·è¦ç¯„ï¼ˆé‡è¦ï¼‰

### æ†‘è­‰èˆ‡æ­¸å±¬
- Calendar ä¸€å¾‹ä½¿ç”¨ã€Œå¹³å° Gmail çš„ OAuthã€ä½œç‚ºæ©Ÿå™¨èº«åˆ†ï¼ˆäººå¯è¦‹ï¼‰ï¼›Service Account åƒ…ç”¨æ–¼ Firebaseã€‚

### å–æ¶ˆèˆ‡æ’¤éŠ·é‚è¼¯
- ä½¿ç”¨è€…ä¸»å‹•å–æ¶ˆï¼ˆè‡ªç„¶èªå¥å¦‚ã€Œå–æ¶ˆå°æ˜æ˜å¤©3é»æ•¸å­¸èª²ã€ï¼‰
  - Firebaseï¼šè»Ÿåˆªé™¤ï¼Œå°‡èª²ç¨‹æ–‡ä»¶æ¨™è¨˜ `cancelled=true`ï¼Œä¸¦å¯«å…¥ `cancelledAt`ã€`updatedAt`
  - Google Calendarï¼šä¸ç‰©ç†åˆªé™¤ï¼›æ”¹ç”¨äº‹ä»¶æ›´æ–°æ¨™è¨˜ç‚ºã€Œå·²å–æ¶ˆã€ï¼š
    - summary å‰ç¶´åŠ ã€Œã€å·²å–æ¶ˆã€‘ã€
    - `transparency='transparent'`ï¼ˆä¸ä½”å¿™ç¢Œæ™‚æ®µï¼‰
    - `extendedProperties.private.cancelled='true'`
  - è¡çªæª¢æŸ¥ï¼š`googleCalendarService.checkConflict()` æœƒå¿½ç•¥å¸¶ä¸Šè¿°æ¨™è¨˜çš„äº‹ä»¶ï¼Œé¿å…èª¤åˆ¤

- æ’¤éŠ·ä¸Šä¸€å‹•ä½œï¼ˆå‰›å®Œæˆå¾Œç«‹å³æŒ‰ã€Œå–æ¶ˆæ“ä½œ/undoã€ï¼‰
  - Firebaseï¼šç‰©ç†åˆªé™¤è©²ç­†èª²ç¨‹ç´€éŒ„
  - Google Calendarï¼šç‰©ç†åˆªé™¤å°æ‡‰äº‹ä»¶

### å¯¦ä½œä½ç½®
- æ¨™è¨˜å–æ¶ˆï¼š`googleCalendarService.markEventCancelled(calendarId, eventId)`
- ä¸»å‹•å–æ¶ˆä»»å‹™ï¼š`tasks/handle_cancel_course_task.js`ï¼ˆå‘¼å« markEventCancelled + è»Ÿåˆªï¼‰
- æ’¤éŠ·ä¸Šä¸€å‹•ä½œï¼š`tasks/handle_cancel_action_task.js`ï¼ˆç‰©ç†åˆªé™¤äº‹ä»¶ + ç‰©ç†åˆª Firebaseï¼‰
- è¡çªéæ¿¾ï¼š`googleCalendarService.checkConflict()` å·²éæ¿¾ã€å·²å–æ¶ˆã€‘æˆ– `extendedProperties.private.cancelled='true'` çš„äº‹ä»¶

### æ¸¬è©¦èˆ‡é©—æ”¶ï¼ˆ2025-08-12ï¼‰

- ç›®æ¨™ï¼šé©—è­‰å…©æ¢è·¯å¾‘è¡Œç‚ºå®Œå…¨ç¬¦åˆè¦ç¯„
  - æ’¤éŠ·ä¸Šä¸€å‹•ä½œï¼ˆundoï¼‰ï¼šFirebase ç‰©ç†åˆªé™¤ + GCal ç‰©ç†åˆªé™¤
  - ä½¿ç”¨è€…ä¸»å‹•å–æ¶ˆï¼šFirebase è»Ÿåˆªï¼ˆcancelled=true, cancelledAtï¼‰+ GCal æ¨™è¨˜å–æ¶ˆï¼ˆä¸ç‰©ç†åˆªï¼‰

- æ¸¬è©¦è…³æœ¬èˆ‡ä½ç½®ï¼š
  - æ’¤éŠ·ï¼š`test-cancel-action.js`
  - ä¸»å‹•å–æ¶ˆï¼š`test-cancel-course.js`
  - éäº’å‹•ä¸€éµé©—è­‰ï¼ˆé¿å… Quick Reply å¡ä½ï¼‰ï¼š`tools/internal/debug/run-noninteractive-tests.js`

- é—œéµå¯¦ä½œèˆ‡ä¿®å¾©é»ï¼š
  - `src/services/firebaseService.js`
    - æ–°å¢ `deleteDocument(collection, id)` æ”¯æ´ç‰©ç†åˆªé™¤
    - æ–°å¢ `shutdownFirebase()` æ¸¬è©¦å¾Œé—œé–‰é€£ç·šï¼Œé¿å… Node ä¸é€€å‡º
  - `src/tasks/handle_cancel_action_task.js`
    - æ’¤éŠ·æ™‚æ”¹ä»¥ `firebaseService.getStudent(userId, name)` å–å¾— `calendarId` å¾ŒåŸ·è¡Œ `googleCalendarService.deleteEvent(...)`
  - `src/services/googleCalendarService.js`
    - æ–°å¢ä¸¦åŒ¯å‡º `markEventCancelled(calendarId, eventId)`
    - `checkConflict(...)` å¿½ç•¥å·²å–æ¶ˆäº‹ä»¶ï¼ˆæ¨™é¡Œå«ã€å·²å–æ¶ˆã€‘æˆ– `extendedProperties.private.cancelled='true'`ï¼‰
  - `src/intent/parseIntent.js`
    - å°‡ã€Œå–æ¶ˆæ“ä½œ/ç®—äº†/ä¸è¦/é‡ä¾†â€¦ã€å„ªå…ˆè·¯ç”±ç‚º `cancel_action`ï¼Œé¿å…èª¤åˆ¤ç‚º `cancel_course`

- é©—æ”¶è¦é»ï¼ˆçš†å·²é€šéï¼‰ï¼š
  - æ’¤éŠ·ï¼š
    - Firebase è©²ç­† `/courses/{courseId}` ä¸å­˜åœ¨ï¼ˆç‰©ç†åˆªï¼‰
    - GCal è©² `eventId` æŸ¥è©¢å› 404ï¼ˆç‰©ç†åˆªï¼‰
  - ä¸»å‹•å–æ¶ˆï¼š
    - Firebaseï¼š`cancelled=true` ä¸” `cancelledAt` æœ‰æ™‚é–“æˆ³
    - GCalï¼šäº‹ä»¶ summary å«ã€Œã€å·²å–æ¶ˆã€‘ã€ã€`transparency='transparent'`ã€`extendedProperties.private.cancelled='true'`
    - è¡çªæª¢æŸ¥ï¼šåŒä¸€æ™‚æ®µä¸å†è¦–ç‚ºè¡çª

### æœ¬åœ°åŸ·è¡Œæ¸¬è©¦

```bash
# æ’¤éŠ·ï¼ˆç«‹å³ undoï¼‰é©—è­‰
node test-cancel-action.js

# ä½¿ç”¨è€…ä¸»å‹•å–æ¶ˆé©—è­‰ï¼ˆGCal æ¨™è¨˜ + Firebase è»Ÿåˆªï¼‰
node test-cancel-course.js

# éäº’å‹•ä¸€éµé©—è­‰ï¼ˆè¦†è“‹å…©æ¢è·¯å¾‘ï¼Œä¸¦è‡ªå‹•é—œé–‰é€£ç·šï¼‰
node tools/internal/debug/run-noninteractive-tests.js
```

## 5.2 Recurring èª²ç¨‹çµ±ä¸€è¦å‰‡ï¼ˆæ‘˜è¦ï¼‰
- è¨­è¨ˆåŸå‰‡ï¼šå„ªå…ˆä¾è³´ GCal RRULEï¼Œä¸æœ¬åœ°å±•é–‹åºåˆ—ã€ä¸é‡é€ è¼ªå­ã€‚
- å–®ä¸€é–‹é—œï¼š`ENABLE_RECURRING_COURSES` æ§åˆ¶ daily/weekly/monthlyï¼›é—œé–‰æ™‚ä¸€å¾‹å‹å–„é™ç´šï¼Œä¸è¿½å•æ—¥æœŸã€‚
- èµ·å§‹æ—¥ï¼ˆç¼ºæ—¥æœŸæ™‚ï¼‰ï¼š
  - æ¯å¤©ï¼šä»Šå¤©æ™‚é–“æœªéâ†’ä»Šå¤©ï¼›å¦å‰‡â†’æ˜å¤©ã€‚
  - æ¯é€±ï¼ˆå–®/å¤šå¤©ï¼‰ï¼šå¾ç¾åœ¨èµ·æœ€è¿‘çš„ç¬¦åˆé€±å¹¾ï¼ˆè‹¥ä»Šå¤©ä¸”æœªéâ†’ä»Šå¤©ï¼‰ã€‚
  - æ¯æœˆå›ºå®šæ—¥ï¼šæœ¬æœˆæœ‰è©²æ—¥ä¸”æœªéâ†’æœ¬æœˆï¼›å¦å‰‡â†’ä¸‹æœˆï¼›å°æœˆç¼ºæ—¥â†’è·³éï¼ˆå»ºç«‹ç•¶ä¸‹æä¾›ã€Œæ”¹ç‚ºæ¯æœˆæœ€å¾Œä¸€å¤©ã€é¸é …ï¼‰ã€‚
- è¡çªæª¢æŸ¥ï¼šåƒ…æª¢æŸ¥ã€Œé¦–å€‹å¯¦ä¾‹ã€ã€‚
- æ™‚å€ï¼šå›ºå®š Asia/Taipeiã€‚
- æ’¤éŠ·æ™‚é™ï¼šç¨‹å¼å…§å»º 2 åˆ†é˜ï¼ˆå¯é¸ `UNDO_WINDOW_MINUTES` è¦†è“‹ï¼‰ã€‚
- è©³ç´°è¦åŠƒï¼š`spec/recurring/plan-recurring.md`ã€‚

## å¿«é€Ÿä¸Šæ‰‹æç¤º

1. **æœ¬åœ°é–‹ç™¼**ï¼š
   ```bash
   npm install
   npm start
   ```

2. **æ¸¬è©¦è¨Šæ¯**ï¼š
   ```bash
   node tools/send-test-message.js "å°æ˜æ¯é€±ä¸‰ä¸‹åˆ3é»æ•¸å­¸èª²"
   ```

3. **æŸ¥çœ‹æ—¥èªŒ**ï¼š
   æ‰€æœ‰ API å‘¼å«éƒ½æœƒè¨˜éŒ„åœ¨ consoleï¼Œæ–¹ä¾¿é™¤éŒ¯

4. **å¸¸è¦‹å•é¡Œ**ï¼š
   - æ™‚é–“çµ±ä¸€ä½¿ç”¨ 24 å°æ™‚åˆ¶å„²å­˜ï¼Œé¡¯ç¤ºæ™‚è½‰æ›ç‚ºä¸­æ–‡æ ¼å¼
   - studentName + userId æ˜¯æŸ¥æ‰¾å­¸ç”Ÿçš„é—œéµ
   - æ¯å€‹ course éƒ½æœƒåŒæ™‚å­˜åœ¨æ–¼ Google Calendar å’Œ Firebase

## 7. ç³»çµ±ç¾ç‹€èˆ‡çœŸæ­£çš„å¾…å¯¦ä½œåŠŸèƒ½

### âœ… **Phase 1 æ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆ**

#### 7.1 æé†’ç³»çµ± âœ… **å·²å®Œå…¨å¯¦ä½œ**
- âœ… èª²å‰æ™‚é–“æé†’ï¼ˆ`handle_set_reminder_task.js`ï¼‰
- âœ… Firebase Scheduled Functionsï¼ˆ`functions/index.js`ï¼‰
- âœ… LINE æ¨æ’­æé†’ï¼ˆæ¯5åˆ†é˜æª¢æŸ¥ï¼‰
- âœ… æ¸…ç†éæœŸæé†’è¨˜éŒ„

#### 7.2 åœ–ç‰‡è™•ç†åŠŸèƒ½ âœ… **å·²å®Œå…¨å¯¦ä½œ** 
- âœ… æ¥æ”¶ LINE åœ–ç‰‡è¨Šæ¯ï¼ˆ`webhook.js`ï¼‰
- âœ… ä¸Šå‚³è‡³ Firebase Storageï¼ˆ`firebaseService.uploadImage()`ï¼‰
- âœ… è‡ªå‹•é—œè¯åˆ°èª²ç¨‹è¨˜éŒ„ï¼ˆ`handle_record_content_task.js`ï¼‰

#### 7.3 æ™‚é–“è¡çªæª¢æ¸¬ âœ… **å·²å®Œå…¨å¯¦ä½œä¸¦æ•´åˆ**
- âœ… ä½¿ç”¨ Google Calendar API æª¢æ¸¬è¡çªï¼ˆ`googleCalendarService.checkConflict()`ï¼‰
- âœ… åœ¨æ–°å¢èª²ç¨‹æ™‚è‡ªå‹•æª¢æŸ¥ï¼ˆ`handle_add_course_task.js`ï¼‰
- âœ… æä¾›æ¸…æ¥šçš„è¡çªè³‡è¨Šçµ¦ç”¨æˆ¶

#### 7.4 åŸºç¤ä»»å‹™è™•ç† âœ… **å·²å®Œå…¨å¯¦ä½œ**
- âœ… æ–°å¢èª²ç¨‹ï¼ˆæ”¯æ´é‡è¤‡è¦å‰‡ï¼‰
- âœ… æŸ¥è©¢èª²è¡¨
- âœ… è¨­å®šæé†’
- âœ… å–æ¶ˆèª²ç¨‹
- âœ… è¨˜éŒ„èª²ç¨‹å…§å®¹ï¼ˆæ–‡å­—+åœ–ç‰‡ï¼‰

### ğŸš§ **çœŸæ­£çš„å¾…å¯¦ä½œåŠŸèƒ½**

åŸºæ–¼ç¾ç‹€åˆ†æï¼Œä¸»è¦çš„æœªå¯¦ä½œåŠŸèƒ½é›†ä¸­åœ¨é€²éšåŠŸèƒ½å’Œç³»çµ±æ”¹å–„æ–¹é¢ï¼š

#### ğŸ”§ Phase 2 - é€²éšåŠŸèƒ½å„ªåŒ–

**7.1 ä¼æ¥­ç´šå°è©±ç®¡ç†ï¼ˆSlot Template ç³»çµ±ï¼‰**
- ğŸš§ **ç‹€æ…‹ï¼šå·²è¦åŠƒæœªå¯¦ä½œ** - Phase 2 åŠŸèƒ½ï¼Œé…ç½®æ–‡ä»¶å·²æº–å‚™
- ğŸš§ å¤šè¼ªå°è©±ç‹€æ…‹æŒä¹…åŒ–ï¼ˆç›®å‰åƒ…å…§å­˜æš«å­˜ï¼‰
- ğŸš§ Slot Template å¼•æ“ï¼ˆæ”¯æ´å‹•æ…‹é…ç½®ï¼‰
- ğŸš§ å°è©±ä¸­æ–·å¾Œçš„ç‹€æ…‹æ¢å¾©
- ğŸš§ ä¼æ¥­ç´šæŒ‡æ¨™ç›£æ§èˆ‡åˆ†æ

**å¯¦ä½œæ¶æ§‹å·²è¨­è¨ˆ**ï¼š
```
/config/future/slot-template-collections.json  # Firestore çµæ§‹
/src/config/features.js                        # Feature Flag
```

**7.2 æ‰¹æ¬¡æ“ä½œæ”¯æ´**
- ğŸš§ æ‰¹æ¬¡æ–°å¢å¤šå€‹èª²ç¨‹
- ğŸš§ æ‰¹æ¬¡ä¿®æ”¹é‡è¤‡èª²ç¨‹
- ğŸš§ æ‰¹æ¬¡åŒ¯å‡ºå­¸ç¿’å ±å‘Š

#### ğŸ§ª Phase 3 - ç³»çµ±å“è³ªæå‡

**7.3 è‡ªå‹•åŒ–æ¸¬è©¦**
- ğŸš§ å–®å…ƒæ¸¬è©¦è¦†è“‹ï¼ˆæ„åœ–è­˜åˆ¥ã€ä»»å‹™è™•ç†ï¼‰
- ğŸš§ æ•´åˆæ¸¬è©¦ï¼ˆGoogle Calendarã€Firebase APIï¼‰
- ğŸš§ ç«¯å°ç«¯å°è©±æ¸¬è©¦

**7.4 ç›£æ§èˆ‡å¯è§€æ¸¬æ€§**
- ğŸš§ çµæ§‹åŒ–æ—¥èªŒç³»çµ±
- ğŸš§ API æ•ˆèƒ½ç›£æ§
- ğŸš§ éŒ¯èª¤è¿½è¹¤èˆ‡å‘Šè­¦
- ğŸš§ ä½¿ç”¨è€…è¡Œç‚ºåˆ†æ

## 8. é–‹ç™¼å„ªå…ˆç´šå»ºè­°ï¼ˆåŸºæ–¼å¯¦éš›ç¾ç‹€ï¼‰

### âœ… **MVP æ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆ**
ç³»çµ±å·²å®Œæˆæ‰€æœ‰åŸºç¤åŠŸèƒ½ï¼šæé†’ç³»çµ±ã€åœ–ç‰‡è™•ç†ã€æ™‚é–“è¡çªæª¢æ¸¬ã€ä»»å‹™è™•ç†ç­‰ã€‚

### ğŸ”´ é«˜å„ªå…ˆç´šï¼ˆçŸ­æœŸæ”¹å–„ï¼‰
1. **è‡ªå‹•åŒ–æ¸¬è©¦ç³»çµ±** - ç¢ºä¿ç³»çµ±ç©©å®šæ€§å’Œé‡æ§‹å®‰å…¨
2. **å°è©±ç‹€æ…‹æŒä¹…åŒ–** - æå‡ç”¨æˆ¶é«”é©—é€£çºŒæ€§
3. **çµæ§‹åŒ–æ—¥èªŒç³»çµ±** - æ”¹å–„å•é¡Œè¿½è¹¤èƒ½åŠ›

### ğŸŸ¡ ä¸­å„ªå…ˆç´šï¼ˆä¸­æœŸå„ªåŒ–ï¼‰
1. **æ‰¹æ¬¡æ“ä½œåŠŸèƒ½** - æå‡æ•ˆç‡ï¼ˆæ‰¹æ¬¡æ–°å¢èª²ç¨‹ç­‰ï¼‰
2. **æ™ºæ…§ä¸Šä¸‹æ–‡æ¨æ–·** - æ¸›å°‘ç”¨æˆ¶è¼¸å…¥è² æ“”
3. **API æ•ˆèƒ½ç›£æ§** - é é˜²æ€§ç¶­è­·

### ğŸŸ¢ ä½å„ªå…ˆç´šï¼ˆé•·æœŸè¦åŠƒï¼‰
1. **ä½¿ç”¨è€…è¡Œç‚ºåˆ†æ** - ç”¢å“å„ªåŒ–ä¾æ“š
2. **é€²éšå°è©±ç®¡ç†** - ä¼æ¥­ç´šåŠŸèƒ½
3. **å¤šç§Ÿæˆ¶æ¶æ§‹** - å•†æ¥­åŒ–æº–å‚™

## 9. é–‹ç™¼æŒ‡å—

### æ–°åŠŸèƒ½é–‹ç™¼æµç¨‹
1. **éœ€æ±‚åˆ†æ** - ç¢ºèªæ¥­å‹™åƒ¹å€¼å’ŒæŠ€è¡“å¯è¡Œæ€§
2. **è¨­è¨ˆéšæ®µ** - å®šç¾© API ä»‹é¢å’Œè³‡æ–™çµæ§‹
3. **å¯¦ä½œéšæ®µ** - éµå¾ªç¾æœ‰å‘½åå’Œæ¶æ§‹è¦ç¯„
4. **æ¸¬è©¦éšæ®µ** - æ’°å¯«æ¸¬è©¦æ¡ˆä¾‹ä¸¦åŸ·è¡Œ
5. **éƒ¨ç½²éšæ®µ** - ä½¿ç”¨ Feature Flag æ¼¸é€²å¼ç™¼å¸ƒ

### ç¨‹å¼ç¢¼è¦ç¯„æé†’
- æ„åœ–å‘½åï¼š`snake_case`ï¼ˆå¦‚ `add_course`ï¼‰
- å‡½å¼å‘½åï¼š`handle_XXX_task()`
- è®Šæ•¸å‘½åï¼š`camelCase`
- å›å‚³æ ¼å¼ï¼š`{ success: boolean, message: string }`
- çµ±ä¸€ç”¨è©ï¼šstudent/course/scheduleTime

## 10. æ•…éšœæ’æŸ¥ç¶“é©—èˆ‡æœ€ä½³å¯¦è¸

### ğŸ¯ ç¬¬ä¸€æ€§åŸå‰‡ï¼šå•é¡Œè¨ºæ–·æ–¹æ³•è«–

#### æ ¸å¿ƒåŸå‰‡
åœ¨æ’æŸ¥ä»»ä½•å•é¡Œæ™‚ï¼Œ**å…ˆæ‰¾å•é¡Œæœ¬è³ªï¼Œå†è€ƒæ…®è§£æ±ºæ–¹æ¡ˆ**ã€‚é¿å…å‡è¨­å’Œéåº¦å·¥ç¨‹åŒ–ã€‚

#### å…¸å‹æ¡ˆä¾‹ï¼š2025-08-07 Render æœå‹™ 500 éŒ¯èª¤ä¿®å¾©

**å•é¡Œç¾è±¡**ï¼š
- Render éƒ¨ç½²çš„ webhook è¿”å› 500 éŒ¯èª¤
- æ¸¬è©¦è«‹æ±‚ç„¡æ³•æ­£å¸¸è™•ç†
- éŒ¯èª¤å †ç–ŠæŒ‡å‘ LINE API 400 éŒ¯èª¤

**âŒ éŒ¯èª¤è¨ºæ–·è·¯å¾‘**ï¼ˆéåº¦å·¥ç¨‹åŒ–ï¼‰ï¼š
1. ä»¥ç‚ºæ˜¯æ¶æ§‹å•é¡Œï¼ˆæœå‹™é¸æ“‡é‚è¼¯ï¼‰
2. ä¿®å¾©äº†å¤šå€‹ `lineService` æœªå®šç¾©éŒ¯èª¤
3. å»ºç«‹äº†è¤‡é›œçš„è¨ºæ–·å·¥å…·éˆ
4. èŠ±è²»æ•¸å°æ™‚ä¿®å¾©"ç—‡ç‹€"è€Œé"ç—…å› "

**âœ… æ­£ç¢ºè¨ºæ–·è·¯å¾‘**ï¼ˆç¬¬ä¸€æ€§åŸå‰‡ï¼‰ï¼š
1. **å•é¡Œæœ¬è³ª**ï¼šæ¸¬è©¦è«‹æ±‚ç‚ºä»€éº¼æœƒèª¿ç”¨çœŸå¯¦ LINE APIï¼Ÿ
2. **æ ¹æœ¬åŸå› **ï¼šç’°å¢ƒéš”é›¢ä¸è¶³ï¼Œæ¸¬è©¦ token ä¹Ÿè§¸ç™¼çœŸå¯¦ API èª¿ç”¨
3. **ç°¡å–®è§£æ±º**ï¼šåœ¨ lineService ä¸­æª¢æŸ¥æ¸¬è©¦ tokenï¼Œè·³éçœŸå¯¦ API

**æœ€çµ‚è§£æ±ºæ–¹æ¡ˆ**ï¼ˆ5è¡Œä»£ç¢¼ï¼‰ï¼š
```javascript
// æ¸¬è©¦ç’°å¢ƒæª¢æŸ¥
if (replyToken && replyToken.includes('test-reply-token')) {
  console.log('ğŸ§ª æª¢æ¸¬åˆ°æ¸¬è©¦ tokenï¼Œè·³éçœŸå¯¦ LINE API èª¿ç”¨');
  return { status: 200, data: { message: 'Mock response for testing' } };
}
```

### ğŸ”§ æ•…éšœæ’æŸ¥æœ€ä½³å¯¦è¸

#### 1. **ç’°å¢ƒéš”é›¢æª¢æŸ¥æ¸…å–®**
æ’æŸ¥ä»»ä½•æœå‹™å•é¡Œæ™‚ï¼Œé¦–å…ˆç¢ºèªï¼š
- [ ] æ¸¬è©¦è«‹æ±‚æ˜¯å¦æ­£ç¢ºä½¿ç”¨æ¸¬è©¦ç’°å¢ƒï¼Ÿ
- [ ] æ¸¬è©¦æ•¸æ“šæ˜¯å¦æ±¡æŸ“äº†ç”Ÿç”¢æœå‹™ï¼Ÿ
- [ ] ç’°å¢ƒè®Šæ•¸å’Œé…ç½®æ˜¯å¦æ­£ç¢ºéš”é›¢ï¼Ÿ
- [ ] API èª¿ç”¨æ˜¯å¦æœ‰é©ç•¶çš„æ¸¬è©¦/ç”Ÿç”¢å€åˆ†ï¼Ÿ

#### 2. **å•é¡Œå®šä½é †åº**
1. **æª¢æŸ¥éŒ¯èª¤å †ç–Š** - æ‰¾åˆ°çœŸæ­£å¤±æ•—çš„ä»£ç¢¼ä½ç½®
2. **æª¢æŸ¥è¼¸å…¥æ•¸æ“š** - ç¢ºèªè«‹æ±‚åƒæ•¸å’Œæ ¼å¼
3. **æª¢æŸ¥ç’°å¢ƒéš”é›¢** - æ¸¬è©¦æ˜¯å¦èª¿ç”¨äº†ç”Ÿç”¢æœå‹™
4. **æª¢æŸ¥ä¾è³´æœå‹™** - å¤–éƒ¨ API ç‹€æ…‹å’Œé…ç½®
5. **æª¢æŸ¥æ¥­å‹™é‚è¼¯** - æœ€å¾Œæ‰æª¢æŸ¥æ‡‰ç”¨ä»£ç¢¼

#### 3. **è¨ºæ–·å·¥å…·å»ºç«‹åŸå‰‡**
- **å…ˆç°¡å–®å¾Œè¤‡é›œ**ï¼šç”¨ `console.log` ç¢ºèªæ•¸æ“šæµå‘
- **é‡å°æ€§å·¥å…·**ï¼šç‚ºç‰¹å®šå•é¡Œå»ºç«‹ç‰¹å®šç«¯é»
- **è‡¨æ™‚æ€§å·¥å…·**ï¼šè¨ºæ–·å·¥å…·æ‡‰è©²æ˜¯è‡¨æ™‚çš„ï¼Œå•é¡Œè§£æ±ºå¾Œå¯ç§»é™¤
- **é¿å…éåº¦æŠ•è³‡**ï¼šä¸è¦ç‚ºäº†è¨ºæ–·è€Œéåº¦è¤‡é›œåŒ–ç³»çµ±

#### 4. **ä¿®å¾©ç­–ç•¥é¸æ“‡**
| å•é¡Œé¡å‹ | å„ªå…ˆç­–ç•¥ | é¿å…ç­–ç•¥ |
|---------|---------|---------|
| **ç’°å¢ƒéš”é›¢å•é¡Œ** | æ·»åŠ ç’°å¢ƒæª¢æŸ¥é‚è¼¯ | é‡æ–°è¨­è¨ˆæ•´å€‹æ¶æ§‹ |
| **é…ç½®éŒ¯èª¤** | ä¿®æ­£é…ç½®æ–‡ä»¶ | ä¿®æ”¹æ¥­å‹™é‚è¼¯é©é…éŒ¯èª¤é…ç½® |
| **ä¾è³´æœå‹™å•é¡Œ** | æ·»åŠ é™ç´šæ–¹æ¡ˆ | åˆ‡æ›åˆ°å®Œå…¨ä¸åŒçš„æœå‹™ |
| **æ¥­å‹™é‚è¼¯éŒ¯èª¤** | ä¿®æ­£é‚è¼¯æœ¬èº« | ç”¨æŠ€è¡“æ‰‹æ®µç¹éé‚è¼¯å•é¡Œ |

### ğŸš¨ å¸¸è¦‹åæ¨¡å¼èˆ‡é¿å…æ–¹æ³•

#### åæ¨¡å¼1ï¼šéåº¦è¨ºæ–·
**éŒ¯èª¤åšæ³•**ï¼šå»ºç«‹è¤‡é›œçš„ç›£æ§å’Œæ—¥èªŒç³»çµ±ä¾†è¨ºæ–·ç°¡å–®å•é¡Œ
**æ­£ç¢ºåšæ³•**ï¼šå…ˆç”¨æœ€ç°¡å–®çš„ `console.log` ç¢ºèªå•é¡Œä½ç½®

#### åæ¨¡å¼2ï¼šç—‡ç‹€ä¿®å¾©
**éŒ¯èª¤åšæ³•**ï¼šä¿®å¾©æ¯å€‹å ±éŒ¯çš„åœ°æ–¹ï¼Œä½†ä¸è§£æ±ºæ ¹æœ¬åŸå› 
**æ­£ç¢ºåšæ³•**ï¼šè¿½è¹¤åˆ°å•é¡Œæ ¹æºï¼Œä¸€æ¬¡æ€§å¾¹åº•è§£æ±º

#### åæ¨¡å¼3ï¼šæ¶æ§‹é‡æ§‹é€ƒé¿
**éŒ¯èª¤åšæ³•**ï¼šé‡åˆ°å•é¡Œå°±é‡æ–°è¨­è¨ˆæ•´å€‹ç³»çµ±
**æ­£ç¢ºåšæ³•**ï¼šå…ˆç¢ºèªæ˜¯å¦çœŸçš„éœ€è¦æ¶æ§‹è®Šæ›´

#### åæ¨¡å¼4ï¼šå·¥å…·ä¾è³´
**éŒ¯èª¤åšæ³•**ï¼šä¾è³´è¤‡é›œå·¥å…·ä¾†ç†è§£ç³»çµ±è¡Œç‚º
**æ­£ç¢ºåšæ³•**ï¼šç¢ºä¿åœ˜éšŠæ¯å€‹äººéƒ½ç†è§£ç³»çµ±æœ¬è³ªé‚è¼¯

### ğŸ“š é€™æ¬¡ä¿®å¾©çš„çœŸæ­£åƒ¹å€¼

é›–ç„¶æœ€çµ‚è§£æ±ºæ–¹æ¡ˆå¾ˆç°¡å–®ï¼Œä½†éç¨‹ä¸­çš„ä¿®å¾©å¯¦éš›ä¸Šæœ‰åƒ¹å€¼ï¼š

**âœ… æœ‰åƒ¹å€¼çš„ä¿®å¾©**ï¼š
- ä¿®å¾©äº†çœŸå¯¦å­˜åœ¨çš„ `lineService` æœªå®šç¾©éŒ¯èª¤
- çµ±ä¸€äº†æœå‹™é¸æ“‡é‚è¼¯ï¼Œæé«˜ä»£ç¢¼ä¸€è‡´æ€§
- å»ºç«‹äº†æœ‰ç”¨çš„è¨ºæ–·ç«¯é»ï¼ˆ`/health/deps`ï¼‰

**âš ï¸ éåº¦å·¥ç¨‹åŒ–çš„éƒ¨åˆ†**ï¼š
- ç‚ºäº†è¨ºæ–·å»ºç«‹éå¤šè‡¨æ™‚ç«¯é»
- å‡è¨­æ¶æ§‹å•é¡Œå°è‡´çš„ç„¡æ•ˆä¿®å¾©è·¯å¾‘

### ğŸ’¡ è¨˜æ†¶å£è¨£

**"KISS + FP"** (Keep It Simple, Stupid + First Principles)

1. **K**eep it simple - ç”¨æœ€ç°¡å–®çš„æ–¹æ³•å…ˆå®šä½å•é¡Œ
2. **I**solation check - æª¢æŸ¥ç’°å¢ƒéš”é›¢æ˜¯å¦æ­£ç¢º  
3. **S**tack trace first - å…ˆçœ‹éŒ¯èª¤å †ç–Šï¼Œå®šä½çœŸæ­£å¤±æ•—é»
4. **S**ymptom vs root cause - å€åˆ†ç—‡ç‹€å’Œæ ¹æœ¬åŸå› 
5. **F**irst principles - å›åˆ°å•é¡Œæœ¬è³ªæ€è€ƒ
6. **P**ragmatic solution - é¸æ“‡å¯¦ç”¨è€Œéå®Œç¾çš„è§£æ±ºæ–¹æ¡ˆ

---

ç¥é–‹ç™¼é †åˆ©ï¼å¦‚æœ‰å•é¡Œè«‹æŸ¥é–± `/doc/implement.md` çš„æ¥­å‹™é‚è¼¯èªªæ˜ã€‚

**è¨˜ä½**ï¼šé‡åˆ°å•é¡Œæ™‚ï¼Œå…ˆå•"ç‚ºä»€éº¼æœƒé€™æ¨£ï¼Ÿ"è€Œä¸æ˜¯"æ€éº¼ä¿®å¾©ï¼Ÿ"