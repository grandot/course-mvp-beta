## 修改課程 Roadmap — P2/P3 計畫與迭代時機

### 背景
- P1（spec/modify-course/plan.md）已定義：僅支援「單次課」修改，雙入口、衝突檢查、自癒，嚴格一致性（先 GCal 後 Firebase）。
- 本文件：定義 P2/P3 的能力擴張與何時啟動的時機判斷（含風險控制與驗收）。

---

### P2（v1.1）— 能力擴張，仍以穩定為優先

- 目標與範圍
  - 整系列修改（Recurring Series, 不含單一實例）：
    - 支援「每週/每天」等系列課的整體時間或星期調整。
    - 僅限「整系列」；禁止只改單一實例（避免例外實例同步陰影）。
    - 明確提示影響範圍與風險，要求用戶再次確認（雙確認）。
  - 撤銷/復原（Undo Modify）：
    - 在修改完成後短時間內允許「撤銷」，恢復上一次的 courseDate/scheduleTime/courseName。
    - 需要在修改前寫入「上一次版本」的變更快照（僅最近一筆）。
  - 自然語增強（modify_course）：
    - 完整支援 `scheduleTimeNew`、`courseDateNew`、`courseNameNew` 的高可靠抽取，含信心門檻與澄清分支。
    - 多筆候選的 disambiguation（最多列 3–5 筆）。

- 技術要點
  - GCal：改用更新系列事件（RRULE）之 API，禁止建立例外實例；避免 partial。
  - Firebase：同步更新系列的核心欄位與註記（例如 `isRecurring`, `recurrenceType`）。
  - 雙確認：在任務結果 quick reply 增加「確認系列修改」按鈕，避免誤操作。
  - Undo：
    - 修改前寫入 `courses/{courseId}/_lastModifySnapshot`（或統一「最近一次修改」欄位）。
    - 撤銷時「GCal 先回復 → Firebase 後回復」。

- 風險與緩解
  - 誤改整個系列：雙確認 + 清楚文案 + 日誌標記。
  - 不一致風險：仍維持「先 GCal、後 Firebase」，失敗直接失敗（不做降級）。

- 驗收條件（AC）
  - 整系列修改成功且訊息清楚告知影響範圍。
  - 撤銷後，兩端（GCal/Firebase）資料完全回復。
  - 自然語 modify_course 在資訊完整時可直達；不足時出澄清並完成。

- 迭代時機（何時啟動 P2）
  - P1 線上穩定至少 5–7 天：
    - 修改成功率 ≥ 90%，CONFLICT_ERROR 比例合理（< 15%）。
    - 無明顯「找不到目標課」大量案例（或已由澄清有效收斂）。
  - 需求側信號：
    - 真實使用中「修改重複課」的請求占比 ≥ 20%，或頻繁的客服/回饋。
  - 工程側準備：
    - 已有修改快照（便於撤銷）。
    - 監控面板可見（成功率、衝突率、撤銷率、錯誤碼分布）。

- 推出方式
  - Feature Flag 漸進釋出（先 10% → 50% → 100%）。
  - 先只開「整系列」修改；「單一實例」延後（放入 P3）。

---

### P3 — 可用性與可靠性深化（需更高工程投入）

- 目標與範圍
  - 降級策略（Degrade with Repair）：
    - 引入「待同步佇列 + 後台修復」機制。
    - 若 GCal 當下不可用，先將修改需求以「可重試任務」寫入佇列，背景 worker 重試補寫。
    - 提供可觀測性：任務狀態（排隊/重試中/成功/失敗）、告警與人工介入工具。
    - Idempotency：用 userId/courseId/版本號 生成 key，確保重試不重複落地。
  - 單一實例修改（系列中的某一次）：
    - 使用 GCal occurrences/exceptions 模型，僅改特定 instance。
    - Firestore 需記錄該實例對應的 eventId/實例日期，以便查詢與撤銷。
  - 可觀測性與治理：
    - KPI：修改成功率、同步延遲、重試次數、MTTR、使用者澄清次數。
    - 审計（Audit）：記錄每次修改、撤銷與同步任務；提供內部檢視工具。

- 技術要點
  - 佇列與 Worker：
    - 可用外部佇列服務（如 Redis stream）或 Firestore-based 任務集合。
    - 指數退避重試、上限告警、人工「跳過/重置」操作。
  - Instance 修改：
    - 列出系列實例 → 使用者指定日期 → 更新該 instance，並在 Firestore 建立 exceptions 映射。
  - 安全與一致性：
    - 任務具備 idempotency；所有寫入均附版本戳（version/timestamp）。

- 風險與緩解
  - 長期不一致：透過佇列與重試解決；超時未成功發告警與人工處置。
  - 成本複雜度上升：以明確 SLA 與告警門檻控制投入。

- 驗收條件（AC）
  - 降級成功率：在 GCal 局部不可用時，最終一致性修復成功率 ≥ 95%。
  - 單一實例修改可正確執行與撤銷，且不影響系列其他實例。
  - 監控與審計可清楚追蹤任務生命週期與失敗原因。

- 迭代時機（何時啟動 P3）
  - P2 線上穩定至少 7–14 天，主要指標達標：
    - 整系列修改成功率 ≥ 90%，撤銷成功率 ≥ 95%。
    - 無重大一致性事故。
  - 明顯的可用性需求：
    - 真實使用場景中存在間歇性 GCal 不可用或 API quota 限制，導致用戶體感受影響。
  - 團隊準備：
    - SRE/運維具備 runbook，能處理「待同步佇列」告警。

- 推出方式
  - 以 Flag 控制降級與實例修改能力，先灰度在內部測試帳號與小比例真實用戶。
  - 完成回歸與壓力測試後逐步放量。

---

### 時程與資源（粗估）
- P2：
  - 整系列修改（不含單一實例）：1.5–2.5 人日
  - 撤銷/回復：0.5–1 人日
  - 自然語增強與澄清：0.5–1 人日
- P3：
  - 降級佇列 + Worker + 告警 + 管控：3–5 人日
  - 單一實例修改：2–4 人日
  - 監控與審計儀表：1–2 人日

（視現況與依賴服務調整）

---

### 風險總表
- 誤改範圍：以雙確認、明確文案、審計追蹤降低風險。
- 一致性：堅持「先 GCal 後 Firebase」；降級僅在 P3 且配套完整機制後開啟。
- 維運複雜度：以指標、告警、runbook 與管理工具支援。

---

### 迭代決策摘要
- 先穩 P1 → 見到系列修改的真實需求與穩定信號後，再進 P2。
- P2 穩定後，且存在明確的可用性瓶頸與一致性需求，再進 P3。
- 全程以 Feature Flag 漸進釋出，並以數據指標做關口控制。
