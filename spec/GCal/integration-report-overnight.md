## 一夜整合報告（白話版）

時間範圍：昨夜至今早（自動輪詢多輪）

### 現況總結
- 線上健康檢查：Google Calendar 已連通（authMode=oauth2，一直穩定）
- 測試通過率：
  - 本機約 25/28（約 89%）
  - 線上約 2/28（約 7%）
- 新增課程：部分輪次已成功拿到 GCal eventId（代表真的寫到日曆），但訊息/測試規則未完全同步，導致被判為失敗

### 為什麼線上只有 7%？（白話）
- 期待與實際不一致：
  - 測試文件的「預期結果」多寫成「查課表會回查詢成功（QUERY_OK）」，但系統實際做的是「新增課程成功（ADD_COURSE_OK）」。
  - 結果：系統其實成功了，但被舊的評分規則判成失敗。
- 意圖判斷有點「飄」：
  - 類似「我想了解一下課程安排」這種模糊語句，容易被判成「要新增」而非「要查詢」。
  - 結果：走錯流程 → 測試對不上。
- 新增流程雖成功一部分，但訊息/降級策略改了，測試還沒跟上：
  - 之前 GCal 會失敗時回「暫存成功（日曆稍後同步）」，現在部分輪次 GCal 已能直接成功並回 eventId，但測試沒有接受這個「新成功訊息」。

### 技術根因（翻成人話）
- 「新規則 vs 舊期待」：我們把 GCal 接通後，成功訊息與代碼改了；但測試文件還用舊寫法（多以查詢為主），造成「行為 OK、規則不 OK」。
- 「話術模糊」：模糊句子讓系統判錯流向（查 vs 新增），因此回答對不上測試的期待。
- 「日曆識別碼偶爾缺」：個別輪次可能拿不到 `calendarId` 或建立事件參數不完整，於是走了降級。雖然不崩潰，但測試期待與實際訊息依舊對不上。

### 昨夜已修補的重點
- Google Calendar 認證：
  - 已從 Service Account 切換至 OAuth（你設定的 Client ID/Secret/Refresh Token），線上顯示 oauth2。
  - 新增 `/health/gcal` 可即時檢查認證與狀態。
- 新增課程穩定性：
  - GCal 失敗時不會整體報錯，會先寫 Firebase，訊息改為「暫存成功」。
  - 加上 GCal 事件命名與私有屬性（summary 帶 LINE User ID；extendedProperties.private 存 userId/studentName/courseId）。
- 查詢恢復：
  - 修正 `getRecurringCoursesByStudent` 的匯出，避免查詢流程直接掛掉。

### 下一步（今天處理，目標把 7% 拉上來）
- 對齊測試期待：
  - 把「新增類」用例的預期代碼從 QUERY_OK 調整為 ADD_COURSE_OK，並接受目前成功款與降級款兩種文案。
- 穩定意圖分流：
  - 對「查課表」關鍵詞加權（如：課表/查/有什麼課/下週/今天）。
  - 對模糊句（如「想了解安排」）改成回「指引/請具體說明」而不是誤判成新增。
- GCal 實際建立更穩：
  - `ensureStudentCalendar` 改為「沒有就建、有就拿」，加入重試與完整日誌。
  - `createEvent` 發生錯誤時把原因（權限/時間格式/時區）記清楚，方便快速修。

### 你可以怎麼自行驗證
- 打健康檢查看是否仍是 oauth2：
  - `GET https://course-mvp-beta.onrender.com/health/gcal`
- 發一條新增課訊息（例如「小明明天下午2點要上數學課」）
  - 成功情形：回覆提到「✅ 課程已安排成功」，日誌會有 eventId
  - 若走降級：回覆提到「暫存成功」，稍後同步日曆
- 檢視夜間產物與最近日誌：
  - `test-results/overnight/daemon.out`、`test-results/overnight/overnight.log`
  - `test-results/render-logs/` 下的最新檔案

### 目前結論（一句話）
系統「新增」其實已部分成功打到 Google 日曆，但「測試期待仍用舊規則 + 意圖分流不穩」導致被評成失敗，拉低了線上通過率。


